<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.1" xml:lang="en-US">
  <compounddef id="game_8cpp" kind="file" language="C++">
    <compoundname>game.cpp</compoundname>
    <includes local="yes">game.h</includes>
    <incdepgraph>
      <node id="1">
        <label>game.cpp</label>
        <link refid="game_8cpp"/>
        <childnode refid="2" relation="include">
        </childnode>
      </node>
      <node id="2">
        <label>game.h</label>
      </node>
    </incdepgraph>
      <sectiondef kind="define">
      <memberdef kind="define" id="game_8cpp_1a7e5dac29ae1db0c9febfa7f119e8a38e" prot="public" static="no">
        <name>isKeyState</name>
        <param><defname>vk</defname></param>
        <initializer>(GetAsyncKeyState((vk)) &amp; 0x8000)</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="game.cpp" line="2" column="10" bodyfile="game.cpp" bodystart="2" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="game_8cpp_1a0c1edce48bfa4c7a8296b811c5b5820c" prot="public" static="no">
        <name>isKeyLeftRight</name>
        <param></param>
        <initializer>(<ref refid="game_8cpp_1a7e5dac29ae1db0c9febfa7f119e8a38e" kindref="member">isKeyState</ref>(VK_LEFT) || <ref refid="game_8cpp_1a7e5dac29ae1db0c9febfa7f119e8a38e" kindref="member">isKeyState</ref>(&apos;A&apos;) || <ref refid="game_8cpp_1a7e5dac29ae1db0c9febfa7f119e8a38e" kindref="member">isKeyState</ref>(VK_RIGHT) || <ref refid="game_8cpp_1a7e5dac29ae1db0c9febfa7f119e8a38e" kindref="member">isKeyState</ref>(&apos;D&apos;))</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="game.cpp" line="3" column="9" bodyfile="game.cpp" bodystart="3" bodyend="-1"/>
      </memberdef>
      </sectiondef>
      <sectiondef kind="var">
      <memberdef kind="variable" id="game_8cpp_1aa17a3208b22096ac52652c7e96880f1f" prot="public" static="yes" mutable="no">
        <type>BOOL</type>
        <definition>BOOL g_audio</definition>
        <argsstring></argsstring>
        <name>g_audio</name>
        <initializer>= TRUE</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="game.cpp" line="5" column="13" bodyfile="game.cpp" bodystart="5" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="game_8cpp_1a19b84425f38732e3eab4b8c3af26d53f" prot="public" static="yes" mutable="no">
        <type>BOOL</type>
        <definition>BOOL g_repeat</definition>
        <argsstring></argsstring>
        <name>g_repeat</name>
        <initializer>= TRUE</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="game.cpp" line="6" column="13" bodyfile="game.cpp" bodystart="6" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="game_8cpp_1af5319537ec3014d00698716f115369ff" prot="public" static="yes" mutable="no">
        <type>int</type>
        <definition>int g_velocity</definition>
        <argsstring></argsstring>
        <name>g_velocity</name>
        <initializer>= VELOCITY_DEF</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="game.cpp" line="7" column="13" bodyfile="game.cpp" bodystart="7" bodyend="-1"/>
      </memberdef>
      </sectiondef>
      <sectiondef kind="func">
      <memberdef kind="function" id="game_8cpp_1ac5f576fb59c9cf7de13af70c779b4335" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>LRESULT CALLBACK</type>
        <definition>static LRESULT CALLBACK options_proc</definition>
        <argsstring>(HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam)</argsstring>
        <name>options_proc</name>
        <param>
          <type><ref refid="main_8cpp_1a74aea08afaa7f26d272e9352ddafda3d" kindref="member">HWND</ref></type>
          <declname>hwnd</declname>
        </param>
        <param>
          <type><ref refid="main_8cpp_1afff0ab3629a68bc1bb3b2a2f4296173f" kindref="member">UINT</ref></type>
          <declname>msg</declname>
        </param>
        <param>
          <type>WPARAM</type>
          <declname>wParam</declname>
        </param>
        <param>
          <type>LPARAM</type>
          <declname>lParam</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="game.cpp" line="682" column="25" bodyfile="game.cpp" bodystart="682" bodyend="714" declfile="game.cpp" declline="4" declcolumn="25"/>
      </memberdef>
      </sectiondef>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="preprocessor">#include<sp/>&quot;game.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>isKeyState(vk)<sp/><sp/><sp/>(GetAsyncKeyState((vk))<sp/>&amp;<sp/>0x8000)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>isKeyLeftRight()<sp/>(isKeyState(VK_LEFT)<sp/>||<sp/>isKeyState(&apos;A&apos;)<sp/>||<sp/>isKeyState(VK_RIGHT)<sp/>||<sp/>isKeyState(&apos;D&apos;))</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>LRESULT<sp/>CALLBACK<sp/>options_proc(<ref refid="main_8cpp_1a74aea08afaa7f26d272e9352ddafda3d" kindref="member">HWND</ref><sp/>hwnd,<sp/><ref refid="main_8cpp_1afff0ab3629a68bc1bb3b2a2f4296173f" kindref="member">UINT</ref><sp/>msg,<sp/>WPARAM<sp/>wParam,<sp/>LPARAM<sp/>lParam);</highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>BOOL<sp/>g_audio<sp/><sp/><sp/><sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="6"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>BOOL<sp/>g_repeat<sp/><sp/><sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><sp/>g_velocity<sp/>=<sp/>VELOCITY_DEF;</highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight></codeline>
<codeline lineno="11"><highlight class="normal">tetris::tetris(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal">):bback(NULL),<sp/></highlight></codeline>
<codeline lineno="12"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dcbmp(NULL),<sp/></highlight></codeline>
<codeline lineno="13"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bfill(NULL),<sp/></highlight></codeline>
<codeline lineno="14"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks(NULL),<sp/></highlight></codeline>
<codeline lineno="15"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother(NULL),<sp/></highlight></codeline>
<codeline lineno="16"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bnextf(NULL),<sp/></highlight></codeline>
<codeline lineno="17"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>balpha(NULL),<sp/></highlight></codeline>
<codeline lineno="18"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>field_left(0),<sp/></highlight></codeline>
<codeline lineno="19"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>field_right(0),<sp/></highlight></codeline>
<codeline lineno="20"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_x(0),<sp/></highlight></codeline>
<codeline lineno="21"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_y(0),<sp/></highlight></codeline>
<codeline lineno="22"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>velocity(0),<sp/></highlight></codeline>
<codeline lineno="23"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x(0),<sp/></highlight></codeline>
<codeline lineno="24"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sel_cmd(0),<sp/></highlight></codeline>
<codeline lineno="25"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>offset_m(0),<sp/></highlight></codeline>
<codeline lineno="26"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prev_index(-1),<sp/></highlight></codeline>
<codeline lineno="27"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>delay(DELAY_TIME),<sp/></highlight></codeline>
<codeline lineno="28"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prev_time(0),<sp/></highlight></codeline>
<codeline lineno="29"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>time_boom(0),<sp/></highlight></codeline>
<codeline lineno="30"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>score(0),<sp/></highlight></codeline>
<codeline lineno="31"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start(false),<sp/></highlight></codeline>
<codeline lineno="32"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state(GAME_MENU)<sp/>{}</highlight></codeline>
<codeline lineno="33"><highlight class="normal"></highlight></codeline>
<codeline lineno="34"><highlight class="normal">tetris::~tetris(){}</highlight></codeline>
<codeline lineno="35"><highlight class="normal"></highlight></codeline>
<codeline lineno="36"><highlight class="normal"></highlight></codeline>
<codeline lineno="37"><highlight class="normal"></highlight><highlight class="comment">//создание</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="38"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ARGS2_FASTCALL<sp/>tetris::onCreate(HINSTANCE<sp/>hinst,<sp/><ref refid="main_8cpp_1a74aea08afaa7f26d272e9352ddafda3d" kindref="member">HWND</ref><sp/>hwnd){</highlight></codeline>
<codeline lineno="39"><highlight class="normal"><sp/><sp/><sp/><sp/>srand(</highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(time(NULL)));</highlight></codeline>
<codeline lineno="40"><highlight class="normal"></highlight></codeline>
<codeline lineno="41"><highlight class="normal"><sp/><sp/><sp/><sp/>RECT<sp/>rc;</highlight></codeline>
<codeline lineno="42"><highlight class="normal"><sp/><sp/><sp/><sp/>GetClientRect(hwnd,<sp/>&amp;rc);</highlight></codeline>
<codeline lineno="43"><highlight class="normal"><sp/><sp/><sp/><sp/>size.cx<sp/>=<sp/>rc.right;</highlight></codeline>
<codeline lineno="44"><highlight class="normal"><sp/><sp/><sp/><sp/>size.cy<sp/>=<sp/>rc.bottom;</highlight></codeline>
<codeline lineno="45"><highlight class="normal"></highlight></codeline>
<codeline lineno="46"><highlight class="normal"><sp/><sp/><sp/><sp/>field_left<sp/><sp/>=<sp/>40;</highlight></codeline>
<codeline lineno="47"><highlight class="normal"><sp/><sp/><sp/><sp/>field_right<sp/>=<sp/>field_left<sp/>+<sp/>FIELD_COLS<sp/>*<sp/>CELL_SIZE;</highlight></codeline>
<codeline lineno="48"><highlight class="normal"></highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>fcx<sp/>=<sp/>FIELD_COLS<sp/>*<sp/>CELL_SIZE;</highlight></codeline>
<codeline lineno="50"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>fcy<sp/>=<sp/>FIELD_ROWS<sp/>*<sp/>CELL_SIZE;</highlight></codeline>
<codeline lineno="51"><highlight class="normal"><sp/><sp/><sp/><sp/>dcbmp<sp/><sp/><sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>bitmap(fcx,<sp/>fcy);</highlight></codeline>
<codeline lineno="52"><highlight class="normal"><sp/><sp/><sp/><sp/>bfill<sp/><sp/><sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>bitmap(fcx,<sp/>fcy);</highlight></codeline>
<codeline lineno="53"><highlight class="normal"></highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/><sp/><sp/>brush<sp/>br(hinst,<sp/>IDB_BITMAP_GROUND);</highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/><sp/><sp/>bback<sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>bitmap(size.cx<sp/>-<sp/>field_right,<sp/>fcy);</highlight></codeline>
<codeline lineno="56"><highlight class="normal"><sp/><sp/><sp/><sp/>br.fill(bback-&gt;getDC(),<sp/>0,<sp/>0,<sp/>bback-&gt;getWidth(),<sp/>bback-&gt;getHeight());</highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/><sp/><sp/>br.destroy();</highlight></codeline>
<codeline lineno="58"><highlight class="normal"></highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/><sp/><sp/>blocks<sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>bitmap(hinst,<sp/>IDB_BITMAP_BLOCKS);</highlight></codeline>
<codeline lineno="60"><highlight class="normal"></highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/><sp/><sp/>br.load(hinst,<sp/>IDB_BITMAP_FILL);</highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/><sp/><sp/>POINT<sp/>pt;</highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/><sp/><sp/>SetBrushOrgEx(bfill-&gt;getDC(),<sp/>8,<sp/>0,<sp/>&amp;pt);</highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/><sp/><sp/>br.fill(bfill-&gt;getDC(),<sp/>0,<sp/>0,<sp/>fcx,<sp/>fcy);</highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/><sp/><sp/>SetBrushOrgEx(bfill-&gt;getDC(),<sp/>pt.x,<sp/>pt.y,<sp/>NULL);</highlight></codeline>
<codeline lineno="66"><highlight class="normal"><sp/><sp/><sp/><sp/>br.destroy();</highlight></codeline>
<codeline lineno="67"><highlight class="normal"></highlight></codeline>
<codeline lineno="68"><highlight class="normal"><sp/><sp/><sp/><sp/>rect.left<sp/><sp/><sp/>=<sp/>field_left;</highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/><sp/><sp/>rect.top<sp/><sp/><sp/><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="70"><highlight class="normal"><sp/><sp/><sp/><sp/>rect.right<sp/><sp/>=<sp/>rect.left<sp/>+<sp/>fcx;</highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/><sp/><sp/>rect.bottom<sp/>=<sp/>fcy;</highlight></codeline>
<codeline lineno="72"><highlight class="normal"></highlight></codeline>
<codeline lineno="73"><highlight class="normal"><sp/><sp/><sp/><sp/>figure_x<sp/><sp/>=<sp/>figure_y<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/><sp/><sp/>delay<sp/><sp/><sp/><sp/><sp/>=<sp/>DELAY_TIME;</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/><sp/><sp/>prev_time<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/><sp/><sp/>sel_cmd<sp/><sp/><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/><sp/><sp/>state<sp/><sp/><sp/><sp/><sp/>=<sp/>GAME_MENU;</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/>offset_m<sp/><sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())<sp/>/<sp/>2;</highlight></codeline>
<codeline lineno="79"><highlight class="normal"></highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/><sp/><sp/>bother<sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>bitmap(hinst,<sp/>IDB_BITMAP_NEXTF);</highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/><sp/>bnextf<sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>bitmap(NEXTF_WIDTH,<sp/>NEXTF_HEIGHT);</highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/><sp/><sp/>balpha<sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>bitmap(hinst,<sp/>IDB_BITMAP_ALPHA);</highlight></codeline>
<codeline lineno="83"><highlight class="normal"></highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/>mask_alpha.create(balpha);</highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/><sp/><sp/>fnt.create(balpha,<sp/>&amp;mask_alpha,<sp/>32);</highlight></codeline>
<codeline lineno="86"><highlight class="normal"></highlight></codeline>
<codeline lineno="87"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="util_8cpp_1a7af5ccd4a679701a1ab60b6e3c05c419" kindref="member">figures_load</ref>(figures,<sp/>hinst,<sp/>MAKEINTRESOURCEW(IDR_TEXT_FIGURES),<sp/>L</highlight><highlight class="stringliteral">&quot;TEXT&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="88"><highlight class="normal"></highlight></codeline>
<codeline lineno="89"><highlight class="normal"><sp/><sp/><sp/><sp/>snd_rot.load(hinst,<sp/><sp/>MAKEINTRESOURCEW(IDR_WAVE_ROTATE),<sp/>L</highlight><highlight class="stringliteral">&quot;WAVE&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/><sp/><sp/>snd_stop.load(hinst,<sp/>MAKEINTRESOURCEW(IDR_WAVE_STOP),<sp/><sp/><sp/>L</highlight><highlight class="stringliteral">&quot;WAVE&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/><sp/><sp/>snd_boom.load(hinst,<sp/>MAKEINTRESOURCEW(IDR_WAVE_BOOM),<sp/><sp/><sp/>L</highlight><highlight class="stringliteral">&quot;WAVE&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="92"><highlight class="normal"></highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/><sp/><sp/>bpane.load(hinst,<sp/>IDB_BITMAP_PANE);</highlight></codeline>
<codeline lineno="94"><highlight class="normal"></highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_MENU);</highlight></codeline>
<codeline lineno="96"><highlight class="normal"></highlight></codeline>
<codeline lineno="97"><highlight class="normal"><sp/><sp/><sp/><sp/>SetTimer(hwnd,<sp/>IDT_TIMER,<sp/>DELAY_TIME,<sp/>NULL);</highlight></codeline>
<codeline lineno="98"><highlight class="normal">}</highlight></codeline>
<codeline lineno="99"><highlight class="normal"></highlight></codeline>
<codeline lineno="100"><highlight class="normal"></highlight></codeline>
<codeline lineno="101"><highlight class="normal"></highlight><highlight class="comment">//событие клавиатуры(нажатие)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="102"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ARGS2_FASTCALL<sp/>tetris::onKeyDown(<ref refid="main_8cpp_1a74aea08afaa7f26d272e9352ddafda3d" kindref="member">HWND</ref><sp/>hwnd,<sp/><ref refid="main_8cpp_1a89b917a7bdb582e19cbde98e817fa0b3" kindref="member">WORD</ref><sp/>key){</highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><sp/>ret;</highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>ok;</highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal">(state){</highlight></codeline>
<codeline lineno="106"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>GAME_PLAY:</highlight></codeline>
<codeline lineno="107"><highlight class="normal"></highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal">(key){</highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>VK_LEFT:<sp/></highlight><highlight class="comment">//движение<sp/>влево <sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>&apos;A&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(is_move_horz(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field,<sp/>velocity,<sp/>true)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--figure_x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_figure(hwnd);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>VK_RIGHT:<sp/>//движение<sp/>вправо
<sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>&apos;D&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(is_move_horz(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field,<sp/>velocity,<sp/>false)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++figure_x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_figure(hwnd);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>VK_DOWN:<sp/>//движение<sp/>вниз
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>&apos;S&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(is_move_down(figure_x,<sp/>figure_y,<sp/>figure,<sp/>VELOCITY_DOWN,<sp/>field)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_y<sp/>+=<sp/>VELOCITY_DOWN;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_figure(hwnd);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{<sp/>//здесь сделать блоки частью<sp/>стены

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(is_game_over()){<sp/>//вы<sp/>проиграли
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_OVER);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_put_field(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ok<sp/>=<sp/>field_remove(field,<sp/>false,<sp/>&amp;booms);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>score_add(booms.getSize());
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>put_rand_figure(hwnd);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(ok){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>time_boom<sp/>=<sp/>timeGetTime()<sp/>+<sp/>TIME_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/><sp/><sp/><sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_boom.play(&amp;g_audio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_stop.play(&amp;g_audio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>VK_UP:<sp/>//вращение
<sp/><sp/><sp/><sp/><sp/>case<sp/>&apos;W&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(figure_rotate(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_rot.play(&amp;g_audio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_figure(hwnd);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>VK_ESCAPE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_PAUSE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Sleep(100);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_MENU:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>exec_menu(hwnd,<sp/>control_menu(hwnd,<sp/>key,<sp/>3));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_OVER:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>control_menu(hwnd,<sp/>key,<sp/>2);
<sp/><sp/><sp/><sp/><sp/><sp/>if(ret<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);
<sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if(ret<sp/>==<sp/>1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_MENU);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_PAUSE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>control_menu(hwnd,<sp/>key,<sp/>2);
<sp/><sp/><sp/><sp/><sp/><sp/>if(ret<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_PLAY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if(ret<sp/>==<sp/>1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_MENU);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
}


//движение<sp/>мыши
void<sp/>tetris::onMouseMove(HWND<sp/>hwnd,<sp/>int<sp/>x,<sp/>int<sp/>y){
<sp/>int<sp/>ret;
<sp/><sp/><sp/>switch(state){
<sp/>case<sp/>GAME_OVER:
<sp/><sp/><sp/><sp/>case<sp/>GAME_PAUSE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>move_button(x,<sp/>y,<sp/>2);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if((ret<sp/>!=<sp/>-1)<sp/>&amp;&amp;<sp/>(ret<sp/>!=<sp/>sel_cmd)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sel_cmd<sp/>=<sp/>ret;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_MENU:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>move_button(x,<sp/>y,<sp/>3);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if((ret<sp/>!=<sp/>-1)<sp/>&amp;&amp;<sp/>(ret<sp/>!=<sp/>sel_cmd)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sel_cmd<sp/>=<sp/>ret;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
}
<sp/><sp/><sp/><sp/>

//нажатие кнопки<sp/>мыши
void<sp/>tetris::onMouseDown(HWND<sp/>hwnd,<sp/>int<sp/>x,<sp/>int<sp/>y){
<sp/><sp/>int<sp/>ret;
<sp/><sp/><sp/>switch(state){
<sp/>case<sp/>GAME_PAUSE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>move_button(x,<sp/>y,<sp/>2);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(ret<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_PLAY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if(ret<sp/>==<sp/>1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_MENU);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_OVER:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>move_button(x,<sp/>y,<sp/>2);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(ret<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);
<sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if(ret<sp/>==<sp/>1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_MENU);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_MENU:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>exec_menu(hwnd,<sp/>move_button(x,<sp/>y,<sp/>3));
<sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
}


//таймер
void<sp/>ARGS2_FASTCALL<sp/>tetris::onTimer(HWND<sp/>hwnd,<sp/>UINT<sp/>id){
<sp/><sp/><sp/>DWORD<sp/>tick;
<sp/><sp/><sp/><sp/>switch(state){
<sp/>case<sp/>GAME_PLAY:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tick<sp/>=<sp/>timeGetTime();
<sp/><sp/><sp/><sp/><sp/><sp/>if((tick<sp/>-<sp/>prev_time)<sp/>&gt;<sp/>delay){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prev_time<sp/>=<sp/>tick;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_frame(hwnd,<sp/>tick);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rect,<sp/>TRUE);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
}


//рисование
void<sp/>ARGS2_FASTCALL<sp/>tetris::onPaint(HWND<sp/>hwnd,<sp/>HDC<sp/>hDC){
<sp/><sp/>switch(state){
<sp/>case<sp/>GAME_PLAY:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_game(hDC);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_MENU:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_menu(hDC);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_PAUSE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_pause(hDC);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_OVER:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_over(hDC);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
}


//уничтожение окна
void<sp/>ARGS2_FASTCALL<sp/>tetris::onDestroy(HWND<sp/>hwnd){
<sp/>KillTimer(hwnd,<sp/>IDT_TIMER);
<sp/><sp/><sp/><sp/>figures.clear();
<sp/><sp/><sp/>delete<sp/>bback;
<sp/><sp/>delete<sp/>dcbmp;
<sp/><sp/>delete<sp/>bfill;
<sp/><sp/>delete<sp/>blocks;
<sp/>delete<sp/>bother;
<sp/>delete<sp/>bnextf;
<sp/>delete<sp/>balpha;
<sp/>bpane.destroy();
<sp/><sp/><sp/>mask_alpha.destroy();
<sp/><sp/>snd_rot.destroy();
<sp/>snd_stop.destroy();
<sp/><sp/><sp/><sp/>snd_boom.destroy();
}


//-----------------------------------------------------------------------------------------------------


//старт игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::start_game(HWND<sp/>hwnd){
<sp/><sp/><sp/>booms.reset();
<sp/>memset(field,<sp/>0,<sp/>sizeof(field));

<sp/><sp/>velocity<sp/><sp/><sp/>=<sp/>g_velocity;
<sp/><sp/><sp/>start<sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>false;
<sp/><sp/><sp/><sp/>time_boom<sp/><sp/>=<sp/>score<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/>boom_x<sp/><sp/><sp/><sp/><sp/>=<sp/>0;
<sp/><sp/><sp/><sp/>prev_index<sp/>=<sp/>-1;
<sp/><sp/><sp/>put_rand_figure(hwnd);
<sp/>set_state(hwnd,<sp/>GAME_PLAY);
}


//задание случайной фигуры
void<sp/>ARGS2_FASTCALL<sp/>tetris::put_rand_figure(HWND<sp/>hwnd){
<sp/>int<sp/>index,<sp/>icur;
<sp/><sp/><sp/>if(!start){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prev_index<sp/>=<sp/>index<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;figure,<sp/>&amp;figures[index],<sp/>sizeof(figure_t));

<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(!g_repeat){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>do<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>while(icur<sp/>==<sp/>index);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;next_figure,<sp/>&amp;figures[icur],<sp/>sizeof(figure_t));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_set(figure,<sp/>RAND_BLOCKS);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_set(next_figure,<sp/>RAND_BLOCKS);
<sp/><sp/><sp/><sp/><sp/><sp/>start<sp/>=<sp/>true;
<sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;figure,<sp/>&amp;next_figure,<sp/>sizeof(figure_t));

<sp/><sp/><sp/><sp/><sp/><sp/>if(!g_repeat){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>do<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>while(icur<sp/>==<sp/>prev_index);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;next_figure,<sp/>&amp;figures[icur],<sp/>sizeof(figure_t));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_set(next_figure,<sp/>RAND_BLOCKS);
<sp/><sp/><sp/><sp/><sp/><sp/>prev_index<sp/>=<sp/>icur;
<sp/>}

<sp/>if((rand()<sp/>%<sp/>2)<sp/>!=<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/>figure_transponse(next_figure);

<sp/><sp/><sp/>figure_y<sp/>=<sp/>-figure.size<sp/>*<sp/>CELL_SIZE;
<sp/><sp/><sp/>figure_x<sp/>=<sp/>rand()<sp/>%<sp/>(FIELD_COLS<sp/>-<sp/>figure.size);

<sp/><sp/><sp/>bother-&gt;draw(bnextf-&gt;getDC(),<sp/>0,<sp/>0,<sp/>NEXTF_WIDTH,<sp/>NEXTF_HEIGHT,<sp/>0,<sp/>0);

<sp/>const<sp/>int<sp/>edge<sp/><sp/>=<sp/>31;
<sp/><sp/>const<sp/>int<sp/>csize<sp/>=<sp/>18;

<sp/>RECT<sp/>rc;
<sp/><sp/><sp/>figure_size(next_figure,<sp/>&amp;rc,<sp/>csize);

<sp/>const<sp/>int<sp/>left<sp/>=<sp/>(NEXTF_WIDTH<sp/>-<sp/>(rc.right<sp/>-<sp/>rc.left))<sp/>/<sp/>2<sp/>-<sp/>rc.left;
<sp/><sp/><sp/>const<sp/>int<sp/>top<sp/><sp/>=<sp/>(edge<sp/>+<sp/>(91<sp/>-<sp/>(rc.bottom<sp/>-<sp/>rc.top))<sp/>/<sp/>2)<sp/>-<sp/>rc.top;

<sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>next_figure.size;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/>for(int<sp/>j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>next_figure.size;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(next_figure.figure[i][j]<sp/>!=<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(bnextf-&gt;getDC(),<sp/>left<sp/>+<sp/>j*csize,<sp/>top<sp/>+<sp/>i*csize,<sp/>csize,<sp/>csize,<sp/>0,<sp/>182,<sp/>SRCCOPY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>WCHAR<sp/><sp/><sp/><sp/>s[16];
<sp/><sp/><sp/><sp/>int<sp/><sp/><sp/><sp/><sp/><sp/>n<sp/>=<sp/>swprintf(s,<sp/>L&quot;%lu&quot;,<sp/>score);
<sp/><sp/><sp/>COLORREF<sp/>c<sp/>=<sp/>SetTextColor(bnextf-&gt;getDC(),<sp/>RGB(0xFF,<sp/>0xFF,<sp/>0xFF));
<sp/>int<sp/><sp/><sp/>mode<sp/>=<sp/>SetBkMode(bnextf-&gt;getDC(),<sp/>TRANSPARENT);

<sp/>POINT<sp/>pos<sp/>=<sp/>{0,<sp/>bnextf-&gt;getHeight()<sp/>};
<sp/>SIZE<sp/><sp/>fsz<sp/>=<sp/>{0};
<sp/><sp/><sp/>if(GetTextExtentPoint32W(bnextf-&gt;getDC(),<sp/>s,<sp/>n,<sp/>&amp;fsz)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pos.x<sp/><sp/>=<sp/>(bnextf-&gt;getWidth()<sp/>-<sp/>fsz.cx)<sp/>/<sp/>2;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pos.y<sp/>-=<sp/>fsz.cy<sp/>+<sp/>fsz.cy/2<sp/>-<sp/>1;
<sp/><sp/><sp/><sp/>}
<sp/><sp/>TextOutW(bnextf-&gt;getDC(),<sp/>pos.x,<sp/>pos.y,<sp/>s,<sp/>n);

<sp/><sp/><sp/><sp/>SetBkMode(bnextf-&gt;getDC(),<sp/>mode);
<sp/><sp/>SetTextColor(bnextf-&gt;getDC(),<sp/>c);

<sp/>rc.left<sp/><sp/><sp/>=<sp/>field_right;
<sp/><sp/><sp/>rc.top<sp/><sp/><sp/><sp/>=<sp/>0;
<sp/>rc.right<sp/><sp/>=<sp/>rc.left<sp/>+<sp/>NEXTF_WIDTH;
<sp/>rc.bottom<sp/>=<sp/>rc.top<sp/><sp/>+<sp/>NEXTF_HEIGHT;
<sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


//обновление<sp/>кадра
void<sp/>ARGS2_FASTCALL<sp/>tetris::update_frame(HWND<sp/>hwnd,<sp/>DWORD<sp/>tick){
<sp/><sp/><sp/>if((time_boom<sp/>!=<sp/>0)<sp/>&amp;&amp;<sp/>(tick<sp/>&gt;<sp/>time_boom)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>field_remove(field,<sp/>true);
<sp/><sp/><sp/><sp/><sp/>time_boom<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/>booms.reset();
<sp/>}

<sp/>if(is_move_down(figure_x,<sp/>figure_y,<sp/>figure,<sp/>velocity,<sp/>field))
<sp/><sp/><sp/><sp/><sp/><sp/>figure_y<sp/>+=<sp/>velocity;
<sp/><sp/>else<sp/>if(!<sp/>isKeyLeftRight()){<sp/>//здесь сделать блоки частью<sp/>стены

<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(is_game_over()){<sp/>//вы<sp/>проиграли
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_OVER);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>figure_put_field(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field);

<sp/><sp/><sp/><sp/><sp/><sp/>bool<sp/>ok<sp/>=<sp/>field_remove(field,<sp/>false,<sp/>&amp;booms);
<sp/><sp/><sp/><sp/><sp/><sp/>score_add(booms.getSize());
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>put_rand_figure(hwnd);
<sp/><sp/><sp/><sp/><sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(ok){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>time_boom<sp/>=<sp/>tick<sp/>+<sp/>TIME_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/><sp/><sp/><sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_boom.play(&amp;g_audio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_stop.play(&amp;g_audio);
<sp/><sp/><sp/>}
}


//вывод игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_game(HDC<sp/>hDC){
<sp/><sp/>int<sp/>i,<sp/>j,<sp/>box;
<sp/>bback-&gt;draw(hDC,<sp/>0,<sp/>0,<sp/>field_left,<sp/>dcbmp-&gt;getHeight());
<sp/><sp/><sp/><sp/>bback-&gt;draw(hDC,<sp/>field_right,<sp/>bnextf-&gt;getHeight(),<sp/>bback-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>bnextf-&gt;getHeight()<sp/>-<sp/>CTRL_HEIGHT);
<sp/><sp/><sp/><sp/>dcbmp-&gt;draw(bfill);

<sp/><sp/><sp/>//здесь выводим
<sp/><sp/><sp/>HDC<sp/>hdc<sp/>=<sp/>dcbmp-&gt;getDC();

<sp/>//вывод фигуры
<sp/><sp/><sp/>int<sp/>px<sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE;
<sp/>int<sp/>py<sp/>=<sp/>figure_y;
<sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>figure.size;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>for(j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>figure.size;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(figure.figure[i][j]<sp/>!=<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>px<sp/>+<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>py<sp/>+<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>figure.figure[i][j]<sp/>-<sp/>1,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>//вывод блоков
<sp/><sp/><sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>FIELD_ROWS;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>for(j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>FIELD_COLS;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if((box<sp/>=<sp/>field[i][j])<sp/>==<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>continue;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(box<sp/>&lt;=<sp/>BLOCK_C)<sp/>//неподвижные блоки
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>1,<sp/>CELL_SIZE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else//блоки которые для<sp/>взрыва
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>BLOCK_BOOM<sp/>-<sp/>1,<sp/>CELL_OFFSET_BOOM);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>//вывод &quot;взрыва&quot;
<sp/>boom_row*<sp/>p;
<sp/><sp/><sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>booms.getSize();<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>p<sp/>=<sp/>&amp;booms[i];
<sp/><sp/><sp/><sp/><sp/>if(p-&gt;dir<sp/>==<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>+=<sp/>VELOCITY_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(boom_x<sp/>&gt;=<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>20)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>-=<sp/>VELOCITY_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(boom_x<sp/>&lt;<sp/>20){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>20;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hdc,<sp/>boom_x,<sp/>p-&gt;pos,<sp/>20,<sp/>20,<sp/>0,<sp/>200,<sp/>SRCPAINT);
<sp/><sp/><sp/>}

<sp/>BitBlt(hDC,<sp/>field_left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>hdc,<sp/>0,<sp/>0,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/>bnextf-&gt;draw(hDC,<sp/>field_right,<sp/>0,<sp/>NEXTF_WIDTH,<sp/>NEXTF_HEIGHT,<sp/>0,<sp/>0);
<sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>field_right,<sp/>size.cy<sp/>-<sp/>CTRL_HEIGHT,<sp/>NEXTF_WIDTH,<sp/>CTRL_HEIGHT,<sp/>0,<sp/>220);
}


//вывод проигрыша
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_over(HDC<sp/>hDC){
<sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>game[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>77,<sp/>15,<sp/>16,<sp/>14,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>11,<sp/>8,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>19};
<sp/><sp/><sp/><sp/>const<sp/>int<sp/><sp/><sp/><sp/><sp/>fsz<sp/>=<sp/>24;
<sp/><sp/><sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>game,<sp/>sizeof(game),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(game)))/2,<sp/>100,<sp/>fsz,<sp/>28,<sp/>SRCPAINT);

<sp/><sp/>const<sp/>BYTE<sp/>ply[]<sp/><sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>7,<sp/>0,<sp/>13,<sp/>14,<sp/>2,<sp/>14};
<sp/>const<sp/>BYTE<sp/>title[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>2,<sp/>77,<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>11,<sp/>14};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>ply,<sp/>sizeof(ply),<sp/>title,<sp/>sizeof(title));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод паузы
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_pause(HDC<sp/>hDC){
<sp/><sp/><sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>ps[]<sp/>=<sp/>{<sp/>15,<sp/>0,<sp/>19,<sp/>7,<sp/>0};
<sp/><sp/>const<sp/>int<sp/><sp/><sp/>fsz<sp/>=<sp/>32;
<sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ps,<sp/>sizeof(ps),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(ps)))/2,<sp/>100,<sp/>fsz,<sp/>34,<sp/>SRCPAINT);

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>cns[]<sp/>=<sp/>{<sp/>15,<sp/>16,<sp/>14,<sp/>4,<sp/>14,<sp/>11,<sp/>6,<sp/>8,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>exs[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>21,<sp/>14,<sp/>4,<sp/>77,<sp/>2,<sp/>77,<sp/>12,<sp/>5,<sp/>13,<sp/>30};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>cns,<sp/>sizeof(cns),<sp/>exs,<sp/>sizeof(exs));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод меню<sp/>игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_menu(HDC<sp/>hDC){
<sp/>draw_background(hDC);

<sp/>//вывести надпись тетрис
<sp/><sp/>const<sp/>CHAR<sp/>tetris[]<sp/>=<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;###<sp/>###<sp/>###<sp/>###<sp/>#<sp/><sp/><sp/>#<sp/>###\n&quot;\
<sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/>#<sp/>#<sp/><sp/>##<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>###<sp/>#<sp/>#<sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>##<sp/><sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>#<sp/><sp/><sp/>#<sp/>###&quot;
<sp/><sp/><sp/><sp/>};

<sp/><sp/><sp/><sp/>const<sp/>int<sp/>csize<sp/>=<sp/>18;
<sp/><sp/>int<sp/><sp/><sp/><sp/>x<sp/>=<sp/>0,<sp/>y<sp/>=<sp/>0,<sp/>px<sp/>=<sp/>csize<sp/>-<sp/>4,<sp/>py<sp/>=<sp/>csize<sp/>*<sp/>3;
<sp/><sp/><sp/>LPCSTR<sp/>p<sp/>=<sp/>&amp;tetris[0];
<sp/>while(*p){
<sp/><sp/><sp/><sp/><sp/>if(*p<sp/>==<sp/>&apos;#&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(dcbmp-&gt;getDC(),<sp/>px<sp/>+<sp/>x*csize,<sp/>py<sp/>+<sp/>y*csize,<sp/>csize,<sp/>csize,<sp/>0,<sp/>182,<sp/>SRCCOPY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if(*p<sp/>==<sp/>&apos;\n&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++y;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>++p;
<sp/><sp/><sp/>}

<sp/>const<sp/>BYTE<sp/>start[]<sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/>const<sp/>BYTE<sp/>opts[]<sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>17,<sp/>18,<sp/>16,<sp/>14,<sp/>9,<sp/>10,<sp/>0};
<sp/><sp/><sp/>const<sp/>BYTE<sp/>quit[]<sp/><sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>8,<sp/>7,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>27};
<sp/><sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>6,<sp/>start,<sp/>sizeof(start),<sp/>opts,<sp/>sizeof(opts),<sp/>quit,<sp/>sizeof(quit));

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>ctrl[]<sp/>=<sp/>{<sp/>19,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>11,<sp/>5,<sp/>13,<sp/>8,<sp/>5,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>14,<sp/>9};
<sp/>const<sp/>int<sp/>cx<sp/>=<sp/>14;
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ctrl,<sp/>sizeof(ctrl),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(ctrl)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>47,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>BYTE<sp/>help[]<sp/>=<sp/>{<sp/>10,<sp/>11,<sp/>0,<sp/>2,<sp/>8,<sp/>24,<sp/>0,<sp/>77,<sp/>2,<sp/>2,<sp/>5,<sp/>16,<sp/>21,<sp/>77,<sp/>2,<sp/>13,<sp/>8,<sp/>7,<sp/>77,<sp/>2,<sp/>11,<sp/>5,<sp/>2,<sp/>14,<sp/>77,<sp/>2,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>14};
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>help,<sp/>sizeof(help),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(help)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>27,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//----------------------------------------------------------------------------------------------------------------------


void<sp/>tetris::draw_background(HDC<sp/>hDC){
<sp/><sp/>PatBlt(dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>BLACKNESS);
<sp/><sp/><sp/><sp/>bpane.fill(hDC,<sp/>0,<sp/>0,<sp/>PANE_WIDTH,<sp/>dcbmp-&gt;getHeight());
<sp/>bpane.fill(hDC,<sp/>PANE_WIDTH<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>0,<sp/>dcbmp-&gt;getWidth()<sp/>+<sp/>(PANE_WIDTH<sp/>&lt;&lt;<sp/>1)<sp/>+<sp/>1,<sp/>bback-&gt;getHeight());
}


void<sp/>tetris::exec_menu(HWND<sp/>hwnd,<sp/>int<sp/>cmd){
<sp/>if(cmd<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);
<sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>1)<sp/>//диалог<sp/>опции(options)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DialogBoxW((HINSTANCE)GetModuleHandle(NULL),<sp/>MAKEINTRESOURCEW(IDD_OPTIONS),<sp/>hwnd,<sp/>reinterpret_cast&lt;DLGPROC&gt;(&amp;options_proc));
<sp/><sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>2)<sp/>//выход
<sp/><sp/><sp/><sp/><sp/>SendMessage(hwnd,<sp/>WM_CLOSE,<sp/>0,<sp/>0);
}


//перерисовка фигуры
void<sp/>ARGS2_FASTCALL<sp/>tetris::update_figure(HWND<sp/>hwnd){
<sp/><sp/><sp/>const<sp/>int<sp/>m<sp/>=<sp/>CELL_SIZE<sp/>&lt;&lt;<sp/>1;
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>rc.left<sp/><sp/><sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.top<sp/><sp/><sp/><sp/>=<sp/>figure_y<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.right<sp/><sp/>=<sp/>min(rc.left<sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>(m<sp/>&lt;&lt;<sp/>1),<sp/>field_right);<sp/>
<sp/><sp/><sp/><sp/>rc.bottom<sp/>=<sp/>rc.top<sp/><sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>m;
<sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


//добавление<sp/>очков
void<sp/>tetris::score_add(int<sp/>n){
<sp/>if(n<sp/>&gt;<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/>score<sp/>+=<sp/>(n<sp/>==<sp/>1)<sp/>?<sp/>10UL<sp/>:<sp/>static_cast&lt;DWORD&gt;(n)*15UL;
}


//проверка<sp/>на<sp/>проигрыш
bool<sp/>tetris::is_game_over(void){
<sp/><sp/>int<sp/>j<sp/>=<sp/>0;
<sp/>while((j<sp/>&lt;<sp/>FIELD_COLS)<sp/>&amp;&amp;<sp/>(field[0][j]<sp/>==<sp/>BLOCK_NONE))
<sp/><sp/><sp/><sp/><sp/>++j;
<sp/><sp/><sp/>return<sp/>(j<sp/>&lt;<sp/>FIELD_COLS);
}


//вывод кнопок
void<sp/>tetris::draw_buttons(HDC<sp/>hDC,<sp/>int<sp/>num,...){
<sp/>const<sp/>BYTE*<sp/>pb;
<sp/><sp/><sp/><sp/>UINT<sp/><sp/><sp/><sp/>nb;
<sp/><sp/><sp/><sp/>int<sp/><sp/><sp/><sp/><sp/>x,<sp/>p<sp/>=<sp/>0;
<sp/><sp/>RECT<sp/><sp/><sp/><sp/>rc;
<sp/><sp/><sp/><sp/>va_list<sp/>lst;
<sp/><sp/><sp/>va_start(lst,<sp/>num);
<sp/><sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>i<sp/>+=<sp/>2,<sp/>++p){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>p*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>pb<sp/>=<sp/>va_arg(lst,<sp/>const<sp/>BYTE*);
<sp/><sp/><sp/><sp/><sp/>nb<sp/>=<sp/>va_arg(lst,<sp/>UINT);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/><sp/>=<sp/>(p<sp/>==<sp/>sel_cmd)<sp/>?<sp/>89<sp/>:<sp/>21;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>rc.left,<sp/>rc.top,<sp/>rc.right<sp/>-<sp/>rc.left,<sp/>rc.bottom<sp/>-<sp/>rc.top,<sp/>x,<sp/>184,<sp/>69,<sp/>33,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/><sp/><sp/>fnt.draw(hDC,<sp/>pb,<sp/>nb,<sp/>rc.left<sp/>+<sp/>((rc.right<sp/>-<sp/>rc.left)<sp/>-<sp/>static_cast&lt;int&gt;(nb)*fnt.getWidth())/2,<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rc.top<sp/>+<sp/>((rc.bottom<sp/>-<sp/>rc.top)<sp/>-<sp/>fnt.getHeight())/2);
<sp/>}
<sp/><sp/>va_end(lst);
}


void<sp/>ARGS2_FASTCALL<sp/>tetris::set_rect(LPRECT<sp/>prc,<sp/>int<sp/>top){
<sp/><sp/><sp/><sp/>SetRect(prc,<sp/>20,<sp/>250<sp/>+<sp/>top,<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20,<sp/>300<sp/>+<sp/>top);
}


int<sp/>tetris::control_menu(HWND<sp/>hwnd,<sp/>WORD<sp/>key,<sp/>int<sp/>num){
<sp/><sp/><sp/><sp/>switch(key){
<sp/><sp/><sp/>case<sp/>VK_UP:
<sp/><sp/><sp/><sp/>case<sp/>&apos;W&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&gt;<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_DOWN:
<sp/><sp/>case<sp/>&apos;S&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&lt;<sp/>(num<sp/>-<sp/>1)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_RETURN:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>sel_cmd;
<sp/><sp/><sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


void<sp/>tetris::update_menu(HWND<sp/>hwnd){
<sp/><sp/><sp/><sp/>RECT<sp/>rc<sp/>=<sp/>{<sp/>offset_m,<sp/>240,<sp/>offset_m<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>2<sp/>};
<sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


void<sp/>tetris::set_state(HWND<sp/>hwnd,<sp/>e_state_game<sp/>st){
<sp/><sp/><sp/>sel_cmd<sp/>=<sp/>0;
<sp/><sp/><sp/>state<sp/><sp/><sp/>=<sp/>st;
<sp/><sp/>InvalidateRect(hwnd,<sp/>NULL,<sp/>TRUE);
}


int<sp/>tetris::move_button(int<sp/>x,<sp/>int<sp/>y,<sp/>int<sp/>num){
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>i*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>OffsetRect(&amp;rc,<sp/>offset_m,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/>if((x<sp/>&gt;<sp/>rc.left<sp/>&amp;&amp;<sp/>x<sp/>&lt;<sp/>rc.right)<sp/>&amp;&amp;<sp/>(y<sp/>&gt;<sp/>rc.top<sp/>&amp;&amp;<sp/>y<sp/>&lt;<sp/>rc.bottom))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>i;
<sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


//обработчик<sp/>диалога
static<sp/>LRESULT<sp/>CALLBACK<sp/>options_proc(HWND<sp/>hwnd,<sp/>UINT<sp/>msg,<sp/>WPARAM<sp/>wParam,<sp/>LPARAM<sp/>lParam){
<sp/><sp/><sp/><sp/>const<sp/>WCHAR<sp/>vel1[]<sp/>=<sp/>{<sp/>0x41F,0x435,0x440,0x432,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel2[]<sp/>=<sp/>{<sp/>0x412,0x442,0x43E,0x440,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel3[]<sp/>=<sp/>{<sp/>0x422,0x440,0x435,0x442,0x44C,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};

<sp/>switch(msg){
<sp/><sp/><sp/>case<sp/>WM_INITDIALOG:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel1);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel2);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel3);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_SETCURSEL,<sp/>(WPARAM)(g_velocity<sp/>-<sp/>1),<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_SETCHECK,<sp/>(g_audio)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_SETCHECK,<sp/>(!g_repeat)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/>return<sp/>1;
<sp/><sp/>case<sp/>WM_COMMAND:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch(LOWORD(wParam)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_OK:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_velocity<sp/>=<sp/>(int)SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_GETCURSEL,<sp/>0,<sp/>0)<sp/>+<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_audio<sp/><sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/><sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>TRUE<sp/><sp/>:<sp/>FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_repeat<sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>FALSE<sp/>:<sp/>TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_CANCEL:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>WM_CLOSE:
<sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
<sp/><sp/>return<sp/>0;
}
</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/></highlight><highlight class="charliteral">&apos;A&apos;</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<ref refid="util_8cpp_1a4a2547e434658a0407f6de208fae9cf4" kindref="member">is_move_horz</ref>(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field,<sp/>velocity,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">)){</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--figure_x;</highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_figure(hwnd);</highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>VK_RIGHT:<sp/></highlight><highlight class="comment">//движение<sp/>вправо</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/></highlight><highlight class="charliteral">&apos;D&apos;</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<ref refid="util_8cpp_1a4a2547e434658a0407f6de208fae9cf4" kindref="member">is_move_horz</ref>(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field,<sp/>velocity,<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">)){</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++figure_x;</highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_figure(hwnd);</highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>VK_DOWN:<sp/></highlight><highlight class="comment">//движение<sp/>вниз</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/></highlight><highlight class="charliteral">&apos;S&apos;</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<ref refid="util_8cpp_1ae2af2e4dfced0dbcaf04978c90b2fc1c" kindref="member">is_move_down</ref>(figure_x,<sp/>figure_y,<sp/>figure,<sp/>VELOCITY_DOWN,<sp/>field)){</highlight></codeline>
<codeline lineno="126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_y<sp/>+=<sp/>VELOCITY_DOWN;</highlight></codeline>
<codeline lineno="127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_figure(hwnd);</highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{<sp/></highlight><highlight class="comment">//здесь сделать блоки частью<sp/>стены 
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(is_game_over()){<sp/>//вы<sp/>проиграли
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_OVER);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_put_field(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ok<sp/>=<sp/>field_remove(field,<sp/>false,<sp/>&amp;booms);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>score_add(booms.getSize());
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>put_rand_figure(hwnd);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(ok){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>time_boom<sp/>=<sp/>timeGetTime()<sp/>+<sp/>TIME_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/><sp/><sp/><sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_boom.play(&amp;g_audio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_stop.play(&amp;g_audio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>VK_UP:<sp/>//вращение
<sp/><sp/><sp/><sp/><sp/>case<sp/>&apos;W&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(figure_rotate(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_rot.play(&amp;g_audio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_figure(hwnd);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>VK_ESCAPE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_PAUSE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Sleep(100);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_MENU:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>exec_menu(hwnd,<sp/>control_menu(hwnd,<sp/>key,<sp/>3));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_OVER:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>control_menu(hwnd,<sp/>key,<sp/>2);
<sp/><sp/><sp/><sp/><sp/><sp/>if(ret<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);
<sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if(ret<sp/>==<sp/>1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_MENU);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_PAUSE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>control_menu(hwnd,<sp/>key,<sp/>2);
<sp/><sp/><sp/><sp/><sp/><sp/>if(ret<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_PLAY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if(ret<sp/>==<sp/>1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_MENU);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
}


//движение<sp/>мыши
void<sp/>tetris::onMouseMove(HWND<sp/>hwnd,<sp/>int<sp/>x,<sp/>int<sp/>y){
<sp/>int<sp/>ret;
<sp/><sp/><sp/>switch(state){
<sp/>case<sp/>GAME_OVER:
<sp/><sp/><sp/><sp/>case<sp/>GAME_PAUSE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>move_button(x,<sp/>y,<sp/>2);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if((ret<sp/>!=<sp/>-1)<sp/>&amp;&amp;<sp/>(ret<sp/>!=<sp/>sel_cmd)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sel_cmd<sp/>=<sp/>ret;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_MENU:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>move_button(x,<sp/>y,<sp/>3);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if((ret<sp/>!=<sp/>-1)<sp/>&amp;&amp;<sp/>(ret<sp/>!=<sp/>sel_cmd)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sel_cmd<sp/>=<sp/>ret;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
}
<sp/><sp/><sp/><sp/>

//нажатие кнопки<sp/>мыши
void<sp/>tetris::onMouseDown(HWND<sp/>hwnd,<sp/>int<sp/>x,<sp/>int<sp/>y){
<sp/><sp/>int<sp/>ret;
<sp/><sp/><sp/>switch(state){
<sp/>case<sp/>GAME_PAUSE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>move_button(x,<sp/>y,<sp/>2);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(ret<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_PLAY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if(ret<sp/>==<sp/>1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_MENU);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_OVER:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>move_button(x,<sp/>y,<sp/>2);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(ret<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);
<sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if(ret<sp/>==<sp/>1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_MENU);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_MENU:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>exec_menu(hwnd,<sp/>move_button(x,<sp/>y,<sp/>3));
<sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
}


//таймер
void<sp/>ARGS2_FASTCALL<sp/>tetris::onTimer(HWND<sp/>hwnd,<sp/>UINT<sp/>id){
<sp/><sp/><sp/>DWORD<sp/>tick;
<sp/><sp/><sp/><sp/>switch(state){
<sp/>case<sp/>GAME_PLAY:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tick<sp/>=<sp/>timeGetTime();
<sp/><sp/><sp/><sp/><sp/><sp/>if((tick<sp/>-<sp/>prev_time)<sp/>&gt;<sp/>delay){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prev_time<sp/>=<sp/>tick;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_frame(hwnd,<sp/>tick);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rect,<sp/>TRUE);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
}


//рисование
void<sp/>ARGS2_FASTCALL<sp/>tetris::onPaint(HWND<sp/>hwnd,<sp/>HDC<sp/>hDC){
<sp/><sp/>switch(state){
<sp/>case<sp/>GAME_PLAY:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_game(hDC);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_MENU:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_menu(hDC);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_PAUSE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_pause(hDC);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_OVER:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_over(hDC);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
}


//уничтожение окна
void<sp/>ARGS2_FASTCALL<sp/>tetris::onDestroy(HWND<sp/>hwnd){
<sp/>KillTimer(hwnd,<sp/>IDT_TIMER);
<sp/><sp/><sp/><sp/>figures.clear();
<sp/><sp/><sp/>delete<sp/>bback;
<sp/><sp/>delete<sp/>dcbmp;
<sp/><sp/>delete<sp/>bfill;
<sp/><sp/>delete<sp/>blocks;
<sp/>delete<sp/>bother;
<sp/>delete<sp/>bnextf;
<sp/>delete<sp/>balpha;
<sp/>bpane.destroy();
<sp/><sp/><sp/>mask_alpha.destroy();
<sp/><sp/>snd_rot.destroy();
<sp/>snd_stop.destroy();
<sp/><sp/><sp/><sp/>snd_boom.destroy();
}


//-----------------------------------------------------------------------------------------------------


//старт игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::start_game(HWND<sp/>hwnd){
<sp/><sp/><sp/>booms.reset();
<sp/>memset(field,<sp/>0,<sp/>sizeof(field));

<sp/><sp/>velocity<sp/><sp/><sp/>=<sp/>g_velocity;
<sp/><sp/><sp/>start<sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>false;
<sp/><sp/><sp/><sp/>time_boom<sp/><sp/>=<sp/>score<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/>boom_x<sp/><sp/><sp/><sp/><sp/>=<sp/>0;
<sp/><sp/><sp/><sp/>prev_index<sp/>=<sp/>-1;
<sp/><sp/><sp/>put_rand_figure(hwnd);
<sp/>set_state(hwnd,<sp/>GAME_PLAY);
}


//задание случайной фигуры
void<sp/>ARGS2_FASTCALL<sp/>tetris::put_rand_figure(HWND<sp/>hwnd){
<sp/>int<sp/>index,<sp/>icur;
<sp/><sp/><sp/>if(!start){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prev_index<sp/>=<sp/>index<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;figure,<sp/>&amp;figures[index],<sp/>sizeof(figure_t));

<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(!g_repeat){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>do<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>while(icur<sp/>==<sp/>index);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;next_figure,<sp/>&amp;figures[icur],<sp/>sizeof(figure_t));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_set(figure,<sp/>RAND_BLOCKS);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_set(next_figure,<sp/>RAND_BLOCKS);
<sp/><sp/><sp/><sp/><sp/><sp/>start<sp/>=<sp/>true;
<sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;figure,<sp/>&amp;next_figure,<sp/>sizeof(figure_t));

<sp/><sp/><sp/><sp/><sp/><sp/>if(!g_repeat){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>do<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>while(icur<sp/>==<sp/>prev_index);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;next_figure,<sp/>&amp;figures[icur],<sp/>sizeof(figure_t));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_set(next_figure,<sp/>RAND_BLOCKS);
<sp/><sp/><sp/><sp/><sp/><sp/>prev_index<sp/>=<sp/>icur;
<sp/>}

<sp/>if((rand()<sp/>%<sp/>2)<sp/>!=<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/>figure_transponse(next_figure);

<sp/><sp/><sp/>figure_y<sp/>=<sp/>-figure.size<sp/>*<sp/>CELL_SIZE;
<sp/><sp/><sp/>figure_x<sp/>=<sp/>rand()<sp/>%<sp/>(FIELD_COLS<sp/>-<sp/>figure.size);

<sp/><sp/><sp/>bother-&gt;draw(bnextf-&gt;getDC(),<sp/>0,<sp/>0,<sp/>NEXTF_WIDTH,<sp/>NEXTF_HEIGHT,<sp/>0,<sp/>0);

<sp/>const<sp/>int<sp/>edge<sp/><sp/>=<sp/>31;
<sp/><sp/>const<sp/>int<sp/>csize<sp/>=<sp/>18;

<sp/>RECT<sp/>rc;
<sp/><sp/><sp/>figure_size(next_figure,<sp/>&amp;rc,<sp/>csize);

<sp/>const<sp/>int<sp/>left<sp/>=<sp/>(NEXTF_WIDTH<sp/>-<sp/>(rc.right<sp/>-<sp/>rc.left))<sp/>/<sp/>2<sp/>-<sp/>rc.left;
<sp/><sp/><sp/>const<sp/>int<sp/>top<sp/><sp/>=<sp/>(edge<sp/>+<sp/>(91<sp/>-<sp/>(rc.bottom<sp/>-<sp/>rc.top))<sp/>/<sp/>2)<sp/>-<sp/>rc.top;

<sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>next_figure.size;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/>for(int<sp/>j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>next_figure.size;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(next_figure.figure[i][j]<sp/>!=<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(bnextf-&gt;getDC(),<sp/>left<sp/>+<sp/>j*csize,<sp/>top<sp/>+<sp/>i*csize,<sp/>csize,<sp/>csize,<sp/>0,<sp/>182,<sp/>SRCCOPY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>WCHAR<sp/><sp/><sp/><sp/>s[16];
<sp/><sp/><sp/><sp/>int<sp/><sp/><sp/><sp/><sp/><sp/>n<sp/>=<sp/>swprintf(s,<sp/>L&quot;%lu&quot;,<sp/>score);
<sp/><sp/><sp/>COLORREF<sp/>c<sp/>=<sp/>SetTextColor(bnextf-&gt;getDC(),<sp/>RGB(0xFF,<sp/>0xFF,<sp/>0xFF));
<sp/>int<sp/><sp/><sp/>mode<sp/>=<sp/>SetBkMode(bnextf-&gt;getDC(),<sp/>TRANSPARENT);

<sp/>POINT<sp/>pos<sp/>=<sp/>{0,<sp/>bnextf-&gt;getHeight()<sp/>};
<sp/>SIZE<sp/><sp/>fsz<sp/>=<sp/>{0};
<sp/><sp/><sp/>if(GetTextExtentPoint32W(bnextf-&gt;getDC(),<sp/>s,<sp/>n,<sp/>&amp;fsz)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pos.x<sp/><sp/>=<sp/>(bnextf-&gt;getWidth()<sp/>-<sp/>fsz.cx)<sp/>/<sp/>2;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pos.y<sp/>-=<sp/>fsz.cy<sp/>+<sp/>fsz.cy/2<sp/>-<sp/>1;
<sp/><sp/><sp/><sp/>}
<sp/><sp/>TextOutW(bnextf-&gt;getDC(),<sp/>pos.x,<sp/>pos.y,<sp/>s,<sp/>n);

<sp/><sp/><sp/><sp/>SetBkMode(bnextf-&gt;getDC(),<sp/>mode);
<sp/><sp/>SetTextColor(bnextf-&gt;getDC(),<sp/>c);

<sp/>rc.left<sp/><sp/><sp/>=<sp/>field_right;
<sp/><sp/><sp/>rc.top<sp/><sp/><sp/><sp/>=<sp/>0;
<sp/>rc.right<sp/><sp/>=<sp/>rc.left<sp/>+<sp/>NEXTF_WIDTH;
<sp/>rc.bottom<sp/>=<sp/>rc.top<sp/><sp/>+<sp/>NEXTF_HEIGHT;
<sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


//обновление<sp/>кадра
void<sp/>ARGS2_FASTCALL<sp/>tetris::update_frame(HWND<sp/>hwnd,<sp/>DWORD<sp/>tick){
<sp/><sp/><sp/>if((time_boom<sp/>!=<sp/>0)<sp/>&amp;&amp;<sp/>(tick<sp/>&gt;<sp/>time_boom)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>field_remove(field,<sp/>true);
<sp/><sp/><sp/><sp/><sp/>time_boom<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/>booms.reset();
<sp/>}

<sp/>if(is_move_down(figure_x,<sp/>figure_y,<sp/>figure,<sp/>velocity,<sp/>field))
<sp/><sp/><sp/><sp/><sp/><sp/>figure_y<sp/>+=<sp/>velocity;
<sp/><sp/>else<sp/>if(!<sp/>isKeyLeftRight()){<sp/>//здесь сделать блоки частью<sp/>стены

<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(is_game_over()){<sp/>//вы<sp/>проиграли
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_OVER);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>figure_put_field(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field);

<sp/><sp/><sp/><sp/><sp/><sp/>bool<sp/>ok<sp/>=<sp/>field_remove(field,<sp/>false,<sp/>&amp;booms);
<sp/><sp/><sp/><sp/><sp/><sp/>score_add(booms.getSize());
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>put_rand_figure(hwnd);
<sp/><sp/><sp/><sp/><sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(ok){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>time_boom<sp/>=<sp/>tick<sp/>+<sp/>TIME_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/><sp/><sp/><sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_boom.play(&amp;g_audio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_stop.play(&amp;g_audio);
<sp/><sp/><sp/>}
}


//вывод игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_game(HDC<sp/>hDC){
<sp/><sp/>int<sp/>i,<sp/>j,<sp/>box;
<sp/>bback-&gt;draw(hDC,<sp/>0,<sp/>0,<sp/>field_left,<sp/>dcbmp-&gt;getHeight());
<sp/><sp/><sp/><sp/>bback-&gt;draw(hDC,<sp/>field_right,<sp/>bnextf-&gt;getHeight(),<sp/>bback-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>bnextf-&gt;getHeight()<sp/>-<sp/>CTRL_HEIGHT);
<sp/><sp/><sp/><sp/>dcbmp-&gt;draw(bfill);

<sp/><sp/><sp/>//здесь выводим
<sp/><sp/><sp/>HDC<sp/>hdc<sp/>=<sp/>dcbmp-&gt;getDC();

<sp/>//вывод фигуры
<sp/><sp/><sp/>int<sp/>px<sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE;
<sp/>int<sp/>py<sp/>=<sp/>figure_y;
<sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>figure.size;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>for(j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>figure.size;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(figure.figure[i][j]<sp/>!=<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>px<sp/>+<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>py<sp/>+<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>figure.figure[i][j]<sp/>-<sp/>1,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>//вывод блоков
<sp/><sp/><sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>FIELD_ROWS;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>for(j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>FIELD_COLS;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if((box<sp/>=<sp/>field[i][j])<sp/>==<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>continue;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(box<sp/>&lt;=<sp/>BLOCK_C)<sp/>//неподвижные блоки
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>1,<sp/>CELL_SIZE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else//блоки которые для<sp/>взрыва
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>BLOCK_BOOM<sp/>-<sp/>1,<sp/>CELL_OFFSET_BOOM);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>//вывод &quot;взрыва&quot;
<sp/>boom_row*<sp/>p;
<sp/><sp/><sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>booms.getSize();<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>p<sp/>=<sp/>&amp;booms[i];
<sp/><sp/><sp/><sp/><sp/>if(p-&gt;dir<sp/>==<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>+=<sp/>VELOCITY_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(boom_x<sp/>&gt;=<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>20)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>-=<sp/>VELOCITY_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(boom_x<sp/>&lt;<sp/>20){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>20;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hdc,<sp/>boom_x,<sp/>p-&gt;pos,<sp/>20,<sp/>20,<sp/>0,<sp/>200,<sp/>SRCPAINT);
<sp/><sp/><sp/>}

<sp/>BitBlt(hDC,<sp/>field_left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>hdc,<sp/>0,<sp/>0,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/>bnextf-&gt;draw(hDC,<sp/>field_right,<sp/>0,<sp/>NEXTF_WIDTH,<sp/>NEXTF_HEIGHT,<sp/>0,<sp/>0);
<sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>field_right,<sp/>size.cy<sp/>-<sp/>CTRL_HEIGHT,<sp/>NEXTF_WIDTH,<sp/>CTRL_HEIGHT,<sp/>0,<sp/>220);
}


//вывод проигрыша
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_over(HDC<sp/>hDC){
<sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>game[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>77,<sp/>15,<sp/>16,<sp/>14,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>11,<sp/>8,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>19};
<sp/><sp/><sp/><sp/>const<sp/>int<sp/><sp/><sp/><sp/><sp/>fsz<sp/>=<sp/>24;
<sp/><sp/><sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>game,<sp/>sizeof(game),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(game)))/2,<sp/>100,<sp/>fsz,<sp/>28,<sp/>SRCPAINT);

<sp/><sp/>const<sp/>BYTE<sp/>ply[]<sp/><sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>7,<sp/>0,<sp/>13,<sp/>14,<sp/>2,<sp/>14};
<sp/>const<sp/>BYTE<sp/>title[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>2,<sp/>77,<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>11,<sp/>14};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>ply,<sp/>sizeof(ply),<sp/>title,<sp/>sizeof(title));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод паузы
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_pause(HDC<sp/>hDC){
<sp/><sp/><sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>ps[]<sp/>=<sp/>{<sp/>15,<sp/>0,<sp/>19,<sp/>7,<sp/>0};
<sp/><sp/>const<sp/>int<sp/><sp/><sp/>fsz<sp/>=<sp/>32;
<sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ps,<sp/>sizeof(ps),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(ps)))/2,<sp/>100,<sp/>fsz,<sp/>34,<sp/>SRCPAINT);

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>cns[]<sp/>=<sp/>{<sp/>15,<sp/>16,<sp/>14,<sp/>4,<sp/>14,<sp/>11,<sp/>6,<sp/>8,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>exs[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>21,<sp/>14,<sp/>4,<sp/>77,<sp/>2,<sp/>77,<sp/>12,<sp/>5,<sp/>13,<sp/>30};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>cns,<sp/>sizeof(cns),<sp/>exs,<sp/>sizeof(exs));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод меню<sp/>игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_menu(HDC<sp/>hDC){
<sp/>draw_background(hDC);

<sp/>//вывести надпись тетрис
<sp/><sp/>const<sp/>CHAR<sp/>tetris[]<sp/>=<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;###<sp/>###<sp/>###<sp/>###<sp/>#<sp/><sp/><sp/>#<sp/>###\n&quot;\
<sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/>#<sp/>#<sp/><sp/>##<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>###<sp/>#<sp/>#<sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>##<sp/><sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>#<sp/><sp/><sp/>#<sp/>###&quot;
<sp/><sp/><sp/><sp/>};

<sp/><sp/><sp/><sp/>const<sp/>int<sp/>csize<sp/>=<sp/>18;
<sp/><sp/>int<sp/><sp/><sp/><sp/>x<sp/>=<sp/>0,<sp/>y<sp/>=<sp/>0,<sp/>px<sp/>=<sp/>csize<sp/>-<sp/>4,<sp/>py<sp/>=<sp/>csize<sp/>*<sp/>3;
<sp/><sp/><sp/>LPCSTR<sp/>p<sp/>=<sp/>&amp;tetris[0];
<sp/>while(*p){
<sp/><sp/><sp/><sp/><sp/>if(*p<sp/>==<sp/>&apos;#&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(dcbmp-&gt;getDC(),<sp/>px<sp/>+<sp/>x*csize,<sp/>py<sp/>+<sp/>y*csize,<sp/>csize,<sp/>csize,<sp/>0,<sp/>182,<sp/>SRCCOPY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if(*p<sp/>==<sp/>&apos;\n&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++y;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>++p;
<sp/><sp/><sp/>}

<sp/>const<sp/>BYTE<sp/>start[]<sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/>const<sp/>BYTE<sp/>opts[]<sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>17,<sp/>18,<sp/>16,<sp/>14,<sp/>9,<sp/>10,<sp/>0};
<sp/><sp/><sp/>const<sp/>BYTE<sp/>quit[]<sp/><sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>8,<sp/>7,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>27};
<sp/><sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>6,<sp/>start,<sp/>sizeof(start),<sp/>opts,<sp/>sizeof(opts),<sp/>quit,<sp/>sizeof(quit));

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>ctrl[]<sp/>=<sp/>{<sp/>19,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>11,<sp/>5,<sp/>13,<sp/>8,<sp/>5,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>14,<sp/>9};
<sp/>const<sp/>int<sp/>cx<sp/>=<sp/>14;
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ctrl,<sp/>sizeof(ctrl),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(ctrl)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>47,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>BYTE<sp/>help[]<sp/>=<sp/>{<sp/>10,<sp/>11,<sp/>0,<sp/>2,<sp/>8,<sp/>24,<sp/>0,<sp/>77,<sp/>2,<sp/>2,<sp/>5,<sp/>16,<sp/>21,<sp/>77,<sp/>2,<sp/>13,<sp/>8,<sp/>7,<sp/>77,<sp/>2,<sp/>11,<sp/>5,<sp/>2,<sp/>14,<sp/>77,<sp/>2,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>14};
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>help,<sp/>sizeof(help),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(help)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>27,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//----------------------------------------------------------------------------------------------------------------------


void<sp/>tetris::draw_background(HDC<sp/>hDC){
<sp/><sp/>PatBlt(dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>BLACKNESS);
<sp/><sp/><sp/><sp/>bpane.fill(hDC,<sp/>0,<sp/>0,<sp/>PANE_WIDTH,<sp/>dcbmp-&gt;getHeight());
<sp/>bpane.fill(hDC,<sp/>PANE_WIDTH<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>0,<sp/>dcbmp-&gt;getWidth()<sp/>+<sp/>(PANE_WIDTH<sp/>&lt;&lt;<sp/>1)<sp/>+<sp/>1,<sp/>bback-&gt;getHeight());
}


void<sp/>tetris::exec_menu(HWND<sp/>hwnd,<sp/>int<sp/>cmd){
<sp/>if(cmd<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);
<sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>1)<sp/>//диалог<sp/>опции(options)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DialogBoxW((HINSTANCE)GetModuleHandle(NULL),<sp/>MAKEINTRESOURCEW(IDD_OPTIONS),<sp/>hwnd,<sp/>reinterpret_cast&lt;DLGPROC&gt;(&amp;options_proc));
<sp/><sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>2)<sp/>//выход
<sp/><sp/><sp/><sp/><sp/>SendMessage(hwnd,<sp/>WM_CLOSE,<sp/>0,<sp/>0);
}


//перерисовка фигуры
void<sp/>ARGS2_FASTCALL<sp/>tetris::update_figure(HWND<sp/>hwnd){
<sp/><sp/><sp/>const<sp/>int<sp/>m<sp/>=<sp/>CELL_SIZE<sp/>&lt;&lt;<sp/>1;
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>rc.left<sp/><sp/><sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.top<sp/><sp/><sp/><sp/>=<sp/>figure_y<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.right<sp/><sp/>=<sp/>min(rc.left<sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>(m<sp/>&lt;&lt;<sp/>1),<sp/>field_right);<sp/>
<sp/><sp/><sp/><sp/>rc.bottom<sp/>=<sp/>rc.top<sp/><sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>m;
<sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


//добавление<sp/>очков
void<sp/>tetris::score_add(int<sp/>n){
<sp/>if(n<sp/>&gt;<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/>score<sp/>+=<sp/>(n<sp/>==<sp/>1)<sp/>?<sp/>10UL<sp/>:<sp/>static_cast&lt;DWORD&gt;(n)*15UL;
}


//проверка<sp/>на<sp/>проигрыш
bool<sp/>tetris::is_game_over(void){
<sp/><sp/>int<sp/>j<sp/>=<sp/>0;
<sp/>while((j<sp/>&lt;<sp/>FIELD_COLS)<sp/>&amp;&amp;<sp/>(field[0][j]<sp/>==<sp/>BLOCK_NONE))
<sp/><sp/><sp/><sp/><sp/>++j;
<sp/><sp/><sp/>return<sp/>(j<sp/>&lt;<sp/>FIELD_COLS);
}


//вывод кнопок
void<sp/>tetris::draw_buttons(HDC<sp/>hDC,<sp/>int<sp/>num,...){
<sp/>const<sp/>BYTE*<sp/>pb;
<sp/><sp/><sp/><sp/>UINT<sp/><sp/><sp/><sp/>nb;
<sp/><sp/><sp/><sp/>int<sp/><sp/><sp/><sp/><sp/>x,<sp/>p<sp/>=<sp/>0;
<sp/><sp/>RECT<sp/><sp/><sp/><sp/>rc;
<sp/><sp/><sp/><sp/>va_list<sp/>lst;
<sp/><sp/><sp/>va_start(lst,<sp/>num);
<sp/><sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>i<sp/>+=<sp/>2,<sp/>++p){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>p*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>pb<sp/>=<sp/>va_arg(lst,<sp/>const<sp/>BYTE*);
<sp/><sp/><sp/><sp/><sp/>nb<sp/>=<sp/>va_arg(lst,<sp/>UINT);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/><sp/>=<sp/>(p<sp/>==<sp/>sel_cmd)<sp/>?<sp/>89<sp/>:<sp/>21;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>rc.left,<sp/>rc.top,<sp/>rc.right<sp/>-<sp/>rc.left,<sp/>rc.bottom<sp/>-<sp/>rc.top,<sp/>x,<sp/>184,<sp/>69,<sp/>33,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/><sp/><sp/>fnt.draw(hDC,<sp/>pb,<sp/>nb,<sp/>rc.left<sp/>+<sp/>((rc.right<sp/>-<sp/>rc.left)<sp/>-<sp/>static_cast&lt;int&gt;(nb)*fnt.getWidth())/2,<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rc.top<sp/>+<sp/>((rc.bottom<sp/>-<sp/>rc.top)<sp/>-<sp/>fnt.getHeight())/2);
<sp/>}
<sp/><sp/>va_end(lst);
}


void<sp/>ARGS2_FASTCALL<sp/>tetris::set_rect(LPRECT<sp/>prc,<sp/>int<sp/>top){
<sp/><sp/><sp/><sp/>SetRect(prc,<sp/>20,<sp/>250<sp/>+<sp/>top,<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20,<sp/>300<sp/>+<sp/>top);
}


int<sp/>tetris::control_menu(HWND<sp/>hwnd,<sp/>WORD<sp/>key,<sp/>int<sp/>num){
<sp/><sp/><sp/><sp/>switch(key){
<sp/><sp/><sp/>case<sp/>VK_UP:
<sp/><sp/><sp/><sp/>case<sp/>&apos;W&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&gt;<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_DOWN:
<sp/><sp/>case<sp/>&apos;S&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&lt;<sp/>(num<sp/>-<sp/>1)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_RETURN:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>sel_cmd;
<sp/><sp/><sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


void<sp/>tetris::update_menu(HWND<sp/>hwnd){
<sp/><sp/><sp/><sp/>RECT<sp/>rc<sp/>=<sp/>{<sp/>offset_m,<sp/>240,<sp/>offset_m<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>2<sp/>};
<sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


void<sp/>tetris::set_state(HWND<sp/>hwnd,<sp/>e_state_game<sp/>st){
<sp/><sp/><sp/>sel_cmd<sp/>=<sp/>0;
<sp/><sp/><sp/>state<sp/><sp/><sp/>=<sp/>st;
<sp/><sp/>InvalidateRect(hwnd,<sp/>NULL,<sp/>TRUE);
}


int<sp/>tetris::move_button(int<sp/>x,<sp/>int<sp/>y,<sp/>int<sp/>num){
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>i*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>OffsetRect(&amp;rc,<sp/>offset_m,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/>if((x<sp/>&gt;<sp/>rc.left<sp/>&amp;&amp;<sp/>x<sp/>&lt;<sp/>rc.right)<sp/>&amp;&amp;<sp/>(y<sp/>&gt;<sp/>rc.top<sp/>&amp;&amp;<sp/>y<sp/>&lt;<sp/>rc.bottom))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>i;
<sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


//обработчик<sp/>диалога
static<sp/>LRESULT<sp/>CALLBACK<sp/>options_proc(HWND<sp/>hwnd,<sp/>UINT<sp/>msg,<sp/>WPARAM<sp/>wParam,<sp/>LPARAM<sp/>lParam){
<sp/><sp/><sp/><sp/>const<sp/>WCHAR<sp/>vel1[]<sp/>=<sp/>{<sp/>0x41F,0x435,0x440,0x432,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel2[]<sp/>=<sp/>{<sp/>0x412,0x442,0x43E,0x440,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel3[]<sp/>=<sp/>{<sp/>0x422,0x440,0x435,0x442,0x44C,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};

<sp/>switch(msg){
<sp/><sp/><sp/>case<sp/>WM_INITDIALOG:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel1);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel2);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel3);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_SETCURSEL,<sp/>(WPARAM)(g_velocity<sp/>-<sp/>1),<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_SETCHECK,<sp/>(g_audio)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_SETCHECK,<sp/>(!g_repeat)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/>return<sp/>1;
<sp/><sp/>case<sp/>WM_COMMAND:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch(LOWORD(wParam)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_OK:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_velocity<sp/>=<sp/>(int)SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_GETCURSEL,<sp/>0,<sp/>0)<sp/>+<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_audio<sp/><sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/><sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>TRUE<sp/><sp/>:<sp/>FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_repeat<sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>FALSE<sp/>:<sp/>TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_CANCEL:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>WM_CLOSE:
<sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
<sp/><sp/>return<sp/>0;
}
</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="129"><highlight class="normal"></highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(is_game_over()){<sp/></highlight><highlight class="comment">//вы<sp/>проиграли <sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_OVER);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_put_field(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ok<sp/>=<sp/>field_remove(field,<sp/>false,<sp/>&amp;booms);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>score_add(booms.getSize());
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>put_rand_figure(hwnd);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(ok){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>time_boom<sp/>=<sp/>timeGetTime()<sp/>+<sp/>TIME_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/><sp/><sp/><sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_boom.play(&amp;g_audio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_stop.play(&amp;g_audio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>VK_UP:<sp/>//вращение
<sp/><sp/><sp/><sp/><sp/>case<sp/>&apos;W&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(figure_rotate(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_rot.play(&amp;g_audio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_figure(hwnd);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>VK_ESCAPE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_PAUSE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Sleep(100);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_MENU:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>exec_menu(hwnd,<sp/>control_menu(hwnd,<sp/>key,<sp/>3));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_OVER:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>control_menu(hwnd,<sp/>key,<sp/>2);
<sp/><sp/><sp/><sp/><sp/><sp/>if(ret<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);
<sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if(ret<sp/>==<sp/>1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_MENU);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_PAUSE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>control_menu(hwnd,<sp/>key,<sp/>2);
<sp/><sp/><sp/><sp/><sp/><sp/>if(ret<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_PLAY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if(ret<sp/>==<sp/>1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_MENU);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
}


//движение<sp/>мыши
void<sp/>tetris::onMouseMove(HWND<sp/>hwnd,<sp/>int<sp/>x,<sp/>int<sp/>y){
<sp/>int<sp/>ret;
<sp/><sp/><sp/>switch(state){
<sp/>case<sp/>GAME_OVER:
<sp/><sp/><sp/><sp/>case<sp/>GAME_PAUSE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>move_button(x,<sp/>y,<sp/>2);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if((ret<sp/>!=<sp/>-1)<sp/>&amp;&amp;<sp/>(ret<sp/>!=<sp/>sel_cmd)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sel_cmd<sp/>=<sp/>ret;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_MENU:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>move_button(x,<sp/>y,<sp/>3);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if((ret<sp/>!=<sp/>-1)<sp/>&amp;&amp;<sp/>(ret<sp/>!=<sp/>sel_cmd)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sel_cmd<sp/>=<sp/>ret;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
}
<sp/><sp/><sp/><sp/>

//нажатие кнопки<sp/>мыши
void<sp/>tetris::onMouseDown(HWND<sp/>hwnd,<sp/>int<sp/>x,<sp/>int<sp/>y){
<sp/><sp/>int<sp/>ret;
<sp/><sp/><sp/>switch(state){
<sp/>case<sp/>GAME_PAUSE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>move_button(x,<sp/>y,<sp/>2);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(ret<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_PLAY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if(ret<sp/>==<sp/>1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_MENU);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_OVER:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>move_button(x,<sp/>y,<sp/>2);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(ret<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);
<sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if(ret<sp/>==<sp/>1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_MENU);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_MENU:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>exec_menu(hwnd,<sp/>move_button(x,<sp/>y,<sp/>3));
<sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
}


//таймер
void<sp/>ARGS2_FASTCALL<sp/>tetris::onTimer(HWND<sp/>hwnd,<sp/>UINT<sp/>id){
<sp/><sp/><sp/>DWORD<sp/>tick;
<sp/><sp/><sp/><sp/>switch(state){
<sp/>case<sp/>GAME_PLAY:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tick<sp/>=<sp/>timeGetTime();
<sp/><sp/><sp/><sp/><sp/><sp/>if((tick<sp/>-<sp/>prev_time)<sp/>&gt;<sp/>delay){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prev_time<sp/>=<sp/>tick;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_frame(hwnd,<sp/>tick);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rect,<sp/>TRUE);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
}


//рисование
void<sp/>ARGS2_FASTCALL<sp/>tetris::onPaint(HWND<sp/>hwnd,<sp/>HDC<sp/>hDC){
<sp/><sp/>switch(state){
<sp/>case<sp/>GAME_PLAY:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_game(hDC);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_MENU:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_menu(hDC);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_PAUSE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_pause(hDC);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_OVER:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_over(hDC);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
}


//уничтожение окна
void<sp/>ARGS2_FASTCALL<sp/>tetris::onDestroy(HWND<sp/>hwnd){
<sp/>KillTimer(hwnd,<sp/>IDT_TIMER);
<sp/><sp/><sp/><sp/>figures.clear();
<sp/><sp/><sp/>delete<sp/>bback;
<sp/><sp/>delete<sp/>dcbmp;
<sp/><sp/>delete<sp/>bfill;
<sp/><sp/>delete<sp/>blocks;
<sp/>delete<sp/>bother;
<sp/>delete<sp/>bnextf;
<sp/>delete<sp/>balpha;
<sp/>bpane.destroy();
<sp/><sp/><sp/>mask_alpha.destroy();
<sp/><sp/>snd_rot.destroy();
<sp/>snd_stop.destroy();
<sp/><sp/><sp/><sp/>snd_boom.destroy();
}


//-----------------------------------------------------------------------------------------------------


//старт игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::start_game(HWND<sp/>hwnd){
<sp/><sp/><sp/>booms.reset();
<sp/>memset(field,<sp/>0,<sp/>sizeof(field));

<sp/><sp/>velocity<sp/><sp/><sp/>=<sp/>g_velocity;
<sp/><sp/><sp/>start<sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>false;
<sp/><sp/><sp/><sp/>time_boom<sp/><sp/>=<sp/>score<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/>boom_x<sp/><sp/><sp/><sp/><sp/>=<sp/>0;
<sp/><sp/><sp/><sp/>prev_index<sp/>=<sp/>-1;
<sp/><sp/><sp/>put_rand_figure(hwnd);
<sp/>set_state(hwnd,<sp/>GAME_PLAY);
}


//задание случайной фигуры
void<sp/>ARGS2_FASTCALL<sp/>tetris::put_rand_figure(HWND<sp/>hwnd){
<sp/>int<sp/>index,<sp/>icur;
<sp/><sp/><sp/>if(!start){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prev_index<sp/>=<sp/>index<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;figure,<sp/>&amp;figures[index],<sp/>sizeof(figure_t));

<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(!g_repeat){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>do<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>while(icur<sp/>==<sp/>index);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;next_figure,<sp/>&amp;figures[icur],<sp/>sizeof(figure_t));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_set(figure,<sp/>RAND_BLOCKS);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_set(next_figure,<sp/>RAND_BLOCKS);
<sp/><sp/><sp/><sp/><sp/><sp/>start<sp/>=<sp/>true;
<sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;figure,<sp/>&amp;next_figure,<sp/>sizeof(figure_t));

<sp/><sp/><sp/><sp/><sp/><sp/>if(!g_repeat){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>do<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>while(icur<sp/>==<sp/>prev_index);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;next_figure,<sp/>&amp;figures[icur],<sp/>sizeof(figure_t));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_set(next_figure,<sp/>RAND_BLOCKS);
<sp/><sp/><sp/><sp/><sp/><sp/>prev_index<sp/>=<sp/>icur;
<sp/>}

<sp/>if((rand()<sp/>%<sp/>2)<sp/>!=<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/>figure_transponse(next_figure);

<sp/><sp/><sp/>figure_y<sp/>=<sp/>-figure.size<sp/>*<sp/>CELL_SIZE;
<sp/><sp/><sp/>figure_x<sp/>=<sp/>rand()<sp/>%<sp/>(FIELD_COLS<sp/>-<sp/>figure.size);

<sp/><sp/><sp/>bother-&gt;draw(bnextf-&gt;getDC(),<sp/>0,<sp/>0,<sp/>NEXTF_WIDTH,<sp/>NEXTF_HEIGHT,<sp/>0,<sp/>0);

<sp/>const<sp/>int<sp/>edge<sp/><sp/>=<sp/>31;
<sp/><sp/>const<sp/>int<sp/>csize<sp/>=<sp/>18;

<sp/>RECT<sp/>rc;
<sp/><sp/><sp/>figure_size(next_figure,<sp/>&amp;rc,<sp/>csize);

<sp/>const<sp/>int<sp/>left<sp/>=<sp/>(NEXTF_WIDTH<sp/>-<sp/>(rc.right<sp/>-<sp/>rc.left))<sp/>/<sp/>2<sp/>-<sp/>rc.left;
<sp/><sp/><sp/>const<sp/>int<sp/>top<sp/><sp/>=<sp/>(edge<sp/>+<sp/>(91<sp/>-<sp/>(rc.bottom<sp/>-<sp/>rc.top))<sp/>/<sp/>2)<sp/>-<sp/>rc.top;

<sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>next_figure.size;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/>for(int<sp/>j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>next_figure.size;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(next_figure.figure[i][j]<sp/>!=<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(bnextf-&gt;getDC(),<sp/>left<sp/>+<sp/>j*csize,<sp/>top<sp/>+<sp/>i*csize,<sp/>csize,<sp/>csize,<sp/>0,<sp/>182,<sp/>SRCCOPY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>WCHAR<sp/><sp/><sp/><sp/>s[16];
<sp/><sp/><sp/><sp/>int<sp/><sp/><sp/><sp/><sp/><sp/>n<sp/>=<sp/>swprintf(s,<sp/>L&quot;%lu&quot;,<sp/>score);
<sp/><sp/><sp/>COLORREF<sp/>c<sp/>=<sp/>SetTextColor(bnextf-&gt;getDC(),<sp/>RGB(0xFF,<sp/>0xFF,<sp/>0xFF));
<sp/>int<sp/><sp/><sp/>mode<sp/>=<sp/>SetBkMode(bnextf-&gt;getDC(),<sp/>TRANSPARENT);

<sp/>POINT<sp/>pos<sp/>=<sp/>{0,<sp/>bnextf-&gt;getHeight()<sp/>};
<sp/>SIZE<sp/><sp/>fsz<sp/>=<sp/>{0};
<sp/><sp/><sp/>if(GetTextExtentPoint32W(bnextf-&gt;getDC(),<sp/>s,<sp/>n,<sp/>&amp;fsz)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pos.x<sp/><sp/>=<sp/>(bnextf-&gt;getWidth()<sp/>-<sp/>fsz.cx)<sp/>/<sp/>2;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pos.y<sp/>-=<sp/>fsz.cy<sp/>+<sp/>fsz.cy/2<sp/>-<sp/>1;
<sp/><sp/><sp/><sp/>}
<sp/><sp/>TextOutW(bnextf-&gt;getDC(),<sp/>pos.x,<sp/>pos.y,<sp/>s,<sp/>n);

<sp/><sp/><sp/><sp/>SetBkMode(bnextf-&gt;getDC(),<sp/>mode);
<sp/><sp/>SetTextColor(bnextf-&gt;getDC(),<sp/>c);

<sp/>rc.left<sp/><sp/><sp/>=<sp/>field_right;
<sp/><sp/><sp/>rc.top<sp/><sp/><sp/><sp/>=<sp/>0;
<sp/>rc.right<sp/><sp/>=<sp/>rc.left<sp/>+<sp/>NEXTF_WIDTH;
<sp/>rc.bottom<sp/>=<sp/>rc.top<sp/><sp/>+<sp/>NEXTF_HEIGHT;
<sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


//обновление<sp/>кадра
void<sp/>ARGS2_FASTCALL<sp/>tetris::update_frame(HWND<sp/>hwnd,<sp/>DWORD<sp/>tick){
<sp/><sp/><sp/>if((time_boom<sp/>!=<sp/>0)<sp/>&amp;&amp;<sp/>(tick<sp/>&gt;<sp/>time_boom)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>field_remove(field,<sp/>true);
<sp/><sp/><sp/><sp/><sp/>time_boom<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/>booms.reset();
<sp/>}

<sp/>if(is_move_down(figure_x,<sp/>figure_y,<sp/>figure,<sp/>velocity,<sp/>field))
<sp/><sp/><sp/><sp/><sp/><sp/>figure_y<sp/>+=<sp/>velocity;
<sp/><sp/>else<sp/>if(!<sp/>isKeyLeftRight()){<sp/>//здесь сделать блоки частью<sp/>стены

<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(is_game_over()){<sp/>//вы<sp/>проиграли
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_OVER);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>figure_put_field(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field);

<sp/><sp/><sp/><sp/><sp/><sp/>bool<sp/>ok<sp/>=<sp/>field_remove(field,<sp/>false,<sp/>&amp;booms);
<sp/><sp/><sp/><sp/><sp/><sp/>score_add(booms.getSize());
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>put_rand_figure(hwnd);
<sp/><sp/><sp/><sp/><sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(ok){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>time_boom<sp/>=<sp/>tick<sp/>+<sp/>TIME_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/><sp/><sp/><sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_boom.play(&amp;g_audio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_stop.play(&amp;g_audio);
<sp/><sp/><sp/>}
}


//вывод игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_game(HDC<sp/>hDC){
<sp/><sp/>int<sp/>i,<sp/>j,<sp/>box;
<sp/>bback-&gt;draw(hDC,<sp/>0,<sp/>0,<sp/>field_left,<sp/>dcbmp-&gt;getHeight());
<sp/><sp/><sp/><sp/>bback-&gt;draw(hDC,<sp/>field_right,<sp/>bnextf-&gt;getHeight(),<sp/>bback-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>bnextf-&gt;getHeight()<sp/>-<sp/>CTRL_HEIGHT);
<sp/><sp/><sp/><sp/>dcbmp-&gt;draw(bfill);

<sp/><sp/><sp/>//здесь выводим
<sp/><sp/><sp/>HDC<sp/>hdc<sp/>=<sp/>dcbmp-&gt;getDC();

<sp/>//вывод фигуры
<sp/><sp/><sp/>int<sp/>px<sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE;
<sp/>int<sp/>py<sp/>=<sp/>figure_y;
<sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>figure.size;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>for(j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>figure.size;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(figure.figure[i][j]<sp/>!=<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>px<sp/>+<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>py<sp/>+<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>figure.figure[i][j]<sp/>-<sp/>1,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>//вывод блоков
<sp/><sp/><sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>FIELD_ROWS;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>for(j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>FIELD_COLS;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if((box<sp/>=<sp/>field[i][j])<sp/>==<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>continue;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(box<sp/>&lt;=<sp/>BLOCK_C)<sp/>//неподвижные блоки
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>1,<sp/>CELL_SIZE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else//блоки которые для<sp/>взрыва
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>BLOCK_BOOM<sp/>-<sp/>1,<sp/>CELL_OFFSET_BOOM);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>//вывод &quot;взрыва&quot;
<sp/>boom_row*<sp/>p;
<sp/><sp/><sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>booms.getSize();<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>p<sp/>=<sp/>&amp;booms[i];
<sp/><sp/><sp/><sp/><sp/>if(p-&gt;dir<sp/>==<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>+=<sp/>VELOCITY_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(boom_x<sp/>&gt;=<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>20)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>-=<sp/>VELOCITY_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(boom_x<sp/>&lt;<sp/>20){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>20;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hdc,<sp/>boom_x,<sp/>p-&gt;pos,<sp/>20,<sp/>20,<sp/>0,<sp/>200,<sp/>SRCPAINT);
<sp/><sp/><sp/>}

<sp/>BitBlt(hDC,<sp/>field_left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>hdc,<sp/>0,<sp/>0,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/>bnextf-&gt;draw(hDC,<sp/>field_right,<sp/>0,<sp/>NEXTF_WIDTH,<sp/>NEXTF_HEIGHT,<sp/>0,<sp/>0);
<sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>field_right,<sp/>size.cy<sp/>-<sp/>CTRL_HEIGHT,<sp/>NEXTF_WIDTH,<sp/>CTRL_HEIGHT,<sp/>0,<sp/>220);
}


//вывод проигрыша
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_over(HDC<sp/>hDC){
<sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>game[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>77,<sp/>15,<sp/>16,<sp/>14,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>11,<sp/>8,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>19};
<sp/><sp/><sp/><sp/>const<sp/>int<sp/><sp/><sp/><sp/><sp/>fsz<sp/>=<sp/>24;
<sp/><sp/><sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>game,<sp/>sizeof(game),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(game)))/2,<sp/>100,<sp/>fsz,<sp/>28,<sp/>SRCPAINT);

<sp/><sp/>const<sp/>BYTE<sp/>ply[]<sp/><sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>7,<sp/>0,<sp/>13,<sp/>14,<sp/>2,<sp/>14};
<sp/>const<sp/>BYTE<sp/>title[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>2,<sp/>77,<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>11,<sp/>14};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>ply,<sp/>sizeof(ply),<sp/>title,<sp/>sizeof(title));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод паузы
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_pause(HDC<sp/>hDC){
<sp/><sp/><sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>ps[]<sp/>=<sp/>{<sp/>15,<sp/>0,<sp/>19,<sp/>7,<sp/>0};
<sp/><sp/>const<sp/>int<sp/><sp/><sp/>fsz<sp/>=<sp/>32;
<sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ps,<sp/>sizeof(ps),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(ps)))/2,<sp/>100,<sp/>fsz,<sp/>34,<sp/>SRCPAINT);

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>cns[]<sp/>=<sp/>{<sp/>15,<sp/>16,<sp/>14,<sp/>4,<sp/>14,<sp/>11,<sp/>6,<sp/>8,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>exs[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>21,<sp/>14,<sp/>4,<sp/>77,<sp/>2,<sp/>77,<sp/>12,<sp/>5,<sp/>13,<sp/>30};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>cns,<sp/>sizeof(cns),<sp/>exs,<sp/>sizeof(exs));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод меню<sp/>игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_menu(HDC<sp/>hDC){
<sp/>draw_background(hDC);

<sp/>//вывести надпись тетрис
<sp/><sp/>const<sp/>CHAR<sp/>tetris[]<sp/>=<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;###<sp/>###<sp/>###<sp/>###<sp/>#<sp/><sp/><sp/>#<sp/>###\n&quot;\
<sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/>#<sp/>#<sp/><sp/>##<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>###<sp/>#<sp/>#<sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>##<sp/><sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>#<sp/><sp/><sp/>#<sp/>###&quot;
<sp/><sp/><sp/><sp/>};

<sp/><sp/><sp/><sp/>const<sp/>int<sp/>csize<sp/>=<sp/>18;
<sp/><sp/>int<sp/><sp/><sp/><sp/>x<sp/>=<sp/>0,<sp/>y<sp/>=<sp/>0,<sp/>px<sp/>=<sp/>csize<sp/>-<sp/>4,<sp/>py<sp/>=<sp/>csize<sp/>*<sp/>3;
<sp/><sp/><sp/>LPCSTR<sp/>p<sp/>=<sp/>&amp;tetris[0];
<sp/>while(*p){
<sp/><sp/><sp/><sp/><sp/>if(*p<sp/>==<sp/>&apos;#&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(dcbmp-&gt;getDC(),<sp/>px<sp/>+<sp/>x*csize,<sp/>py<sp/>+<sp/>y*csize,<sp/>csize,<sp/>csize,<sp/>0,<sp/>182,<sp/>SRCCOPY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if(*p<sp/>==<sp/>&apos;\n&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++y;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>++p;
<sp/><sp/><sp/>}

<sp/>const<sp/>BYTE<sp/>start[]<sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/>const<sp/>BYTE<sp/>opts[]<sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>17,<sp/>18,<sp/>16,<sp/>14,<sp/>9,<sp/>10,<sp/>0};
<sp/><sp/><sp/>const<sp/>BYTE<sp/>quit[]<sp/><sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>8,<sp/>7,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>27};
<sp/><sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>6,<sp/>start,<sp/>sizeof(start),<sp/>opts,<sp/>sizeof(opts),<sp/>quit,<sp/>sizeof(quit));

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>ctrl[]<sp/>=<sp/>{<sp/>19,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>11,<sp/>5,<sp/>13,<sp/>8,<sp/>5,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>14,<sp/>9};
<sp/>const<sp/>int<sp/>cx<sp/>=<sp/>14;
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ctrl,<sp/>sizeof(ctrl),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(ctrl)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>47,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>BYTE<sp/>help[]<sp/>=<sp/>{<sp/>10,<sp/>11,<sp/>0,<sp/>2,<sp/>8,<sp/>24,<sp/>0,<sp/>77,<sp/>2,<sp/>2,<sp/>5,<sp/>16,<sp/>21,<sp/>77,<sp/>2,<sp/>13,<sp/>8,<sp/>7,<sp/>77,<sp/>2,<sp/>11,<sp/>5,<sp/>2,<sp/>14,<sp/>77,<sp/>2,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>14};
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>help,<sp/>sizeof(help),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(help)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>27,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//----------------------------------------------------------------------------------------------------------------------


void<sp/>tetris::draw_background(HDC<sp/>hDC){
<sp/><sp/>PatBlt(dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>BLACKNESS);
<sp/><sp/><sp/><sp/>bpane.fill(hDC,<sp/>0,<sp/>0,<sp/>PANE_WIDTH,<sp/>dcbmp-&gt;getHeight());
<sp/>bpane.fill(hDC,<sp/>PANE_WIDTH<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>0,<sp/>dcbmp-&gt;getWidth()<sp/>+<sp/>(PANE_WIDTH<sp/>&lt;&lt;<sp/>1)<sp/>+<sp/>1,<sp/>bback-&gt;getHeight());
}


void<sp/>tetris::exec_menu(HWND<sp/>hwnd,<sp/>int<sp/>cmd){
<sp/>if(cmd<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);
<sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>1)<sp/>//диалог<sp/>опции(options)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DialogBoxW((HINSTANCE)GetModuleHandle(NULL),<sp/>MAKEINTRESOURCEW(IDD_OPTIONS),<sp/>hwnd,<sp/>reinterpret_cast&lt;DLGPROC&gt;(&amp;options_proc));
<sp/><sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>2)<sp/>//выход
<sp/><sp/><sp/><sp/><sp/>SendMessage(hwnd,<sp/>WM_CLOSE,<sp/>0,<sp/>0);
}


//перерисовка фигуры
void<sp/>ARGS2_FASTCALL<sp/>tetris::update_figure(HWND<sp/>hwnd){
<sp/><sp/><sp/>const<sp/>int<sp/>m<sp/>=<sp/>CELL_SIZE<sp/>&lt;&lt;<sp/>1;
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>rc.left<sp/><sp/><sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.top<sp/><sp/><sp/><sp/>=<sp/>figure_y<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.right<sp/><sp/>=<sp/>min(rc.left<sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>(m<sp/>&lt;&lt;<sp/>1),<sp/>field_right);<sp/>
<sp/><sp/><sp/><sp/>rc.bottom<sp/>=<sp/>rc.top<sp/><sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>m;
<sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


//добавление<sp/>очков
void<sp/>tetris::score_add(int<sp/>n){
<sp/>if(n<sp/>&gt;<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/>score<sp/>+=<sp/>(n<sp/>==<sp/>1)<sp/>?<sp/>10UL<sp/>:<sp/>static_cast&lt;DWORD&gt;(n)*15UL;
}


//проверка<sp/>на<sp/>проигрыш
bool<sp/>tetris::is_game_over(void){
<sp/><sp/>int<sp/>j<sp/>=<sp/>0;
<sp/>while((j<sp/>&lt;<sp/>FIELD_COLS)<sp/>&amp;&amp;<sp/>(field[0][j]<sp/>==<sp/>BLOCK_NONE))
<sp/><sp/><sp/><sp/><sp/>++j;
<sp/><sp/><sp/>return<sp/>(j<sp/>&lt;<sp/>FIELD_COLS);
}


//вывод кнопок
void<sp/>tetris::draw_buttons(HDC<sp/>hDC,<sp/>int<sp/>num,...){
<sp/>const<sp/>BYTE*<sp/>pb;
<sp/><sp/><sp/><sp/>UINT<sp/><sp/><sp/><sp/>nb;
<sp/><sp/><sp/><sp/>int<sp/><sp/><sp/><sp/><sp/>x,<sp/>p<sp/>=<sp/>0;
<sp/><sp/>RECT<sp/><sp/><sp/><sp/>rc;
<sp/><sp/><sp/><sp/>va_list<sp/>lst;
<sp/><sp/><sp/>va_start(lst,<sp/>num);
<sp/><sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>i<sp/>+=<sp/>2,<sp/>++p){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>p*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>pb<sp/>=<sp/>va_arg(lst,<sp/>const<sp/>BYTE*);
<sp/><sp/><sp/><sp/><sp/>nb<sp/>=<sp/>va_arg(lst,<sp/>UINT);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/><sp/>=<sp/>(p<sp/>==<sp/>sel_cmd)<sp/>?<sp/>89<sp/>:<sp/>21;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>rc.left,<sp/>rc.top,<sp/>rc.right<sp/>-<sp/>rc.left,<sp/>rc.bottom<sp/>-<sp/>rc.top,<sp/>x,<sp/>184,<sp/>69,<sp/>33,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/><sp/><sp/>fnt.draw(hDC,<sp/>pb,<sp/>nb,<sp/>rc.left<sp/>+<sp/>((rc.right<sp/>-<sp/>rc.left)<sp/>-<sp/>static_cast&lt;int&gt;(nb)*fnt.getWidth())/2,<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rc.top<sp/>+<sp/>((rc.bottom<sp/>-<sp/>rc.top)<sp/>-<sp/>fnt.getHeight())/2);
<sp/>}
<sp/><sp/>va_end(lst);
}


void<sp/>ARGS2_FASTCALL<sp/>tetris::set_rect(LPRECT<sp/>prc,<sp/>int<sp/>top){
<sp/><sp/><sp/><sp/>SetRect(prc,<sp/>20,<sp/>250<sp/>+<sp/>top,<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20,<sp/>300<sp/>+<sp/>top);
}


int<sp/>tetris::control_menu(HWND<sp/>hwnd,<sp/>WORD<sp/>key,<sp/>int<sp/>num){
<sp/><sp/><sp/><sp/>switch(key){
<sp/><sp/><sp/>case<sp/>VK_UP:
<sp/><sp/><sp/><sp/>case<sp/>&apos;W&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&gt;<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_DOWN:
<sp/><sp/>case<sp/>&apos;S&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&lt;<sp/>(num<sp/>-<sp/>1)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_RETURN:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>sel_cmd;
<sp/><sp/><sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


void<sp/>tetris::update_menu(HWND<sp/>hwnd){
<sp/><sp/><sp/><sp/>RECT<sp/>rc<sp/>=<sp/>{<sp/>offset_m,<sp/>240,<sp/>offset_m<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>2<sp/>};
<sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


void<sp/>tetris::set_state(HWND<sp/>hwnd,<sp/>e_state_game<sp/>st){
<sp/><sp/><sp/>sel_cmd<sp/>=<sp/>0;
<sp/><sp/><sp/>state<sp/><sp/><sp/>=<sp/>st;
<sp/><sp/>InvalidateRect(hwnd,<sp/>NULL,<sp/>TRUE);
}


int<sp/>tetris::move_button(int<sp/>x,<sp/>int<sp/>y,<sp/>int<sp/>num){
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>i*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>OffsetRect(&amp;rc,<sp/>offset_m,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/>if((x<sp/>&gt;<sp/>rc.left<sp/>&amp;&amp;<sp/>x<sp/>&lt;<sp/>rc.right)<sp/>&amp;&amp;<sp/>(y<sp/>&gt;<sp/>rc.top<sp/>&amp;&amp;<sp/>y<sp/>&lt;<sp/>rc.bottom))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>i;
<sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


//обработчик<sp/>диалога
static<sp/>LRESULT<sp/>CALLBACK<sp/>options_proc(HWND<sp/>hwnd,<sp/>UINT<sp/>msg,<sp/>WPARAM<sp/>wParam,<sp/>LPARAM<sp/>lParam){
<sp/><sp/><sp/><sp/>const<sp/>WCHAR<sp/>vel1[]<sp/>=<sp/>{<sp/>0x41F,0x435,0x440,0x432,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel2[]<sp/>=<sp/>{<sp/>0x412,0x442,0x43E,0x440,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel3[]<sp/>=<sp/>{<sp/>0x422,0x440,0x435,0x442,0x44C,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};

<sp/>switch(msg){
<sp/><sp/><sp/>case<sp/>WM_INITDIALOG:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel1);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel2);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel3);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_SETCURSEL,<sp/>(WPARAM)(g_velocity<sp/>-<sp/>1),<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_SETCHECK,<sp/>(g_audio)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_SETCHECK,<sp/>(!g_repeat)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/>return<sp/>1;
<sp/><sp/>case<sp/>WM_COMMAND:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch(LOWORD(wParam)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_OK:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_velocity<sp/>=<sp/>(int)SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_GETCURSEL,<sp/>0,<sp/>0)<sp/>+<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_audio<sp/><sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/><sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>TRUE<sp/><sp/>:<sp/>FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_repeat<sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>FALSE<sp/>:<sp/>TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_CANCEL:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>WM_CLOSE:
<sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
<sp/><sp/>return<sp/>0;
}
</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_OVER);</highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="134"><highlight class="normal"></highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_8cpp_1ae34222375b8a6a2a7d1a129489e2c5ac" kindref="member">figure_put_field</ref>(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field);</highlight></codeline>
<codeline lineno="136"><highlight class="normal"></highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ok<sp/>=<sp/><ref refid="util_8cpp_1a107f39dc6ef15cff3e411955f9cb1088" kindref="member">field_remove</ref>(field,<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">,<sp/>&amp;booms);</highlight></codeline>
<codeline lineno="138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>score_add(booms.getSize());</highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>put_rand_figure(hwnd);</highlight></codeline>
<codeline lineno="140"><highlight class="normal"></highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(ok){</highlight></codeline>
<codeline lineno="142"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>time_boom<sp/>=<sp/>timeGetTime()<sp/>+<sp/>TIME_BOOM;</highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/><sp/><sp/><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_boom.play(&amp;g_audio);</highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="146"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_stop.play(&amp;g_audio);</highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="149"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>VK_UP:<sp/></highlight><highlight class="comment">//вращение</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/></highlight><highlight class="charliteral">&apos;W&apos;</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="151"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<ref refid="util_8cpp_1a8bb3704a2eaa84bc97dc1f497eb15217" kindref="member">figure_rotate</ref>(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field)){</highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_rot.play(&amp;g_audio);</highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_figure(hwnd);</highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>VK_ESCAPE:</highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_PAUSE);</highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Sleep(100);</highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>GAME_MENU:</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>exec_menu(hwnd,<sp/>control_menu(hwnd,<sp/>key,<sp/>3));</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>GAME_OVER:</highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>control_menu(hwnd,<sp/>key,<sp/>2);</highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(ret<sp/>==<sp/>0)</highlight></codeline>
<codeline lineno="168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);</highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(ret<sp/>==<sp/>1)</highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_MENU);</highlight></codeline>
<codeline lineno="171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="172"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>GAME_PAUSE:</highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>control_menu(hwnd,<sp/>key,<sp/>2);</highlight></codeline>
<codeline lineno="174"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(ret<sp/>==<sp/>0)</highlight></codeline>
<codeline lineno="175"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_PLAY);</highlight></codeline>
<codeline lineno="176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(ret<sp/>==<sp/>1)</highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_MENU);</highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="179"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="180"><highlight class="normal">}</highlight></codeline>
<codeline lineno="181"><highlight class="normal"></highlight></codeline>
<codeline lineno="182"><highlight class="normal"></highlight></codeline>
<codeline lineno="183"><highlight class="normal"></highlight><highlight class="comment">//движение<sp/>мыши</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="184"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>tetris::onMouseMove(<ref refid="main_8cpp_1a74aea08afaa7f26d272e9352ddafda3d" kindref="member">HWND</ref><sp/>hwnd,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>x,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>y){</highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>ret;</highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal">(state){</highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>GAME_OVER:</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>GAME_PAUSE:</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>move_button(x,<sp/>y,<sp/>2);</highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">((ret<sp/>!=<sp/>-1)<sp/>&amp;&amp;<sp/>(ret<sp/>!=<sp/>sel_cmd)){</highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sel_cmd<sp/>=<sp/>ret;</highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);</highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>GAME_MENU:</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>move_button(x,<sp/>y,<sp/>3);</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">((ret<sp/>!=<sp/>-1)<sp/>&amp;&amp;<sp/>(ret<sp/>!=<sp/>sel_cmd)){</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sel_cmd<sp/>=<sp/>ret;</highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);</highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="203"><highlight class="normal">}</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="205"><highlight class="normal"></highlight></codeline>
<codeline lineno="206"><highlight class="normal"></highlight><highlight class="comment">//нажатие кнопки<sp/>мыши</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="207"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>tetris::onMouseDown(<ref refid="main_8cpp_1a74aea08afaa7f26d272e9352ddafda3d" kindref="member">HWND</ref><sp/>hwnd,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>x,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>y){</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>ret;</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal">(state){</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>GAME_PAUSE:</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>move_button(x,<sp/>y,<sp/>2);</highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(ret<sp/>==<sp/>0)</highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_PLAY);</highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(ret<sp/>==<sp/>1)</highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_MENU);</highlight></codeline>
<codeline lineno="216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="217"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>GAME_OVER:</highlight></codeline>
<codeline lineno="218"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>move_button(x,<sp/>y,<sp/>2);</highlight></codeline>
<codeline lineno="219"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(ret<sp/>==<sp/>0)</highlight></codeline>
<codeline lineno="220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);</highlight></codeline>
<codeline lineno="221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(ret<sp/>==<sp/>1)</highlight></codeline>
<codeline lineno="222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_MENU);</highlight></codeline>
<codeline lineno="223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>GAME_MENU:</highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>exec_menu(hwnd,<sp/>move_button(x,<sp/>y,<sp/>3));</highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="228"><highlight class="normal">}</highlight></codeline>
<codeline lineno="229"><highlight class="normal"></highlight></codeline>
<codeline lineno="230"><highlight class="normal"></highlight></codeline>
<codeline lineno="231"><highlight class="normal"></highlight><highlight class="comment">//таймер</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="232"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ARGS2_FASTCALL<sp/>tetris::onTimer(<ref refid="main_8cpp_1a74aea08afaa7f26d272e9352ddafda3d" kindref="member">HWND</ref><sp/>hwnd,<sp/><ref refid="main_8cpp_1afff0ab3629a68bc1bb3b2a2f4296173f" kindref="member">UINT</ref><sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal">){</highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/>DWORD<sp/>tick;</highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal">(state){</highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>GAME_PLAY:</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tick<sp/>=<sp/>timeGetTime();</highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">((tick<sp/>-<sp/>prev_time)<sp/>&gt;<sp/>delay){</highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prev_time<sp/>=<sp/>tick;</highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_frame(hwnd,<sp/>tick);</highlight></codeline>
<codeline lineno="240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rect,<sp/>TRUE);</highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="244"><highlight class="normal">}</highlight></codeline>
<codeline lineno="245"><highlight class="normal"></highlight></codeline>
<codeline lineno="246"><highlight class="normal"></highlight></codeline>
<codeline lineno="247"><highlight class="normal"></highlight><highlight class="comment">//рисование void<sp/>ARGS2_FASTCALL<sp/>tetris::onPaint(HWND<sp/>hwnd,<sp/>HDC<sp/>hDC){
<sp/><sp/><sp/><sp/>switch(state){
<sp/>case<sp/>GAME_PLAY:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_game(hDC);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_MENU:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_menu(hDC);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_PAUSE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_pause(hDC);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>GAME_OVER:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_over(hDC);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
}


//уничтожение окна
void<sp/>ARGS2_FASTCALL<sp/>tetris::onDestroy(HWND<sp/>hwnd){
<sp/>KillTimer(hwnd,<sp/>IDT_TIMER);
<sp/><sp/><sp/><sp/>figures.clear();
<sp/><sp/><sp/>delete<sp/>bback;
<sp/><sp/>delete<sp/>dcbmp;
<sp/><sp/>delete<sp/>bfill;
<sp/><sp/>delete<sp/>blocks;
<sp/>delete<sp/>bother;
<sp/>delete<sp/>bnextf;
<sp/>delete<sp/>balpha;
<sp/>bpane.destroy();
<sp/><sp/><sp/>mask_alpha.destroy();
<sp/><sp/>snd_rot.destroy();
<sp/>snd_stop.destroy();
<sp/><sp/><sp/><sp/>snd_boom.destroy();
}


//-----------------------------------------------------------------------------------------------------


//старт игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::start_game(HWND<sp/>hwnd){
<sp/><sp/><sp/>booms.reset();
<sp/>memset(field,<sp/>0,<sp/>sizeof(field));

<sp/><sp/>velocity<sp/><sp/><sp/>=<sp/>g_velocity;
<sp/><sp/><sp/>start<sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>false;
<sp/><sp/><sp/><sp/>time_boom<sp/><sp/>=<sp/>score<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/>boom_x<sp/><sp/><sp/><sp/><sp/>=<sp/>0;
<sp/><sp/><sp/><sp/>prev_index<sp/>=<sp/>-1;
<sp/><sp/><sp/>put_rand_figure(hwnd);
<sp/>set_state(hwnd,<sp/>GAME_PLAY);
}


//задание случайной фигуры
void<sp/>ARGS2_FASTCALL<sp/>tetris::put_rand_figure(HWND<sp/>hwnd){
<sp/>int<sp/>index,<sp/>icur;
<sp/><sp/><sp/>if(!start){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prev_index<sp/>=<sp/>index<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;figure,<sp/>&amp;figures[index],<sp/>sizeof(figure_t));

<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(!g_repeat){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>do<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>while(icur<sp/>==<sp/>index);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;next_figure,<sp/>&amp;figures[icur],<sp/>sizeof(figure_t));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_set(figure,<sp/>RAND_BLOCKS);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_set(next_figure,<sp/>RAND_BLOCKS);
<sp/><sp/><sp/><sp/><sp/><sp/>start<sp/>=<sp/>true;
<sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;figure,<sp/>&amp;next_figure,<sp/>sizeof(figure_t));

<sp/><sp/><sp/><sp/><sp/><sp/>if(!g_repeat){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>do<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>while(icur<sp/>==<sp/>prev_index);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;next_figure,<sp/>&amp;figures[icur],<sp/>sizeof(figure_t));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_set(next_figure,<sp/>RAND_BLOCKS);
<sp/><sp/><sp/><sp/><sp/><sp/>prev_index<sp/>=<sp/>icur;
<sp/>}

<sp/>if((rand()<sp/>%<sp/>2)<sp/>!=<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/>figure_transponse(next_figure);

<sp/><sp/><sp/>figure_y<sp/>=<sp/>-figure.size<sp/>*<sp/>CELL_SIZE;
<sp/><sp/><sp/>figure_x<sp/>=<sp/>rand()<sp/>%<sp/>(FIELD_COLS<sp/>-<sp/>figure.size);

<sp/><sp/><sp/>bother-&gt;draw(bnextf-&gt;getDC(),<sp/>0,<sp/>0,<sp/>NEXTF_WIDTH,<sp/>NEXTF_HEIGHT,<sp/>0,<sp/>0);

<sp/>const<sp/>int<sp/>edge<sp/><sp/>=<sp/>31;
<sp/><sp/>const<sp/>int<sp/>csize<sp/>=<sp/>18;

<sp/>RECT<sp/>rc;
<sp/><sp/><sp/>figure_size(next_figure,<sp/>&amp;rc,<sp/>csize);

<sp/>const<sp/>int<sp/>left<sp/>=<sp/>(NEXTF_WIDTH<sp/>-<sp/>(rc.right<sp/>-<sp/>rc.left))<sp/>/<sp/>2<sp/>-<sp/>rc.left;
<sp/><sp/><sp/>const<sp/>int<sp/>top<sp/><sp/>=<sp/>(edge<sp/>+<sp/>(91<sp/>-<sp/>(rc.bottom<sp/>-<sp/>rc.top))<sp/>/<sp/>2)<sp/>-<sp/>rc.top;

<sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>next_figure.size;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/>for(int<sp/>j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>next_figure.size;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(next_figure.figure[i][j]<sp/>!=<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(bnextf-&gt;getDC(),<sp/>left<sp/>+<sp/>j*csize,<sp/>top<sp/>+<sp/>i*csize,<sp/>csize,<sp/>csize,<sp/>0,<sp/>182,<sp/>SRCCOPY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>WCHAR<sp/><sp/><sp/><sp/>s[16];
<sp/><sp/><sp/><sp/>int<sp/><sp/><sp/><sp/><sp/><sp/>n<sp/>=<sp/>swprintf(s,<sp/>L&quot;%lu&quot;,<sp/>score);
<sp/><sp/><sp/>COLORREF<sp/>c<sp/>=<sp/>SetTextColor(bnextf-&gt;getDC(),<sp/>RGB(0xFF,<sp/>0xFF,<sp/>0xFF));
<sp/>int<sp/><sp/><sp/>mode<sp/>=<sp/>SetBkMode(bnextf-&gt;getDC(),<sp/>TRANSPARENT);

<sp/>POINT<sp/>pos<sp/>=<sp/>{0,<sp/>bnextf-&gt;getHeight()<sp/>};
<sp/>SIZE<sp/><sp/>fsz<sp/>=<sp/>{0};
<sp/><sp/><sp/>if(GetTextExtentPoint32W(bnextf-&gt;getDC(),<sp/>s,<sp/>n,<sp/>&amp;fsz)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pos.x<sp/><sp/>=<sp/>(bnextf-&gt;getWidth()<sp/>-<sp/>fsz.cx)<sp/>/<sp/>2;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pos.y<sp/>-=<sp/>fsz.cy<sp/>+<sp/>fsz.cy/2<sp/>-<sp/>1;
<sp/><sp/><sp/><sp/>}
<sp/><sp/>TextOutW(bnextf-&gt;getDC(),<sp/>pos.x,<sp/>pos.y,<sp/>s,<sp/>n);

<sp/><sp/><sp/><sp/>SetBkMode(bnextf-&gt;getDC(),<sp/>mode);
<sp/><sp/>SetTextColor(bnextf-&gt;getDC(),<sp/>c);

<sp/>rc.left<sp/><sp/><sp/>=<sp/>field_right;
<sp/><sp/><sp/>rc.top<sp/><sp/><sp/><sp/>=<sp/>0;
<sp/>rc.right<sp/><sp/>=<sp/>rc.left<sp/>+<sp/>NEXTF_WIDTH;
<sp/>rc.bottom<sp/>=<sp/>rc.top<sp/><sp/>+<sp/>NEXTF_HEIGHT;
<sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


//обновление<sp/>кадра
void<sp/>ARGS2_FASTCALL<sp/>tetris::update_frame(HWND<sp/>hwnd,<sp/>DWORD<sp/>tick){
<sp/><sp/><sp/>if((time_boom<sp/>!=<sp/>0)<sp/>&amp;&amp;<sp/>(tick<sp/>&gt;<sp/>time_boom)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>field_remove(field,<sp/>true);
<sp/><sp/><sp/><sp/><sp/>time_boom<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/>booms.reset();
<sp/>}

<sp/>if(is_move_down(figure_x,<sp/>figure_y,<sp/>figure,<sp/>velocity,<sp/>field))
<sp/><sp/><sp/><sp/><sp/><sp/>figure_y<sp/>+=<sp/>velocity;
<sp/><sp/>else<sp/>if(!<sp/>isKeyLeftRight()){<sp/>//здесь сделать блоки частью<sp/>стены

<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(is_game_over()){<sp/>//вы<sp/>проиграли
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_OVER);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>figure_put_field(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field);

<sp/><sp/><sp/><sp/><sp/><sp/>bool<sp/>ok<sp/>=<sp/>field_remove(field,<sp/>false,<sp/>&amp;booms);
<sp/><sp/><sp/><sp/><sp/><sp/>score_add(booms.getSize());
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>put_rand_figure(hwnd);
<sp/><sp/><sp/><sp/><sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(ok){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>time_boom<sp/>=<sp/>tick<sp/>+<sp/>TIME_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/><sp/><sp/><sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_boom.play(&amp;g_audio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_stop.play(&amp;g_audio);
<sp/><sp/><sp/>}
}


//вывод игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_game(HDC<sp/>hDC){
<sp/><sp/>int<sp/>i,<sp/>j,<sp/>box;
<sp/>bback-&gt;draw(hDC,<sp/>0,<sp/>0,<sp/>field_left,<sp/>dcbmp-&gt;getHeight());
<sp/><sp/><sp/><sp/>bback-&gt;draw(hDC,<sp/>field_right,<sp/>bnextf-&gt;getHeight(),<sp/>bback-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>bnextf-&gt;getHeight()<sp/>-<sp/>CTRL_HEIGHT);
<sp/><sp/><sp/><sp/>dcbmp-&gt;draw(bfill);

<sp/><sp/><sp/>//здесь выводим
<sp/><sp/><sp/>HDC<sp/>hdc<sp/>=<sp/>dcbmp-&gt;getDC();

<sp/>//вывод фигуры
<sp/><sp/><sp/>int<sp/>px<sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE;
<sp/>int<sp/>py<sp/>=<sp/>figure_y;
<sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>figure.size;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>for(j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>figure.size;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(figure.figure[i][j]<sp/>!=<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>px<sp/>+<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>py<sp/>+<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>figure.figure[i][j]<sp/>-<sp/>1,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>//вывод блоков
<sp/><sp/><sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>FIELD_ROWS;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>for(j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>FIELD_COLS;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if((box<sp/>=<sp/>field[i][j])<sp/>==<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>continue;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(box<sp/>&lt;=<sp/>BLOCK_C)<sp/>//неподвижные блоки
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>1,<sp/>CELL_SIZE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else//блоки которые для<sp/>взрыва
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>BLOCK_BOOM<sp/>-<sp/>1,<sp/>CELL_OFFSET_BOOM);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>//вывод &quot;взрыва&quot;
<sp/>boom_row*<sp/>p;
<sp/><sp/><sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>booms.getSize();<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>p<sp/>=<sp/>&amp;booms[i];
<sp/><sp/><sp/><sp/><sp/>if(p-&gt;dir<sp/>==<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>+=<sp/>VELOCITY_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(boom_x<sp/>&gt;=<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>20)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>-=<sp/>VELOCITY_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(boom_x<sp/>&lt;<sp/>20){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>20;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hdc,<sp/>boom_x,<sp/>p-&gt;pos,<sp/>20,<sp/>20,<sp/>0,<sp/>200,<sp/>SRCPAINT);
<sp/><sp/><sp/>}

<sp/>BitBlt(hDC,<sp/>field_left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>hdc,<sp/>0,<sp/>0,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/>bnextf-&gt;draw(hDC,<sp/>field_right,<sp/>0,<sp/>NEXTF_WIDTH,<sp/>NEXTF_HEIGHT,<sp/>0,<sp/>0);
<sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>field_right,<sp/>size.cy<sp/>-<sp/>CTRL_HEIGHT,<sp/>NEXTF_WIDTH,<sp/>CTRL_HEIGHT,<sp/>0,<sp/>220);
}


//вывод проигрыша
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_over(HDC<sp/>hDC){
<sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>game[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>77,<sp/>15,<sp/>16,<sp/>14,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>11,<sp/>8,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>19};
<sp/><sp/><sp/><sp/>const<sp/>int<sp/><sp/><sp/><sp/><sp/>fsz<sp/>=<sp/>24;
<sp/><sp/><sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>game,<sp/>sizeof(game),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(game)))/2,<sp/>100,<sp/>fsz,<sp/>28,<sp/>SRCPAINT);

<sp/><sp/>const<sp/>BYTE<sp/>ply[]<sp/><sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>7,<sp/>0,<sp/>13,<sp/>14,<sp/>2,<sp/>14};
<sp/>const<sp/>BYTE<sp/>title[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>2,<sp/>77,<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>11,<sp/>14};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>ply,<sp/>sizeof(ply),<sp/>title,<sp/>sizeof(title));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод паузы
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_pause(HDC<sp/>hDC){
<sp/><sp/><sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>ps[]<sp/>=<sp/>{<sp/>15,<sp/>0,<sp/>19,<sp/>7,<sp/>0};
<sp/><sp/>const<sp/>int<sp/><sp/><sp/>fsz<sp/>=<sp/>32;
<sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ps,<sp/>sizeof(ps),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(ps)))/2,<sp/>100,<sp/>fsz,<sp/>34,<sp/>SRCPAINT);

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>cns[]<sp/>=<sp/>{<sp/>15,<sp/>16,<sp/>14,<sp/>4,<sp/>14,<sp/>11,<sp/>6,<sp/>8,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>exs[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>21,<sp/>14,<sp/>4,<sp/>77,<sp/>2,<sp/>77,<sp/>12,<sp/>5,<sp/>13,<sp/>30};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>cns,<sp/>sizeof(cns),<sp/>exs,<sp/>sizeof(exs));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод меню<sp/>игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_menu(HDC<sp/>hDC){
<sp/>draw_background(hDC);

<sp/>//вывести надпись тетрис
<sp/><sp/>const<sp/>CHAR<sp/>tetris[]<sp/>=<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;###<sp/>###<sp/>###<sp/>###<sp/>#<sp/><sp/><sp/>#<sp/>###\n&quot;\
<sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/>#<sp/>#<sp/><sp/>##<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>###<sp/>#<sp/>#<sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>##<sp/><sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>#<sp/><sp/><sp/>#<sp/>###&quot;
<sp/><sp/><sp/><sp/>};

<sp/><sp/><sp/><sp/>const<sp/>int<sp/>csize<sp/>=<sp/>18;
<sp/><sp/>int<sp/><sp/><sp/><sp/>x<sp/>=<sp/>0,<sp/>y<sp/>=<sp/>0,<sp/>px<sp/>=<sp/>csize<sp/>-<sp/>4,<sp/>py<sp/>=<sp/>csize<sp/>*<sp/>3;
<sp/><sp/><sp/>LPCSTR<sp/>p<sp/>=<sp/>&amp;tetris[0];
<sp/>while(*p){
<sp/><sp/><sp/><sp/><sp/>if(*p<sp/>==<sp/>&apos;#&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(dcbmp-&gt;getDC(),<sp/>px<sp/>+<sp/>x*csize,<sp/>py<sp/>+<sp/>y*csize,<sp/>csize,<sp/>csize,<sp/>0,<sp/>182,<sp/>SRCCOPY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if(*p<sp/>==<sp/>&apos;\n&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++y;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>++p;
<sp/><sp/><sp/>}

<sp/>const<sp/>BYTE<sp/>start[]<sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/>const<sp/>BYTE<sp/>opts[]<sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>17,<sp/>18,<sp/>16,<sp/>14,<sp/>9,<sp/>10,<sp/>0};
<sp/><sp/><sp/>const<sp/>BYTE<sp/>quit[]<sp/><sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>8,<sp/>7,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>27};
<sp/><sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>6,<sp/>start,<sp/>sizeof(start),<sp/>opts,<sp/>sizeof(opts),<sp/>quit,<sp/>sizeof(quit));

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>ctrl[]<sp/>=<sp/>{<sp/>19,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>11,<sp/>5,<sp/>13,<sp/>8,<sp/>5,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>14,<sp/>9};
<sp/>const<sp/>int<sp/>cx<sp/>=<sp/>14;
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ctrl,<sp/>sizeof(ctrl),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(ctrl)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>47,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>BYTE<sp/>help[]<sp/>=<sp/>{<sp/>10,<sp/>11,<sp/>0,<sp/>2,<sp/>8,<sp/>24,<sp/>0,<sp/>77,<sp/>2,<sp/>2,<sp/>5,<sp/>16,<sp/>21,<sp/>77,<sp/>2,<sp/>13,<sp/>8,<sp/>7,<sp/>77,<sp/>2,<sp/>11,<sp/>5,<sp/>2,<sp/>14,<sp/>77,<sp/>2,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>14};
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>help,<sp/>sizeof(help),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(help)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>27,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//----------------------------------------------------------------------------------------------------------------------


void<sp/>tetris::draw_background(HDC<sp/>hDC){
<sp/><sp/>PatBlt(dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>BLACKNESS);
<sp/><sp/><sp/><sp/>bpane.fill(hDC,<sp/>0,<sp/>0,<sp/>PANE_WIDTH,<sp/>dcbmp-&gt;getHeight());
<sp/>bpane.fill(hDC,<sp/>PANE_WIDTH<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>0,<sp/>dcbmp-&gt;getWidth()<sp/>+<sp/>(PANE_WIDTH<sp/>&lt;&lt;<sp/>1)<sp/>+<sp/>1,<sp/>bback-&gt;getHeight());
}


void<sp/>tetris::exec_menu(HWND<sp/>hwnd,<sp/>int<sp/>cmd){
<sp/>if(cmd<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);
<sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>1)<sp/>//диалог<sp/>опции(options)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DialogBoxW((HINSTANCE)GetModuleHandle(NULL),<sp/>MAKEINTRESOURCEW(IDD_OPTIONS),<sp/>hwnd,<sp/>reinterpret_cast&lt;DLGPROC&gt;(&amp;options_proc));
<sp/><sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>2)<sp/>//выход
<sp/><sp/><sp/><sp/><sp/>SendMessage(hwnd,<sp/>WM_CLOSE,<sp/>0,<sp/>0);
}


//перерисовка фигуры
void<sp/>ARGS2_FASTCALL<sp/>tetris::update_figure(HWND<sp/>hwnd){
<sp/><sp/><sp/>const<sp/>int<sp/>m<sp/>=<sp/>CELL_SIZE<sp/>&lt;&lt;<sp/>1;
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>rc.left<sp/><sp/><sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.top<sp/><sp/><sp/><sp/>=<sp/>figure_y<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.right<sp/><sp/>=<sp/>min(rc.left<sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>(m<sp/>&lt;&lt;<sp/>1),<sp/>field_right);<sp/>
<sp/><sp/><sp/><sp/>rc.bottom<sp/>=<sp/>rc.top<sp/><sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>m;
<sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


//добавление<sp/>очков
void<sp/>tetris::score_add(int<sp/>n){
<sp/>if(n<sp/>&gt;<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/>score<sp/>+=<sp/>(n<sp/>==<sp/>1)<sp/>?<sp/>10UL<sp/>:<sp/>static_cast&lt;DWORD&gt;(n)*15UL;
}


//проверка<sp/>на<sp/>проигрыш
bool<sp/>tetris::is_game_over(void){
<sp/><sp/>int<sp/>j<sp/>=<sp/>0;
<sp/>while((j<sp/>&lt;<sp/>FIELD_COLS)<sp/>&amp;&amp;<sp/>(field[0][j]<sp/>==<sp/>BLOCK_NONE))
<sp/><sp/><sp/><sp/><sp/>++j;
<sp/><sp/><sp/>return<sp/>(j<sp/>&lt;<sp/>FIELD_COLS);
}


//вывод кнопок
void<sp/>tetris::draw_buttons(HDC<sp/>hDC,<sp/>int<sp/>num,...){
<sp/>const<sp/>BYTE*<sp/>pb;
<sp/><sp/><sp/><sp/>UINT<sp/><sp/><sp/><sp/>nb;
<sp/><sp/><sp/><sp/>int<sp/><sp/><sp/><sp/><sp/>x,<sp/>p<sp/>=<sp/>0;
<sp/><sp/>RECT<sp/><sp/><sp/><sp/>rc;
<sp/><sp/><sp/><sp/>va_list<sp/>lst;
<sp/><sp/><sp/>va_start(lst,<sp/>num);
<sp/><sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>i<sp/>+=<sp/>2,<sp/>++p){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>p*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>pb<sp/>=<sp/>va_arg(lst,<sp/>const<sp/>BYTE*);
<sp/><sp/><sp/><sp/><sp/>nb<sp/>=<sp/>va_arg(lst,<sp/>UINT);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/><sp/>=<sp/>(p<sp/>==<sp/>sel_cmd)<sp/>?<sp/>89<sp/>:<sp/>21;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>rc.left,<sp/>rc.top,<sp/>rc.right<sp/>-<sp/>rc.left,<sp/>rc.bottom<sp/>-<sp/>rc.top,<sp/>x,<sp/>184,<sp/>69,<sp/>33,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/><sp/><sp/>fnt.draw(hDC,<sp/>pb,<sp/>nb,<sp/>rc.left<sp/>+<sp/>((rc.right<sp/>-<sp/>rc.left)<sp/>-<sp/>static_cast&lt;int&gt;(nb)*fnt.getWidth())/2,<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rc.top<sp/>+<sp/>((rc.bottom<sp/>-<sp/>rc.top)<sp/>-<sp/>fnt.getHeight())/2);
<sp/>}
<sp/><sp/>va_end(lst);
}


void<sp/>ARGS2_FASTCALL<sp/>tetris::set_rect(LPRECT<sp/>prc,<sp/>int<sp/>top){
<sp/><sp/><sp/><sp/>SetRect(prc,<sp/>20,<sp/>250<sp/>+<sp/>top,<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20,<sp/>300<sp/>+<sp/>top);
}


int<sp/>tetris::control_menu(HWND<sp/>hwnd,<sp/>WORD<sp/>key,<sp/>int<sp/>num){
<sp/><sp/><sp/><sp/>switch(key){
<sp/><sp/><sp/>case<sp/>VK_UP:
<sp/><sp/><sp/><sp/>case<sp/>&apos;W&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&gt;<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_DOWN:
<sp/><sp/>case<sp/>&apos;S&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&lt;<sp/>(num<sp/>-<sp/>1)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_RETURN:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>sel_cmd;
<sp/><sp/><sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


void<sp/>tetris::update_menu(HWND<sp/>hwnd){
<sp/><sp/><sp/><sp/>RECT<sp/>rc<sp/>=<sp/>{<sp/>offset_m,<sp/>240,<sp/>offset_m<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>2<sp/>};
<sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


void<sp/>tetris::set_state(HWND<sp/>hwnd,<sp/>e_state_game<sp/>st){
<sp/><sp/><sp/>sel_cmd<sp/>=<sp/>0;
<sp/><sp/><sp/>state<sp/><sp/><sp/>=<sp/>st;
<sp/><sp/>InvalidateRect(hwnd,<sp/>NULL,<sp/>TRUE);
}


int<sp/>tetris::move_button(int<sp/>x,<sp/>int<sp/>y,<sp/>int<sp/>num){
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>i*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>OffsetRect(&amp;rc,<sp/>offset_m,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/>if((x<sp/>&gt;<sp/>rc.left<sp/>&amp;&amp;<sp/>x<sp/>&lt;<sp/>rc.right)<sp/>&amp;&amp;<sp/>(y<sp/>&gt;<sp/>rc.top<sp/>&amp;&amp;<sp/>y<sp/>&lt;<sp/>rc.bottom))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>i;
<sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


//обработчик<sp/>диалога
static<sp/>LRESULT<sp/>CALLBACK<sp/>options_proc(HWND<sp/>hwnd,<sp/>UINT<sp/>msg,<sp/>WPARAM<sp/>wParam,<sp/>LPARAM<sp/>lParam){
<sp/><sp/><sp/><sp/>const<sp/>WCHAR<sp/>vel1[]<sp/>=<sp/>{<sp/>0x41F,0x435,0x440,0x432,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel2[]<sp/>=<sp/>{<sp/>0x412,0x442,0x43E,0x440,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel3[]<sp/>=<sp/>{<sp/>0x422,0x440,0x435,0x442,0x44C,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};

<sp/>switch(msg){
<sp/><sp/><sp/>case<sp/>WM_INITDIALOG:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel1);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel2);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel3);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_SETCURSEL,<sp/>(WPARAM)(g_velocity<sp/>-<sp/>1),<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_SETCHECK,<sp/>(g_audio)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_SETCHECK,<sp/>(!g_repeat)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/>return<sp/>1;
<sp/><sp/>case<sp/>WM_COMMAND:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch(LOWORD(wParam)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_OK:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_velocity<sp/>=<sp/>(int)SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_GETCURSEL,<sp/>0,<sp/>0)<sp/>+<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_audio<sp/><sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/><sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>TRUE<sp/><sp/>:<sp/>FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_repeat<sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>FALSE<sp/>:<sp/>TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_CANCEL:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>WM_CLOSE:
<sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
<sp/><sp/>return<sp/>0;
}
</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="248"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ARGS2_FASTCALL<sp/>tetris::onPaint(<ref refid="main_8cpp_1a74aea08afaa7f26d272e9352ddafda3d" kindref="member">HWND</ref><sp/>hwnd,<sp/><ref refid="main_8cpp_1a296475d8e990aad6b442b8b669315f5e" kindref="member">HDC</ref><sp/>hDC){</highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal">(state){</highlight></codeline>
<codeline lineno="250"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>GAME_PLAY:</highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_game(hDC);</highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>GAME_MENU:</highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_menu(hDC);</highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>GAME_PAUSE:</highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_pause(hDC);</highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>GAME_OVER:</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>draw_over(hDC);</highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="263"><highlight class="normal">}</highlight></codeline>
<codeline lineno="264"><highlight class="normal"></highlight></codeline>
<codeline lineno="265"><highlight class="normal"></highlight></codeline>
<codeline lineno="266"><highlight class="normal"></highlight><highlight class="comment">//уничтожение окна</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="267"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ARGS2_FASTCALL<sp/>tetris::onDestroy(<ref refid="main_8cpp_1a74aea08afaa7f26d272e9352ddafda3d" kindref="member">HWND</ref><sp/>hwnd){</highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/><sp/><sp/>KillTimer(hwnd,<sp/>IDT_TIMER);</highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><sp/><sp/>figures.clear();</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">delete</highlight><highlight class="normal"><sp/>bback;</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">delete</highlight><highlight class="normal"><sp/>dcbmp;</highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">delete</highlight><highlight class="normal"><sp/>bfill;</highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">delete</highlight><highlight class="normal"><sp/>blocks;</highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">delete</highlight><highlight class="normal"><sp/>bother;</highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">delete</highlight><highlight class="normal"><sp/>bnextf;</highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">delete</highlight><highlight class="normal"><sp/>balpha;</highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/>bpane.destroy();</highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/>mask_alpha.destroy();</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/>snd_rot.destroy();</highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/>snd_stop.destroy();</highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/>snd_boom.destroy();</highlight></codeline>
<codeline lineno="282"><highlight class="normal">}</highlight></codeline>
<codeline lineno="283"><highlight class="normal"></highlight></codeline>
<codeline lineno="284"><highlight class="normal"></highlight></codeline>
<codeline lineno="285"><highlight class="normal"></highlight><highlight class="comment">//-----------------------------------------------------------------------------------------------------</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="286"><highlight class="normal"></highlight></codeline>
<codeline lineno="287"><highlight class="normal"></highlight></codeline>
<codeline lineno="288"><highlight class="normal"></highlight><highlight class="comment">//старт игры</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="289"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ARGS2_FASTCALL<sp/>tetris::start_game(<ref refid="main_8cpp_1a74aea08afaa7f26d272e9352ddafda3d" kindref="member">HWND</ref><sp/>hwnd){</highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/>booms.reset();</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/>memset(field,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(field));</highlight></codeline>
<codeline lineno="292"><highlight class="normal"></highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/>velocity<sp/><sp/><sp/>=<sp/>g_velocity;</highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/><sp/><sp/>start<sp/><sp/><sp/><sp/><sp/><sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="295"><highlight class="normal"><sp/><sp/><sp/><sp/>time_boom<sp/><sp/>=<sp/>score<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/><sp/><sp/>boom_x<sp/><sp/><sp/><sp/><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="297"><highlight class="normal"><sp/><sp/><sp/><sp/>prev_index<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/><sp/><sp/>put_rand_figure(hwnd);</highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_PLAY);</highlight></codeline>
<codeline lineno="300"><highlight class="normal">}</highlight></codeline>
<codeline lineno="301"><highlight class="normal"></highlight></codeline>
<codeline lineno="302"><highlight class="normal"></highlight></codeline>
<codeline lineno="303"><highlight class="normal"></highlight><highlight class="comment">//задание случайной фигуры</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="304"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ARGS2_FASTCALL<sp/>tetris::put_rand_figure(<ref refid="main_8cpp_1a74aea08afaa7f26d272e9352ddafda3d" kindref="member">HWND</ref><sp/>hwnd){</highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>index,<sp/>icur;</highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(!start){</highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prev_index<sp/>=<sp/>index<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();</highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;figure,<sp/>&amp;figures[index],<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(figure_t));</highlight></codeline>
<codeline lineno="309"><highlight class="normal"></highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(!g_repeat){</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">do</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();</highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal">(icur<sp/>==<sp/>index);</highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();</highlight></codeline>
<codeline lineno="316"><highlight class="normal"></highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;next_figure,<sp/>&amp;figures[icur],<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(figure_t));</highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_8cpp_1a6f0b48cd728baaf5dbf7a80535a96225" kindref="member">figure_set</ref>(figure,<sp/>RAND_BLOCKS);</highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_8cpp_1a6f0b48cd728baaf5dbf7a80535a96225" kindref="member">figure_set</ref>(next_figure,<sp/>RAND_BLOCKS);</highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;figure,<sp/>&amp;next_figure,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(figure_t));</highlight></codeline>
<codeline lineno="323"><highlight class="normal"></highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(!g_repeat){</highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">do</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();</highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal">(icur<sp/>==<sp/>prev_index);</highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>icur<sp/>=<sp/>rand()<sp/>%<sp/>figures.getSize();</highlight></codeline>
<codeline lineno="330"><highlight class="normal"></highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;next_figure,<sp/>&amp;figures[icur],<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(figure_t));</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_8cpp_1a6f0b48cd728baaf5dbf7a80535a96225" kindref="member">figure_set</ref>(next_figure,<sp/>RAND_BLOCKS);</highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prev_index<sp/>=<sp/>icur;</highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="335"><highlight class="normal"></highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">((rand()<sp/>%<sp/>2)<sp/>!=<sp/>0)</highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_8cpp_1a2845e09fef63a9ff3609366417723ffd" kindref="member">figure_transponse</ref>(next_figure);</highlight></codeline>
<codeline lineno="338"><highlight class="normal"></highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/>figure_y<sp/>=<sp/>-figure.size<sp/>*<sp/>CELL_SIZE;</highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/>figure_x<sp/>=<sp/>rand()<sp/>%<sp/>(FIELD_COLS<sp/>-<sp/>figure.size);</highlight></codeline>
<codeline lineno="341"><highlight class="normal"></highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/>bother-&gt;draw(bnextf-&gt;getDC(),<sp/>0,<sp/>0,<sp/>NEXTF_WIDTH,<sp/>NEXTF_HEIGHT,<sp/>0,<sp/>0);</highlight></codeline>
<codeline lineno="343"><highlight class="normal"></highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>edge<sp/><sp/>=<sp/>31;</highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>csize<sp/>=<sp/>18;</highlight></codeline>
<codeline lineno="346"><highlight class="normal"></highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/>RECT<sp/>rc;</highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="util_8cpp_1a7f301b7d82e7e878a6d3b4fdc89e409b" kindref="member">figure_size</ref>(next_figure,<sp/>&amp;rc,<sp/>csize);</highlight></codeline>
<codeline lineno="349"><highlight class="normal"></highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>left<sp/>=<sp/>(NEXTF_WIDTH<sp/>-<sp/>(rc.right<sp/>-<sp/>rc.left))<sp/>/<sp/>2<sp/>-<sp/>rc.left;</highlight></codeline>
<codeline lineno="351"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>top<sp/><sp/>=<sp/>(edge<sp/>+<sp/>(91<sp/>-<sp/>(rc.bottom<sp/>-<sp/>rc.top))<sp/>/<sp/>2)<sp/>-<sp/>rc.top;</highlight></codeline>
<codeline lineno="352"><highlight class="normal"></highlight></codeline>
<codeline lineno="353"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>next_figure.size;<sp/>++i){</highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>next_figure.size;<sp/>++j){</highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(next_figure.figure[i][j]<sp/>!=<sp/>BLOCK_NONE)</highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(bnextf-&gt;getDC(),<sp/>left<sp/>+<sp/>j*csize,<sp/>top<sp/>+<sp/>i*csize,<sp/>csize,<sp/>csize,<sp/>0,<sp/>182,<sp/>SRCCOPY);</highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="359"><highlight class="normal"></highlight></codeline>
<codeline lineno="360"><highlight class="normal"><sp/><sp/><sp/><sp/>WCHAR<sp/><sp/><sp/><sp/>s[16];</highlight></codeline>
<codeline lineno="361"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>n<sp/>=<sp/>swprintf(s,<sp/>L</highlight><highlight class="stringliteral">&quot;%lu&quot;</highlight><highlight class="normal">,<sp/>score);</highlight></codeline>
<codeline lineno="362"><highlight class="normal"><sp/><sp/><sp/><sp/>COLORREF<sp/>c<sp/>=<sp/>SetTextColor(bnextf-&gt;getDC(),<sp/>RGB(0xFF,<sp/>0xFF,<sp/>0xFF));</highlight></codeline>
<codeline lineno="363"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><sp/><sp/>mode<sp/>=<sp/>SetBkMode(bnextf-&gt;getDC(),<sp/>TRANSPARENT);</highlight></codeline>
<codeline lineno="364"><highlight class="normal"></highlight></codeline>
<codeline lineno="365"><highlight class="normal"><sp/><sp/><sp/><sp/>POINT<sp/>pos<sp/>=<sp/>{0,<sp/>bnextf-&gt;getHeight()<sp/>};</highlight></codeline>
<codeline lineno="366"><highlight class="normal"><sp/><sp/><sp/><sp/>SIZE<sp/><sp/>fsz<sp/>=<sp/>{0};</highlight></codeline>
<codeline lineno="367"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(GetTextExtentPoint32W(bnextf-&gt;getDC(),<sp/>s,<sp/>n,<sp/>&amp;fsz)){</highlight></codeline>
<codeline lineno="368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pos.x<sp/><sp/>=<sp/>(bnextf-&gt;getWidth()<sp/>-<sp/>fsz.cx)<sp/>/<sp/>2;</highlight></codeline>
<codeline lineno="369"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pos.y<sp/>-=<sp/>fsz.cy<sp/>+<sp/>fsz.cy/2<sp/>-<sp/>1;</highlight></codeline>
<codeline lineno="370"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="371"><highlight class="normal"><sp/><sp/><sp/><sp/>TextOutW(bnextf-&gt;getDC(),<sp/>pos.x,<sp/>pos.y,<sp/>s,<sp/>n);</highlight></codeline>
<codeline lineno="372"><highlight class="normal"></highlight></codeline>
<codeline lineno="373"><highlight class="normal"><sp/><sp/><sp/><sp/>SetBkMode(bnextf-&gt;getDC(),<sp/>mode);</highlight></codeline>
<codeline lineno="374"><highlight class="normal"><sp/><sp/><sp/><sp/>SetTextColor(bnextf-&gt;getDC(),<sp/>c);</highlight></codeline>
<codeline lineno="375"><highlight class="normal"></highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/><sp/><sp/>rc.left<sp/><sp/><sp/>=<sp/>field_right;</highlight></codeline>
<codeline lineno="377"><highlight class="normal"><sp/><sp/><sp/><sp/>rc.top<sp/><sp/><sp/><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/><sp/><sp/>rc.right<sp/><sp/>=<sp/>rc.left<sp/>+<sp/>NEXTF_WIDTH;</highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/><sp/><sp/>rc.bottom<sp/>=<sp/>rc.top<sp/><sp/>+<sp/>NEXTF_HEIGHT;</highlight></codeline>
<codeline lineno="380"><highlight class="normal"><sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);</highlight></codeline>
<codeline lineno="381"><highlight class="normal">}</highlight></codeline>
<codeline lineno="382"><highlight class="normal"></highlight></codeline>
<codeline lineno="383"><highlight class="normal"></highlight></codeline>
<codeline lineno="384"><highlight class="normal"></highlight><highlight class="comment">//обновление<sp/>кадра void<sp/>ARGS2_FASTCALL<sp/>tetris::update_frame(HWND<sp/>hwnd,<sp/>DWORD<sp/>tick){
<sp/><sp/><sp/><sp/>if((time_boom<sp/>!=<sp/>0)<sp/>&amp;&amp;<sp/>(tick<sp/>&gt;<sp/>time_boom)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>field_remove(field,<sp/>true);
<sp/><sp/><sp/><sp/><sp/>time_boom<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/>booms.reset();
<sp/>}

<sp/>if(is_move_down(figure_x,<sp/>figure_y,<sp/>figure,<sp/>velocity,<sp/>field))
<sp/><sp/><sp/><sp/><sp/><sp/>figure_y<sp/>+=<sp/>velocity;
<sp/><sp/>else<sp/>if(!<sp/>isKeyLeftRight()){<sp/>//здесь сделать блоки частью<sp/>стены

<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(is_game_over()){<sp/>//вы<sp/>проиграли
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_OVER);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>figure_put_field(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field);

<sp/><sp/><sp/><sp/><sp/><sp/>bool<sp/>ok<sp/>=<sp/>field_remove(field,<sp/>false,<sp/>&amp;booms);
<sp/><sp/><sp/><sp/><sp/><sp/>score_add(booms.getSize());
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>put_rand_figure(hwnd);
<sp/><sp/><sp/><sp/><sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(ok){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>time_boom<sp/>=<sp/>tick<sp/>+<sp/>TIME_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/><sp/><sp/><sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_boom.play(&amp;g_audio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_stop.play(&amp;g_audio);
<sp/><sp/><sp/>}
}


//вывод игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_game(HDC<sp/>hDC){
<sp/><sp/>int<sp/>i,<sp/>j,<sp/>box;
<sp/>bback-&gt;draw(hDC,<sp/>0,<sp/>0,<sp/>field_left,<sp/>dcbmp-&gt;getHeight());
<sp/><sp/><sp/><sp/>bback-&gt;draw(hDC,<sp/>field_right,<sp/>bnextf-&gt;getHeight(),<sp/>bback-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>bnextf-&gt;getHeight()<sp/>-<sp/>CTRL_HEIGHT);
<sp/><sp/><sp/><sp/>dcbmp-&gt;draw(bfill);

<sp/><sp/><sp/>//здесь выводим
<sp/><sp/><sp/>HDC<sp/>hdc<sp/>=<sp/>dcbmp-&gt;getDC();

<sp/>//вывод фигуры
<sp/><sp/><sp/>int<sp/>px<sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE;
<sp/>int<sp/>py<sp/>=<sp/>figure_y;
<sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>figure.size;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>for(j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>figure.size;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(figure.figure[i][j]<sp/>!=<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>px<sp/>+<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>py<sp/>+<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>figure.figure[i][j]<sp/>-<sp/>1,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>//вывод блоков
<sp/><sp/><sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>FIELD_ROWS;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>for(j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>FIELD_COLS;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if((box<sp/>=<sp/>field[i][j])<sp/>==<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>continue;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(box<sp/>&lt;=<sp/>BLOCK_C)<sp/>//неподвижные блоки
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>1,<sp/>CELL_SIZE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else//блоки которые для<sp/>взрыва
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>BLOCK_BOOM<sp/>-<sp/>1,<sp/>CELL_OFFSET_BOOM);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>//вывод &quot;взрыва&quot;
<sp/>boom_row*<sp/>p;
<sp/><sp/><sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>booms.getSize();<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>p<sp/>=<sp/>&amp;booms[i];
<sp/><sp/><sp/><sp/><sp/>if(p-&gt;dir<sp/>==<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>+=<sp/>VELOCITY_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(boom_x<sp/>&gt;=<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>20)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>-=<sp/>VELOCITY_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(boom_x<sp/>&lt;<sp/>20){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>20;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hdc,<sp/>boom_x,<sp/>p-&gt;pos,<sp/>20,<sp/>20,<sp/>0,<sp/>200,<sp/>SRCPAINT);
<sp/><sp/><sp/>}

<sp/>BitBlt(hDC,<sp/>field_left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>hdc,<sp/>0,<sp/>0,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/>bnextf-&gt;draw(hDC,<sp/>field_right,<sp/>0,<sp/>NEXTF_WIDTH,<sp/>NEXTF_HEIGHT,<sp/>0,<sp/>0);
<sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>field_right,<sp/>size.cy<sp/>-<sp/>CTRL_HEIGHT,<sp/>NEXTF_WIDTH,<sp/>CTRL_HEIGHT,<sp/>0,<sp/>220);
}


//вывод проигрыша
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_over(HDC<sp/>hDC){
<sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>game[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>77,<sp/>15,<sp/>16,<sp/>14,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>11,<sp/>8,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>19};
<sp/><sp/><sp/><sp/>const<sp/>int<sp/><sp/><sp/><sp/><sp/>fsz<sp/>=<sp/>24;
<sp/><sp/><sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>game,<sp/>sizeof(game),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(game)))/2,<sp/>100,<sp/>fsz,<sp/>28,<sp/>SRCPAINT);

<sp/><sp/>const<sp/>BYTE<sp/>ply[]<sp/><sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>7,<sp/>0,<sp/>13,<sp/>14,<sp/>2,<sp/>14};
<sp/>const<sp/>BYTE<sp/>title[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>2,<sp/>77,<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>11,<sp/>14};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>ply,<sp/>sizeof(ply),<sp/>title,<sp/>sizeof(title));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод паузы
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_pause(HDC<sp/>hDC){
<sp/><sp/><sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>ps[]<sp/>=<sp/>{<sp/>15,<sp/>0,<sp/>19,<sp/>7,<sp/>0};
<sp/><sp/>const<sp/>int<sp/><sp/><sp/>fsz<sp/>=<sp/>32;
<sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ps,<sp/>sizeof(ps),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(ps)))/2,<sp/>100,<sp/>fsz,<sp/>34,<sp/>SRCPAINT);

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>cns[]<sp/>=<sp/>{<sp/>15,<sp/>16,<sp/>14,<sp/>4,<sp/>14,<sp/>11,<sp/>6,<sp/>8,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>exs[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>21,<sp/>14,<sp/>4,<sp/>77,<sp/>2,<sp/>77,<sp/>12,<sp/>5,<sp/>13,<sp/>30};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>cns,<sp/>sizeof(cns),<sp/>exs,<sp/>sizeof(exs));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод меню<sp/>игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_menu(HDC<sp/>hDC){
<sp/>draw_background(hDC);

<sp/>//вывести надпись тетрис
<sp/><sp/>const<sp/>CHAR<sp/>tetris[]<sp/>=<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;###<sp/>###<sp/>###<sp/>###<sp/>#<sp/><sp/><sp/>#<sp/>###\n&quot;\
<sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/>#<sp/>#<sp/><sp/>##<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>###<sp/>#<sp/>#<sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>##<sp/><sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>#<sp/><sp/><sp/>#<sp/>###&quot;
<sp/><sp/><sp/><sp/>};

<sp/><sp/><sp/><sp/>const<sp/>int<sp/>csize<sp/>=<sp/>18;
<sp/><sp/>int<sp/><sp/><sp/><sp/>x<sp/>=<sp/>0,<sp/>y<sp/>=<sp/>0,<sp/>px<sp/>=<sp/>csize<sp/>-<sp/>4,<sp/>py<sp/>=<sp/>csize<sp/>*<sp/>3;
<sp/><sp/><sp/>LPCSTR<sp/>p<sp/>=<sp/>&amp;tetris[0];
<sp/>while(*p){
<sp/><sp/><sp/><sp/><sp/>if(*p<sp/>==<sp/>&apos;#&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(dcbmp-&gt;getDC(),<sp/>px<sp/>+<sp/>x*csize,<sp/>py<sp/>+<sp/>y*csize,<sp/>csize,<sp/>csize,<sp/>0,<sp/>182,<sp/>SRCCOPY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if(*p<sp/>==<sp/>&apos;\n&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++y;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>++p;
<sp/><sp/><sp/>}

<sp/>const<sp/>BYTE<sp/>start[]<sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/>const<sp/>BYTE<sp/>opts[]<sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>17,<sp/>18,<sp/>16,<sp/>14,<sp/>9,<sp/>10,<sp/>0};
<sp/><sp/><sp/>const<sp/>BYTE<sp/>quit[]<sp/><sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>8,<sp/>7,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>27};
<sp/><sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>6,<sp/>start,<sp/>sizeof(start),<sp/>opts,<sp/>sizeof(opts),<sp/>quit,<sp/>sizeof(quit));

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>ctrl[]<sp/>=<sp/>{<sp/>19,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>11,<sp/>5,<sp/>13,<sp/>8,<sp/>5,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>14,<sp/>9};
<sp/>const<sp/>int<sp/>cx<sp/>=<sp/>14;
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ctrl,<sp/>sizeof(ctrl),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(ctrl)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>47,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>BYTE<sp/>help[]<sp/>=<sp/>{<sp/>10,<sp/>11,<sp/>0,<sp/>2,<sp/>8,<sp/>24,<sp/>0,<sp/>77,<sp/>2,<sp/>2,<sp/>5,<sp/>16,<sp/>21,<sp/>77,<sp/>2,<sp/>13,<sp/>8,<sp/>7,<sp/>77,<sp/>2,<sp/>11,<sp/>5,<sp/>2,<sp/>14,<sp/>77,<sp/>2,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>14};
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>help,<sp/>sizeof(help),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(help)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>27,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//----------------------------------------------------------------------------------------------------------------------


void<sp/>tetris::draw_background(HDC<sp/>hDC){
<sp/><sp/>PatBlt(dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>BLACKNESS);
<sp/><sp/><sp/><sp/>bpane.fill(hDC,<sp/>0,<sp/>0,<sp/>PANE_WIDTH,<sp/>dcbmp-&gt;getHeight());
<sp/>bpane.fill(hDC,<sp/>PANE_WIDTH<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>0,<sp/>dcbmp-&gt;getWidth()<sp/>+<sp/>(PANE_WIDTH<sp/>&lt;&lt;<sp/>1)<sp/>+<sp/>1,<sp/>bback-&gt;getHeight());
}


void<sp/>tetris::exec_menu(HWND<sp/>hwnd,<sp/>int<sp/>cmd){
<sp/>if(cmd<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);
<sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>1)<sp/>//диалог<sp/>опции(options)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DialogBoxW((HINSTANCE)GetModuleHandle(NULL),<sp/>MAKEINTRESOURCEW(IDD_OPTIONS),<sp/>hwnd,<sp/>reinterpret_cast&lt;DLGPROC&gt;(&amp;options_proc));
<sp/><sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>2)<sp/>//выход
<sp/><sp/><sp/><sp/><sp/>SendMessage(hwnd,<sp/>WM_CLOSE,<sp/>0,<sp/>0);
}


//перерисовка фигуры
void<sp/>ARGS2_FASTCALL<sp/>tetris::update_figure(HWND<sp/>hwnd){
<sp/><sp/><sp/>const<sp/>int<sp/>m<sp/>=<sp/>CELL_SIZE<sp/>&lt;&lt;<sp/>1;
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>rc.left<sp/><sp/><sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.top<sp/><sp/><sp/><sp/>=<sp/>figure_y<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.right<sp/><sp/>=<sp/>min(rc.left<sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>(m<sp/>&lt;&lt;<sp/>1),<sp/>field_right);<sp/>
<sp/><sp/><sp/><sp/>rc.bottom<sp/>=<sp/>rc.top<sp/><sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>m;
<sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


//добавление<sp/>очков
void<sp/>tetris::score_add(int<sp/>n){
<sp/>if(n<sp/>&gt;<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/>score<sp/>+=<sp/>(n<sp/>==<sp/>1)<sp/>?<sp/>10UL<sp/>:<sp/>static_cast&lt;DWORD&gt;(n)*15UL;
}


//проверка<sp/>на<sp/>проигрыш
bool<sp/>tetris::is_game_over(void){
<sp/><sp/>int<sp/>j<sp/>=<sp/>0;
<sp/>while((j<sp/>&lt;<sp/>FIELD_COLS)<sp/>&amp;&amp;<sp/>(field[0][j]<sp/>==<sp/>BLOCK_NONE))
<sp/><sp/><sp/><sp/><sp/>++j;
<sp/><sp/><sp/>return<sp/>(j<sp/>&lt;<sp/>FIELD_COLS);
}


//вывод кнопок
void<sp/>tetris::draw_buttons(HDC<sp/>hDC,<sp/>int<sp/>num,...){
<sp/>const<sp/>BYTE*<sp/>pb;
<sp/><sp/><sp/><sp/>UINT<sp/><sp/><sp/><sp/>nb;
<sp/><sp/><sp/><sp/>int<sp/><sp/><sp/><sp/><sp/>x,<sp/>p<sp/>=<sp/>0;
<sp/><sp/>RECT<sp/><sp/><sp/><sp/>rc;
<sp/><sp/><sp/><sp/>va_list<sp/>lst;
<sp/><sp/><sp/>va_start(lst,<sp/>num);
<sp/><sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>i<sp/>+=<sp/>2,<sp/>++p){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>p*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>pb<sp/>=<sp/>va_arg(lst,<sp/>const<sp/>BYTE*);
<sp/><sp/><sp/><sp/><sp/>nb<sp/>=<sp/>va_arg(lst,<sp/>UINT);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/><sp/>=<sp/>(p<sp/>==<sp/>sel_cmd)<sp/>?<sp/>89<sp/>:<sp/>21;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>rc.left,<sp/>rc.top,<sp/>rc.right<sp/>-<sp/>rc.left,<sp/>rc.bottom<sp/>-<sp/>rc.top,<sp/>x,<sp/>184,<sp/>69,<sp/>33,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/><sp/><sp/>fnt.draw(hDC,<sp/>pb,<sp/>nb,<sp/>rc.left<sp/>+<sp/>((rc.right<sp/>-<sp/>rc.left)<sp/>-<sp/>static_cast&lt;int&gt;(nb)*fnt.getWidth())/2,<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rc.top<sp/>+<sp/>((rc.bottom<sp/>-<sp/>rc.top)<sp/>-<sp/>fnt.getHeight())/2);
<sp/>}
<sp/><sp/>va_end(lst);
}


void<sp/>ARGS2_FASTCALL<sp/>tetris::set_rect(LPRECT<sp/>prc,<sp/>int<sp/>top){
<sp/><sp/><sp/><sp/>SetRect(prc,<sp/>20,<sp/>250<sp/>+<sp/>top,<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20,<sp/>300<sp/>+<sp/>top);
}


int<sp/>tetris::control_menu(HWND<sp/>hwnd,<sp/>WORD<sp/>key,<sp/>int<sp/>num){
<sp/><sp/><sp/><sp/>switch(key){
<sp/><sp/><sp/>case<sp/>VK_UP:
<sp/><sp/><sp/><sp/>case<sp/>&apos;W&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&gt;<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_DOWN:
<sp/><sp/>case<sp/>&apos;S&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&lt;<sp/>(num<sp/>-<sp/>1)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_RETURN:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>sel_cmd;
<sp/><sp/><sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


void<sp/>tetris::update_menu(HWND<sp/>hwnd){
<sp/><sp/><sp/><sp/>RECT<sp/>rc<sp/>=<sp/>{<sp/>offset_m,<sp/>240,<sp/>offset_m<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>2<sp/>};
<sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


void<sp/>tetris::set_state(HWND<sp/>hwnd,<sp/>e_state_game<sp/>st){
<sp/><sp/><sp/>sel_cmd<sp/>=<sp/>0;
<sp/><sp/><sp/>state<sp/><sp/><sp/>=<sp/>st;
<sp/><sp/>InvalidateRect(hwnd,<sp/>NULL,<sp/>TRUE);
}


int<sp/>tetris::move_button(int<sp/>x,<sp/>int<sp/>y,<sp/>int<sp/>num){
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>i*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>OffsetRect(&amp;rc,<sp/>offset_m,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/>if((x<sp/>&gt;<sp/>rc.left<sp/>&amp;&amp;<sp/>x<sp/>&lt;<sp/>rc.right)<sp/>&amp;&amp;<sp/>(y<sp/>&gt;<sp/>rc.top<sp/>&amp;&amp;<sp/>y<sp/>&lt;<sp/>rc.bottom))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>i;
<sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


//обработчик<sp/>диалога
static<sp/>LRESULT<sp/>CALLBACK<sp/>options_proc(HWND<sp/>hwnd,<sp/>UINT<sp/>msg,<sp/>WPARAM<sp/>wParam,<sp/>LPARAM<sp/>lParam){
<sp/><sp/><sp/><sp/>const<sp/>WCHAR<sp/>vel1[]<sp/>=<sp/>{<sp/>0x41F,0x435,0x440,0x432,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel2[]<sp/>=<sp/>{<sp/>0x412,0x442,0x43E,0x440,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel3[]<sp/>=<sp/>{<sp/>0x422,0x440,0x435,0x442,0x44C,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};

<sp/>switch(msg){
<sp/><sp/><sp/>case<sp/>WM_INITDIALOG:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel1);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel2);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel3);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_SETCURSEL,<sp/>(WPARAM)(g_velocity<sp/>-<sp/>1),<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_SETCHECK,<sp/>(g_audio)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_SETCHECK,<sp/>(!g_repeat)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/>return<sp/>1;
<sp/><sp/>case<sp/>WM_COMMAND:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch(LOWORD(wParam)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_OK:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_velocity<sp/>=<sp/>(int)SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_GETCURSEL,<sp/>0,<sp/>0)<sp/>+<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_audio<sp/><sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/><sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>TRUE<sp/><sp/>:<sp/>FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_repeat<sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>FALSE<sp/>:<sp/>TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_CANCEL:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>WM_CLOSE:
<sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
<sp/><sp/>return<sp/>0;
}
</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="385"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ARGS2_FASTCALL<sp/>tetris::update_frame(<ref refid="main_8cpp_1a74aea08afaa7f26d272e9352ddafda3d" kindref="member">HWND</ref><sp/>hwnd,<sp/>DWORD<sp/>tick){</highlight></codeline>
<codeline lineno="386"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">((time_boom<sp/>!=<sp/>0)<sp/>&amp;&amp;<sp/>(tick<sp/>&gt;<sp/>time_boom)){</highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_8cpp_1a107f39dc6ef15cff3e411955f9cb1088" kindref="member">field_remove</ref>(field,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>time_boom<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="389"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>booms.reset();</highlight></codeline>
<codeline lineno="390"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="391"><highlight class="normal"></highlight></codeline>
<codeline lineno="392"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<ref refid="util_8cpp_1ae2af2e4dfced0dbcaf04978c90b2fc1c" kindref="member">is_move_down</ref>(figure_x,<sp/>figure_y,<sp/>figure,<sp/>velocity,<sp/>field))</highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>figure_y<sp/>+=<sp/>velocity;</highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(!<sp/><ref refid="game_8cpp_1a0c1edce48bfa4c7a8296b811c5b5820c" kindref="member">isKeyLeftRight</ref>()){<sp/></highlight><highlight class="comment">//здесь сделать блоки частью<sp/>стены 
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(is_game_over()){<sp/>//вы<sp/>проиграли
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_OVER);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>figure_put_field(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field);

<sp/><sp/><sp/><sp/><sp/><sp/>bool<sp/>ok<sp/>=<sp/>field_remove(field,<sp/>false,<sp/>&amp;booms);
<sp/><sp/><sp/><sp/><sp/><sp/>score_add(booms.getSize());
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>put_rand_figure(hwnd);
<sp/><sp/><sp/><sp/><sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(ok){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>time_boom<sp/>=<sp/>tick<sp/>+<sp/>TIME_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/><sp/><sp/><sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_boom.play(&amp;g_audio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_stop.play(&amp;g_audio);
<sp/><sp/><sp/>}
}


//вывод игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_game(HDC<sp/>hDC){
<sp/><sp/>int<sp/>i,<sp/>j,<sp/>box;
<sp/>bback-&gt;draw(hDC,<sp/>0,<sp/>0,<sp/>field_left,<sp/>dcbmp-&gt;getHeight());
<sp/><sp/><sp/><sp/>bback-&gt;draw(hDC,<sp/>field_right,<sp/>bnextf-&gt;getHeight(),<sp/>bback-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>bnextf-&gt;getHeight()<sp/>-<sp/>CTRL_HEIGHT);
<sp/><sp/><sp/><sp/>dcbmp-&gt;draw(bfill);

<sp/><sp/><sp/>//здесь выводим
<sp/><sp/><sp/>HDC<sp/>hdc<sp/>=<sp/>dcbmp-&gt;getDC();

<sp/>//вывод фигуры
<sp/><sp/><sp/>int<sp/>px<sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE;
<sp/>int<sp/>py<sp/>=<sp/>figure_y;
<sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>figure.size;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>for(j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>figure.size;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(figure.figure[i][j]<sp/>!=<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>px<sp/>+<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>py<sp/>+<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>figure.figure[i][j]<sp/>-<sp/>1,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>//вывод блоков
<sp/><sp/><sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>FIELD_ROWS;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>for(j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>FIELD_COLS;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if((box<sp/>=<sp/>field[i][j])<sp/>==<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>continue;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(box<sp/>&lt;=<sp/>BLOCK_C)<sp/>//неподвижные блоки
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>1,<sp/>CELL_SIZE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else//блоки которые для<sp/>взрыва
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>BLOCK_BOOM<sp/>-<sp/>1,<sp/>CELL_OFFSET_BOOM);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>//вывод &quot;взрыва&quot;
<sp/>boom_row*<sp/>p;
<sp/><sp/><sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>booms.getSize();<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>p<sp/>=<sp/>&amp;booms[i];
<sp/><sp/><sp/><sp/><sp/>if(p-&gt;dir<sp/>==<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>+=<sp/>VELOCITY_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(boom_x<sp/>&gt;=<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>20)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>-=<sp/>VELOCITY_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(boom_x<sp/>&lt;<sp/>20){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>20;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hdc,<sp/>boom_x,<sp/>p-&gt;pos,<sp/>20,<sp/>20,<sp/>0,<sp/>200,<sp/>SRCPAINT);
<sp/><sp/><sp/>}

<sp/>BitBlt(hDC,<sp/>field_left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>hdc,<sp/>0,<sp/>0,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/>bnextf-&gt;draw(hDC,<sp/>field_right,<sp/>0,<sp/>NEXTF_WIDTH,<sp/>NEXTF_HEIGHT,<sp/>0,<sp/>0);
<sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>field_right,<sp/>size.cy<sp/>-<sp/>CTRL_HEIGHT,<sp/>NEXTF_WIDTH,<sp/>CTRL_HEIGHT,<sp/>0,<sp/>220);
}


//вывод проигрыша
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_over(HDC<sp/>hDC){
<sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>game[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>77,<sp/>15,<sp/>16,<sp/>14,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>11,<sp/>8,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>19};
<sp/><sp/><sp/><sp/>const<sp/>int<sp/><sp/><sp/><sp/><sp/>fsz<sp/>=<sp/>24;
<sp/><sp/><sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>game,<sp/>sizeof(game),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(game)))/2,<sp/>100,<sp/>fsz,<sp/>28,<sp/>SRCPAINT);

<sp/><sp/>const<sp/>BYTE<sp/>ply[]<sp/><sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>7,<sp/>0,<sp/>13,<sp/>14,<sp/>2,<sp/>14};
<sp/>const<sp/>BYTE<sp/>title[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>2,<sp/>77,<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>11,<sp/>14};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>ply,<sp/>sizeof(ply),<sp/>title,<sp/>sizeof(title));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод паузы
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_pause(HDC<sp/>hDC){
<sp/><sp/><sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>ps[]<sp/>=<sp/>{<sp/>15,<sp/>0,<sp/>19,<sp/>7,<sp/>0};
<sp/><sp/>const<sp/>int<sp/><sp/><sp/>fsz<sp/>=<sp/>32;
<sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ps,<sp/>sizeof(ps),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(ps)))/2,<sp/>100,<sp/>fsz,<sp/>34,<sp/>SRCPAINT);

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>cns[]<sp/>=<sp/>{<sp/>15,<sp/>16,<sp/>14,<sp/>4,<sp/>14,<sp/>11,<sp/>6,<sp/>8,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>exs[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>21,<sp/>14,<sp/>4,<sp/>77,<sp/>2,<sp/>77,<sp/>12,<sp/>5,<sp/>13,<sp/>30};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>cns,<sp/>sizeof(cns),<sp/>exs,<sp/>sizeof(exs));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод меню<sp/>игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_menu(HDC<sp/>hDC){
<sp/>draw_background(hDC);

<sp/>//вывести надпись тетрис
<sp/><sp/>const<sp/>CHAR<sp/>tetris[]<sp/>=<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;###<sp/>###<sp/>###<sp/>###<sp/>#<sp/><sp/><sp/>#<sp/>###\n&quot;\
<sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/>#<sp/>#<sp/><sp/>##<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>###<sp/>#<sp/>#<sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>##<sp/><sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>#<sp/><sp/><sp/>#<sp/>###&quot;
<sp/><sp/><sp/><sp/>};

<sp/><sp/><sp/><sp/>const<sp/>int<sp/>csize<sp/>=<sp/>18;
<sp/><sp/>int<sp/><sp/><sp/><sp/>x<sp/>=<sp/>0,<sp/>y<sp/>=<sp/>0,<sp/>px<sp/>=<sp/>csize<sp/>-<sp/>4,<sp/>py<sp/>=<sp/>csize<sp/>*<sp/>3;
<sp/><sp/><sp/>LPCSTR<sp/>p<sp/>=<sp/>&amp;tetris[0];
<sp/>while(*p){
<sp/><sp/><sp/><sp/><sp/>if(*p<sp/>==<sp/>&apos;#&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(dcbmp-&gt;getDC(),<sp/>px<sp/>+<sp/>x*csize,<sp/>py<sp/>+<sp/>y*csize,<sp/>csize,<sp/>csize,<sp/>0,<sp/>182,<sp/>SRCCOPY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if(*p<sp/>==<sp/>&apos;\n&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++y;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>++p;
<sp/><sp/><sp/>}

<sp/>const<sp/>BYTE<sp/>start[]<sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/>const<sp/>BYTE<sp/>opts[]<sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>17,<sp/>18,<sp/>16,<sp/>14,<sp/>9,<sp/>10,<sp/>0};
<sp/><sp/><sp/>const<sp/>BYTE<sp/>quit[]<sp/><sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>8,<sp/>7,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>27};
<sp/><sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>6,<sp/>start,<sp/>sizeof(start),<sp/>opts,<sp/>sizeof(opts),<sp/>quit,<sp/>sizeof(quit));

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>ctrl[]<sp/>=<sp/>{<sp/>19,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>11,<sp/>5,<sp/>13,<sp/>8,<sp/>5,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>14,<sp/>9};
<sp/>const<sp/>int<sp/>cx<sp/>=<sp/>14;
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ctrl,<sp/>sizeof(ctrl),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(ctrl)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>47,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>BYTE<sp/>help[]<sp/>=<sp/>{<sp/>10,<sp/>11,<sp/>0,<sp/>2,<sp/>8,<sp/>24,<sp/>0,<sp/>77,<sp/>2,<sp/>2,<sp/>5,<sp/>16,<sp/>21,<sp/>77,<sp/>2,<sp/>13,<sp/>8,<sp/>7,<sp/>77,<sp/>2,<sp/>11,<sp/>5,<sp/>2,<sp/>14,<sp/>77,<sp/>2,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>14};
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>help,<sp/>sizeof(help),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(help)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>27,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//----------------------------------------------------------------------------------------------------------------------


void<sp/>tetris::draw_background(HDC<sp/>hDC){
<sp/><sp/>PatBlt(dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>BLACKNESS);
<sp/><sp/><sp/><sp/>bpane.fill(hDC,<sp/>0,<sp/>0,<sp/>PANE_WIDTH,<sp/>dcbmp-&gt;getHeight());
<sp/>bpane.fill(hDC,<sp/>PANE_WIDTH<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>0,<sp/>dcbmp-&gt;getWidth()<sp/>+<sp/>(PANE_WIDTH<sp/>&lt;&lt;<sp/>1)<sp/>+<sp/>1,<sp/>bback-&gt;getHeight());
}


void<sp/>tetris::exec_menu(HWND<sp/>hwnd,<sp/>int<sp/>cmd){
<sp/>if(cmd<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);
<sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>1)<sp/>//диалог<sp/>опции(options)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DialogBoxW((HINSTANCE)GetModuleHandle(NULL),<sp/>MAKEINTRESOURCEW(IDD_OPTIONS),<sp/>hwnd,<sp/>reinterpret_cast&lt;DLGPROC&gt;(&amp;options_proc));
<sp/><sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>2)<sp/>//выход
<sp/><sp/><sp/><sp/><sp/>SendMessage(hwnd,<sp/>WM_CLOSE,<sp/>0,<sp/>0);
}


//перерисовка фигуры
void<sp/>ARGS2_FASTCALL<sp/>tetris::update_figure(HWND<sp/>hwnd){
<sp/><sp/><sp/>const<sp/>int<sp/>m<sp/>=<sp/>CELL_SIZE<sp/>&lt;&lt;<sp/>1;
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>rc.left<sp/><sp/><sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.top<sp/><sp/><sp/><sp/>=<sp/>figure_y<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.right<sp/><sp/>=<sp/>min(rc.left<sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>(m<sp/>&lt;&lt;<sp/>1),<sp/>field_right);<sp/>
<sp/><sp/><sp/><sp/>rc.bottom<sp/>=<sp/>rc.top<sp/><sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>m;
<sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


//добавление<sp/>очков
void<sp/>tetris::score_add(int<sp/>n){
<sp/>if(n<sp/>&gt;<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/>score<sp/>+=<sp/>(n<sp/>==<sp/>1)<sp/>?<sp/>10UL<sp/>:<sp/>static_cast&lt;DWORD&gt;(n)*15UL;
}


//проверка<sp/>на<sp/>проигрыш
bool<sp/>tetris::is_game_over(void){
<sp/><sp/>int<sp/>j<sp/>=<sp/>0;
<sp/>while((j<sp/>&lt;<sp/>FIELD_COLS)<sp/>&amp;&amp;<sp/>(field[0][j]<sp/>==<sp/>BLOCK_NONE))
<sp/><sp/><sp/><sp/><sp/>++j;
<sp/><sp/><sp/>return<sp/>(j<sp/>&lt;<sp/>FIELD_COLS);
}


//вывод кнопок
void<sp/>tetris::draw_buttons(HDC<sp/>hDC,<sp/>int<sp/>num,...){
<sp/>const<sp/>BYTE*<sp/>pb;
<sp/><sp/><sp/><sp/>UINT<sp/><sp/><sp/><sp/>nb;
<sp/><sp/><sp/><sp/>int<sp/><sp/><sp/><sp/><sp/>x,<sp/>p<sp/>=<sp/>0;
<sp/><sp/>RECT<sp/><sp/><sp/><sp/>rc;
<sp/><sp/><sp/><sp/>va_list<sp/>lst;
<sp/><sp/><sp/>va_start(lst,<sp/>num);
<sp/><sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>i<sp/>+=<sp/>2,<sp/>++p){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>p*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>pb<sp/>=<sp/>va_arg(lst,<sp/>const<sp/>BYTE*);
<sp/><sp/><sp/><sp/><sp/>nb<sp/>=<sp/>va_arg(lst,<sp/>UINT);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/><sp/>=<sp/>(p<sp/>==<sp/>sel_cmd)<sp/>?<sp/>89<sp/>:<sp/>21;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>rc.left,<sp/>rc.top,<sp/>rc.right<sp/>-<sp/>rc.left,<sp/>rc.bottom<sp/>-<sp/>rc.top,<sp/>x,<sp/>184,<sp/>69,<sp/>33,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/><sp/><sp/>fnt.draw(hDC,<sp/>pb,<sp/>nb,<sp/>rc.left<sp/>+<sp/>((rc.right<sp/>-<sp/>rc.left)<sp/>-<sp/>static_cast&lt;int&gt;(nb)*fnt.getWidth())/2,<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rc.top<sp/>+<sp/>((rc.bottom<sp/>-<sp/>rc.top)<sp/>-<sp/>fnt.getHeight())/2);
<sp/>}
<sp/><sp/>va_end(lst);
}


void<sp/>ARGS2_FASTCALL<sp/>tetris::set_rect(LPRECT<sp/>prc,<sp/>int<sp/>top){
<sp/><sp/><sp/><sp/>SetRect(prc,<sp/>20,<sp/>250<sp/>+<sp/>top,<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20,<sp/>300<sp/>+<sp/>top);
}


int<sp/>tetris::control_menu(HWND<sp/>hwnd,<sp/>WORD<sp/>key,<sp/>int<sp/>num){
<sp/><sp/><sp/><sp/>switch(key){
<sp/><sp/><sp/>case<sp/>VK_UP:
<sp/><sp/><sp/><sp/>case<sp/>&apos;W&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&gt;<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_DOWN:
<sp/><sp/>case<sp/>&apos;S&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&lt;<sp/>(num<sp/>-<sp/>1)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_RETURN:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>sel_cmd;
<sp/><sp/><sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


void<sp/>tetris::update_menu(HWND<sp/>hwnd){
<sp/><sp/><sp/><sp/>RECT<sp/>rc<sp/>=<sp/>{<sp/>offset_m,<sp/>240,<sp/>offset_m<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>2<sp/>};
<sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


void<sp/>tetris::set_state(HWND<sp/>hwnd,<sp/>e_state_game<sp/>st){
<sp/><sp/><sp/>sel_cmd<sp/>=<sp/>0;
<sp/><sp/><sp/>state<sp/><sp/><sp/>=<sp/>st;
<sp/><sp/>InvalidateRect(hwnd,<sp/>NULL,<sp/>TRUE);
}


int<sp/>tetris::move_button(int<sp/>x,<sp/>int<sp/>y,<sp/>int<sp/>num){
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>i*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>OffsetRect(&amp;rc,<sp/>offset_m,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/>if((x<sp/>&gt;<sp/>rc.left<sp/>&amp;&amp;<sp/>x<sp/>&lt;<sp/>rc.right)<sp/>&amp;&amp;<sp/>(y<sp/>&gt;<sp/>rc.top<sp/>&amp;&amp;<sp/>y<sp/>&lt;<sp/>rc.bottom))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>i;
<sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


//обработчик<sp/>диалога
static<sp/>LRESULT<sp/>CALLBACK<sp/>options_proc(HWND<sp/>hwnd,<sp/>UINT<sp/>msg,<sp/>WPARAM<sp/>wParam,<sp/>LPARAM<sp/>lParam){
<sp/><sp/><sp/><sp/>const<sp/>WCHAR<sp/>vel1[]<sp/>=<sp/>{<sp/>0x41F,0x435,0x440,0x432,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel2[]<sp/>=<sp/>{<sp/>0x412,0x442,0x43E,0x440,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel3[]<sp/>=<sp/>{<sp/>0x422,0x440,0x435,0x442,0x44C,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};

<sp/>switch(msg){
<sp/><sp/><sp/>case<sp/>WM_INITDIALOG:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel1);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel2);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel3);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_SETCURSEL,<sp/>(WPARAM)(g_velocity<sp/>-<sp/>1),<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_SETCHECK,<sp/>(g_audio)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_SETCHECK,<sp/>(!g_repeat)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/>return<sp/>1;
<sp/><sp/>case<sp/>WM_COMMAND:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch(LOWORD(wParam)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_OK:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_velocity<sp/>=<sp/>(int)SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_GETCURSEL,<sp/>0,<sp/>0)<sp/>+<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_audio<sp/><sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/><sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>TRUE<sp/><sp/>:<sp/>FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_repeat<sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>FALSE<sp/>:<sp/>TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_CANCEL:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>WM_CLOSE:
<sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
<sp/><sp/>return<sp/>0;
}
</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="395"><highlight class="normal"></highlight></codeline>
<codeline lineno="396"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(is_game_over()){<sp/></highlight><highlight class="comment">//вы<sp/>проиграли <sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_OVER);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>figure_put_field(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field);

<sp/><sp/><sp/><sp/><sp/><sp/>bool<sp/>ok<sp/>=<sp/>field_remove(field,<sp/>false,<sp/>&amp;booms);
<sp/><sp/><sp/><sp/><sp/><sp/>score_add(booms.getSize());
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>put_rand_figure(hwnd);
<sp/><sp/><sp/><sp/><sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(ok){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>time_boom<sp/>=<sp/>tick<sp/>+<sp/>TIME_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/><sp/><sp/><sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_boom.play(&amp;g_audio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_stop.play(&amp;g_audio);
<sp/><sp/><sp/>}
}


//вывод игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_game(HDC<sp/>hDC){
<sp/><sp/>int<sp/>i,<sp/>j,<sp/>box;
<sp/>bback-&gt;draw(hDC,<sp/>0,<sp/>0,<sp/>field_left,<sp/>dcbmp-&gt;getHeight());
<sp/><sp/><sp/><sp/>bback-&gt;draw(hDC,<sp/>field_right,<sp/>bnextf-&gt;getHeight(),<sp/>bback-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>bnextf-&gt;getHeight()<sp/>-<sp/>CTRL_HEIGHT);
<sp/><sp/><sp/><sp/>dcbmp-&gt;draw(bfill);

<sp/><sp/><sp/>//здесь выводим
<sp/><sp/><sp/>HDC<sp/>hdc<sp/>=<sp/>dcbmp-&gt;getDC();

<sp/>//вывод фигуры
<sp/><sp/><sp/>int<sp/>px<sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE;
<sp/>int<sp/>py<sp/>=<sp/>figure_y;
<sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>figure.size;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>for(j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>figure.size;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(figure.figure[i][j]<sp/>!=<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>px<sp/>+<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>py<sp/>+<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>figure.figure[i][j]<sp/>-<sp/>1,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>//вывод блоков
<sp/><sp/><sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>FIELD_ROWS;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>for(j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>FIELD_COLS;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if((box<sp/>=<sp/>field[i][j])<sp/>==<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>continue;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(box<sp/>&lt;=<sp/>BLOCK_C)<sp/>//неподвижные блоки
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>1,<sp/>CELL_SIZE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else//блоки которые для<sp/>взрыва
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>BLOCK_BOOM<sp/>-<sp/>1,<sp/>CELL_OFFSET_BOOM);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>//вывод &quot;взрыва&quot;
<sp/>boom_row*<sp/>p;
<sp/><sp/><sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>booms.getSize();<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>p<sp/>=<sp/>&amp;booms[i];
<sp/><sp/><sp/><sp/><sp/>if(p-&gt;dir<sp/>==<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>+=<sp/>VELOCITY_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(boom_x<sp/>&gt;=<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>20)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>-=<sp/>VELOCITY_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(boom_x<sp/>&lt;<sp/>20){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>20;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hdc,<sp/>boom_x,<sp/>p-&gt;pos,<sp/>20,<sp/>20,<sp/>0,<sp/>200,<sp/>SRCPAINT);
<sp/><sp/><sp/>}

<sp/>BitBlt(hDC,<sp/>field_left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>hdc,<sp/>0,<sp/>0,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/>bnextf-&gt;draw(hDC,<sp/>field_right,<sp/>0,<sp/>NEXTF_WIDTH,<sp/>NEXTF_HEIGHT,<sp/>0,<sp/>0);
<sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>field_right,<sp/>size.cy<sp/>-<sp/>CTRL_HEIGHT,<sp/>NEXTF_WIDTH,<sp/>CTRL_HEIGHT,<sp/>0,<sp/>220);
}


//вывод проигрыша
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_over(HDC<sp/>hDC){
<sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>game[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>77,<sp/>15,<sp/>16,<sp/>14,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>11,<sp/>8,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>19};
<sp/><sp/><sp/><sp/>const<sp/>int<sp/><sp/><sp/><sp/><sp/>fsz<sp/>=<sp/>24;
<sp/><sp/><sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>game,<sp/>sizeof(game),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(game)))/2,<sp/>100,<sp/>fsz,<sp/>28,<sp/>SRCPAINT);

<sp/><sp/>const<sp/>BYTE<sp/>ply[]<sp/><sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>7,<sp/>0,<sp/>13,<sp/>14,<sp/>2,<sp/>14};
<sp/>const<sp/>BYTE<sp/>title[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>2,<sp/>77,<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>11,<sp/>14};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>ply,<sp/>sizeof(ply),<sp/>title,<sp/>sizeof(title));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод паузы
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_pause(HDC<sp/>hDC){
<sp/><sp/><sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>ps[]<sp/>=<sp/>{<sp/>15,<sp/>0,<sp/>19,<sp/>7,<sp/>0};
<sp/><sp/>const<sp/>int<sp/><sp/><sp/>fsz<sp/>=<sp/>32;
<sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ps,<sp/>sizeof(ps),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(ps)))/2,<sp/>100,<sp/>fsz,<sp/>34,<sp/>SRCPAINT);

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>cns[]<sp/>=<sp/>{<sp/>15,<sp/>16,<sp/>14,<sp/>4,<sp/>14,<sp/>11,<sp/>6,<sp/>8,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>exs[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>21,<sp/>14,<sp/>4,<sp/>77,<sp/>2,<sp/>77,<sp/>12,<sp/>5,<sp/>13,<sp/>30};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>cns,<sp/>sizeof(cns),<sp/>exs,<sp/>sizeof(exs));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод меню<sp/>игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_menu(HDC<sp/>hDC){
<sp/>draw_background(hDC);

<sp/>//вывести надпись тетрис
<sp/><sp/>const<sp/>CHAR<sp/>tetris[]<sp/>=<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;###<sp/>###<sp/>###<sp/>###<sp/>#<sp/><sp/><sp/>#<sp/>###\n&quot;\
<sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/>#<sp/>#<sp/><sp/>##<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>###<sp/>#<sp/>#<sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>##<sp/><sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>#<sp/><sp/><sp/>#<sp/>###&quot;
<sp/><sp/><sp/><sp/>};

<sp/><sp/><sp/><sp/>const<sp/>int<sp/>csize<sp/>=<sp/>18;
<sp/><sp/>int<sp/><sp/><sp/><sp/>x<sp/>=<sp/>0,<sp/>y<sp/>=<sp/>0,<sp/>px<sp/>=<sp/>csize<sp/>-<sp/>4,<sp/>py<sp/>=<sp/>csize<sp/>*<sp/>3;
<sp/><sp/><sp/>LPCSTR<sp/>p<sp/>=<sp/>&amp;tetris[0];
<sp/>while(*p){
<sp/><sp/><sp/><sp/><sp/>if(*p<sp/>==<sp/>&apos;#&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(dcbmp-&gt;getDC(),<sp/>px<sp/>+<sp/>x*csize,<sp/>py<sp/>+<sp/>y*csize,<sp/>csize,<sp/>csize,<sp/>0,<sp/>182,<sp/>SRCCOPY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if(*p<sp/>==<sp/>&apos;\n&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++y;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>++p;
<sp/><sp/><sp/>}

<sp/>const<sp/>BYTE<sp/>start[]<sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/>const<sp/>BYTE<sp/>opts[]<sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>17,<sp/>18,<sp/>16,<sp/>14,<sp/>9,<sp/>10,<sp/>0};
<sp/><sp/><sp/>const<sp/>BYTE<sp/>quit[]<sp/><sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>8,<sp/>7,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>27};
<sp/><sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>6,<sp/>start,<sp/>sizeof(start),<sp/>opts,<sp/>sizeof(opts),<sp/>quit,<sp/>sizeof(quit));

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>ctrl[]<sp/>=<sp/>{<sp/>19,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>11,<sp/>5,<sp/>13,<sp/>8,<sp/>5,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>14,<sp/>9};
<sp/>const<sp/>int<sp/>cx<sp/>=<sp/>14;
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ctrl,<sp/>sizeof(ctrl),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(ctrl)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>47,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>BYTE<sp/>help[]<sp/>=<sp/>{<sp/>10,<sp/>11,<sp/>0,<sp/>2,<sp/>8,<sp/>24,<sp/>0,<sp/>77,<sp/>2,<sp/>2,<sp/>5,<sp/>16,<sp/>21,<sp/>77,<sp/>2,<sp/>13,<sp/>8,<sp/>7,<sp/>77,<sp/>2,<sp/>11,<sp/>5,<sp/>2,<sp/>14,<sp/>77,<sp/>2,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>14};
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>help,<sp/>sizeof(help),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(help)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>27,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//----------------------------------------------------------------------------------------------------------------------


void<sp/>tetris::draw_background(HDC<sp/>hDC){
<sp/><sp/>PatBlt(dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>BLACKNESS);
<sp/><sp/><sp/><sp/>bpane.fill(hDC,<sp/>0,<sp/>0,<sp/>PANE_WIDTH,<sp/>dcbmp-&gt;getHeight());
<sp/>bpane.fill(hDC,<sp/>PANE_WIDTH<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>0,<sp/>dcbmp-&gt;getWidth()<sp/>+<sp/>(PANE_WIDTH<sp/>&lt;&lt;<sp/>1)<sp/>+<sp/>1,<sp/>bback-&gt;getHeight());
}


void<sp/>tetris::exec_menu(HWND<sp/>hwnd,<sp/>int<sp/>cmd){
<sp/>if(cmd<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);
<sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>1)<sp/>//диалог<sp/>опции(options)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DialogBoxW((HINSTANCE)GetModuleHandle(NULL),<sp/>MAKEINTRESOURCEW(IDD_OPTIONS),<sp/>hwnd,<sp/>reinterpret_cast&lt;DLGPROC&gt;(&amp;options_proc));
<sp/><sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>2)<sp/>//выход
<sp/><sp/><sp/><sp/><sp/>SendMessage(hwnd,<sp/>WM_CLOSE,<sp/>0,<sp/>0);
}


//перерисовка фигуры
void<sp/>ARGS2_FASTCALL<sp/>tetris::update_figure(HWND<sp/>hwnd){
<sp/><sp/><sp/>const<sp/>int<sp/>m<sp/>=<sp/>CELL_SIZE<sp/>&lt;&lt;<sp/>1;
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>rc.left<sp/><sp/><sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.top<sp/><sp/><sp/><sp/>=<sp/>figure_y<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.right<sp/><sp/>=<sp/>min(rc.left<sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>(m<sp/>&lt;&lt;<sp/>1),<sp/>field_right);<sp/>
<sp/><sp/><sp/><sp/>rc.bottom<sp/>=<sp/>rc.top<sp/><sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>m;
<sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


//добавление<sp/>очков
void<sp/>tetris::score_add(int<sp/>n){
<sp/>if(n<sp/>&gt;<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/>score<sp/>+=<sp/>(n<sp/>==<sp/>1)<sp/>?<sp/>10UL<sp/>:<sp/>static_cast&lt;DWORD&gt;(n)*15UL;
}


//проверка<sp/>на<sp/>проигрыш
bool<sp/>tetris::is_game_over(void){
<sp/><sp/>int<sp/>j<sp/>=<sp/>0;
<sp/>while((j<sp/>&lt;<sp/>FIELD_COLS)<sp/>&amp;&amp;<sp/>(field[0][j]<sp/>==<sp/>BLOCK_NONE))
<sp/><sp/><sp/><sp/><sp/>++j;
<sp/><sp/><sp/>return<sp/>(j<sp/>&lt;<sp/>FIELD_COLS);
}


//вывод кнопок
void<sp/>tetris::draw_buttons(HDC<sp/>hDC,<sp/>int<sp/>num,...){
<sp/>const<sp/>BYTE*<sp/>pb;
<sp/><sp/><sp/><sp/>UINT<sp/><sp/><sp/><sp/>nb;
<sp/><sp/><sp/><sp/>int<sp/><sp/><sp/><sp/><sp/>x,<sp/>p<sp/>=<sp/>0;
<sp/><sp/>RECT<sp/><sp/><sp/><sp/>rc;
<sp/><sp/><sp/><sp/>va_list<sp/>lst;
<sp/><sp/><sp/>va_start(lst,<sp/>num);
<sp/><sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>i<sp/>+=<sp/>2,<sp/>++p){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>p*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>pb<sp/>=<sp/>va_arg(lst,<sp/>const<sp/>BYTE*);
<sp/><sp/><sp/><sp/><sp/>nb<sp/>=<sp/>va_arg(lst,<sp/>UINT);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/><sp/>=<sp/>(p<sp/>==<sp/>sel_cmd)<sp/>?<sp/>89<sp/>:<sp/>21;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>rc.left,<sp/>rc.top,<sp/>rc.right<sp/>-<sp/>rc.left,<sp/>rc.bottom<sp/>-<sp/>rc.top,<sp/>x,<sp/>184,<sp/>69,<sp/>33,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/><sp/><sp/>fnt.draw(hDC,<sp/>pb,<sp/>nb,<sp/>rc.left<sp/>+<sp/>((rc.right<sp/>-<sp/>rc.left)<sp/>-<sp/>static_cast&lt;int&gt;(nb)*fnt.getWidth())/2,<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rc.top<sp/>+<sp/>((rc.bottom<sp/>-<sp/>rc.top)<sp/>-<sp/>fnt.getHeight())/2);
<sp/>}
<sp/><sp/>va_end(lst);
}


void<sp/>ARGS2_FASTCALL<sp/>tetris::set_rect(LPRECT<sp/>prc,<sp/>int<sp/>top){
<sp/><sp/><sp/><sp/>SetRect(prc,<sp/>20,<sp/>250<sp/>+<sp/>top,<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20,<sp/>300<sp/>+<sp/>top);
}


int<sp/>tetris::control_menu(HWND<sp/>hwnd,<sp/>WORD<sp/>key,<sp/>int<sp/>num){
<sp/><sp/><sp/><sp/>switch(key){
<sp/><sp/><sp/>case<sp/>VK_UP:
<sp/><sp/><sp/><sp/>case<sp/>&apos;W&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&gt;<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_DOWN:
<sp/><sp/>case<sp/>&apos;S&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&lt;<sp/>(num<sp/>-<sp/>1)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_RETURN:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>sel_cmd;
<sp/><sp/><sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


void<sp/>tetris::update_menu(HWND<sp/>hwnd){
<sp/><sp/><sp/><sp/>RECT<sp/>rc<sp/>=<sp/>{<sp/>offset_m,<sp/>240,<sp/>offset_m<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>2<sp/>};
<sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


void<sp/>tetris::set_state(HWND<sp/>hwnd,<sp/>e_state_game<sp/>st){
<sp/><sp/><sp/>sel_cmd<sp/>=<sp/>0;
<sp/><sp/><sp/>state<sp/><sp/><sp/>=<sp/>st;
<sp/><sp/>InvalidateRect(hwnd,<sp/>NULL,<sp/>TRUE);
}


int<sp/>tetris::move_button(int<sp/>x,<sp/>int<sp/>y,<sp/>int<sp/>num){
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>i*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>OffsetRect(&amp;rc,<sp/>offset_m,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/>if((x<sp/>&gt;<sp/>rc.left<sp/>&amp;&amp;<sp/>x<sp/>&lt;<sp/>rc.right)<sp/>&amp;&amp;<sp/>(y<sp/>&gt;<sp/>rc.top<sp/>&amp;&amp;<sp/>y<sp/>&lt;<sp/>rc.bottom))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>i;
<sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


//обработчик<sp/>диалога
static<sp/>LRESULT<sp/>CALLBACK<sp/>options_proc(HWND<sp/>hwnd,<sp/>UINT<sp/>msg,<sp/>WPARAM<sp/>wParam,<sp/>LPARAM<sp/>lParam){
<sp/><sp/><sp/><sp/>const<sp/>WCHAR<sp/>vel1[]<sp/>=<sp/>{<sp/>0x41F,0x435,0x440,0x432,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel2[]<sp/>=<sp/>{<sp/>0x412,0x442,0x43E,0x440,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel3[]<sp/>=<sp/>{<sp/>0x422,0x440,0x435,0x442,0x44C,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};

<sp/>switch(msg){
<sp/><sp/><sp/>case<sp/>WM_INITDIALOG:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel1);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel2);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel3);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_SETCURSEL,<sp/>(WPARAM)(g_velocity<sp/>-<sp/>1),<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_SETCHECK,<sp/>(g_audio)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_SETCHECK,<sp/>(!g_repeat)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/>return<sp/>1;
<sp/><sp/>case<sp/>WM_COMMAND:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch(LOWORD(wParam)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_OK:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_velocity<sp/>=<sp/>(int)SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_GETCURSEL,<sp/>0,<sp/>0)<sp/>+<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_audio<sp/><sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/><sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>TRUE<sp/><sp/>:<sp/>FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_repeat<sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>FALSE<sp/>:<sp/>TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_CANCEL:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>WM_CLOSE:
<sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
<sp/><sp/>return<sp/>0;
}
</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="397"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_state(hwnd,<sp/>GAME_OVER);</highlight></codeline>
<codeline lineno="398"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="399"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="400"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_8cpp_1ae34222375b8a6a2a7d1a129489e2c5ac" kindref="member">figure_put_field</ref>(figure_x,<sp/>figure_y,<sp/>figure,<sp/>field);</highlight></codeline>
<codeline lineno="401"><highlight class="normal"></highlight></codeline>
<codeline lineno="402"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>ok<sp/>=<sp/><ref refid="util_8cpp_1a107f39dc6ef15cff3e411955f9cb1088" kindref="member">field_remove</ref>(field,<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">,<sp/>&amp;booms);</highlight></codeline>
<codeline lineno="403"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>score_add(booms.getSize());</highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>put_rand_figure(hwnd);</highlight></codeline>
<codeline lineno="405"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="406"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(ok){</highlight></codeline>
<codeline lineno="407"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>time_boom<sp/>=<sp/>tick<sp/>+<sp/>TIME_BOOM;</highlight></codeline>
<codeline lineno="408"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/><sp/><sp/><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="409"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_boom.play(&amp;g_audio);</highlight></codeline>
<codeline lineno="410"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snd_stop.play(&amp;g_audio);</highlight></codeline>
<codeline lineno="412"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="413"><highlight class="normal">}</highlight></codeline>
<codeline lineno="414"><highlight class="normal"></highlight></codeline>
<codeline lineno="415"><highlight class="normal"></highlight></codeline>
<codeline lineno="416"><highlight class="normal"></highlight><highlight class="comment">//вывод игры</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="417"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ARGS2_FASTCALL<sp/>tetris::draw_game(<ref refid="main_8cpp_1a296475d8e990aad6b442b8b669315f5e" kindref="member">HDC</ref><sp/>hDC){</highlight></codeline>
<codeline lineno="418"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i,<sp/>j,<sp/>box;</highlight></codeline>
<codeline lineno="419"><highlight class="normal"><sp/><sp/><sp/><sp/>bback-&gt;draw(hDC,<sp/>0,<sp/>0,<sp/>field_left,<sp/>dcbmp-&gt;getHeight());</highlight></codeline>
<codeline lineno="420"><highlight class="normal"><sp/><sp/><sp/><sp/>bback-&gt;draw(hDC,<sp/>field_right,<sp/>bnextf-&gt;getHeight(),<sp/>bback-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>bnextf-&gt;getHeight()<sp/>-<sp/>CTRL_HEIGHT);</highlight></codeline>
<codeline lineno="421"><highlight class="normal"><sp/><sp/><sp/><sp/>dcbmp-&gt;draw(bfill);</highlight></codeline>
<codeline lineno="422"><highlight class="normal"></highlight></codeline>
<codeline lineno="423"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//здесь выводим <sp/><sp/><sp/>HDC<sp/>hdc<sp/>=<sp/>dcbmp-&gt;getDC();

<sp/>//вывод фигуры
<sp/><sp/><sp/>int<sp/>px<sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE;
<sp/>int<sp/>py<sp/>=<sp/>figure_y;
<sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>figure.size;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>for(j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>figure.size;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(figure.figure[i][j]<sp/>!=<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>px<sp/>+<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>py<sp/>+<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>figure.figure[i][j]<sp/>-<sp/>1,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>//вывод блоков
<sp/><sp/><sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>FIELD_ROWS;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>for(j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>FIELD_COLS;<sp/>++j){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if((box<sp/>=<sp/>field[i][j])<sp/>==<sp/>BLOCK_NONE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>continue;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(box<sp/>&lt;=<sp/>BLOCK_C)<sp/>//неподвижные блоки
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>1,<sp/>CELL_SIZE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else//блоки которые для<sp/>взрыва
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>BLOCK_BOOM<sp/>-<sp/>1,<sp/>CELL_OFFSET_BOOM);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>//вывод &quot;взрыва&quot;
<sp/>boom_row*<sp/>p;
<sp/><sp/><sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>booms.getSize();<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>p<sp/>=<sp/>&amp;booms[i];
<sp/><sp/><sp/><sp/><sp/>if(p-&gt;dir<sp/>==<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>+=<sp/>VELOCITY_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(boom_x<sp/>&gt;=<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>20)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>-=<sp/>VELOCITY_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(boom_x<sp/>&lt;<sp/>20){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>20;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hdc,<sp/>boom_x,<sp/>p-&gt;pos,<sp/>20,<sp/>20,<sp/>0,<sp/>200,<sp/>SRCPAINT);
<sp/><sp/><sp/>}

<sp/>BitBlt(hDC,<sp/>field_left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>hdc,<sp/>0,<sp/>0,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/>bnextf-&gt;draw(hDC,<sp/>field_right,<sp/>0,<sp/>NEXTF_WIDTH,<sp/>NEXTF_HEIGHT,<sp/>0,<sp/>0);
<sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>field_right,<sp/>size.cy<sp/>-<sp/>CTRL_HEIGHT,<sp/>NEXTF_WIDTH,<sp/>CTRL_HEIGHT,<sp/>0,<sp/>220);
}


//вывод проигрыша
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_over(HDC<sp/>hDC){
<sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>game[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>77,<sp/>15,<sp/>16,<sp/>14,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>11,<sp/>8,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>19};
<sp/><sp/><sp/><sp/>const<sp/>int<sp/><sp/><sp/><sp/><sp/>fsz<sp/>=<sp/>24;
<sp/><sp/><sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>game,<sp/>sizeof(game),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(game)))/2,<sp/>100,<sp/>fsz,<sp/>28,<sp/>SRCPAINT);

<sp/><sp/>const<sp/>BYTE<sp/>ply[]<sp/><sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>7,<sp/>0,<sp/>13,<sp/>14,<sp/>2,<sp/>14};
<sp/>const<sp/>BYTE<sp/>title[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>2,<sp/>77,<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>11,<sp/>14};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>ply,<sp/>sizeof(ply),<sp/>title,<sp/>sizeof(title));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод паузы
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_pause(HDC<sp/>hDC){
<sp/><sp/><sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>ps[]<sp/>=<sp/>{<sp/>15,<sp/>0,<sp/>19,<sp/>7,<sp/>0};
<sp/><sp/>const<sp/>int<sp/><sp/><sp/>fsz<sp/>=<sp/>32;
<sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ps,<sp/>sizeof(ps),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(ps)))/2,<sp/>100,<sp/>fsz,<sp/>34,<sp/>SRCPAINT);

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>cns[]<sp/>=<sp/>{<sp/>15,<sp/>16,<sp/>14,<sp/>4,<sp/>14,<sp/>11,<sp/>6,<sp/>8,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>exs[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>21,<sp/>14,<sp/>4,<sp/>77,<sp/>2,<sp/>77,<sp/>12,<sp/>5,<sp/>13,<sp/>30};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>cns,<sp/>sizeof(cns),<sp/>exs,<sp/>sizeof(exs));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод меню<sp/>игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_menu(HDC<sp/>hDC){
<sp/>draw_background(hDC);

<sp/>//вывести надпись тетрис
<sp/><sp/>const<sp/>CHAR<sp/>tetris[]<sp/>=<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;###<sp/>###<sp/>###<sp/>###<sp/>#<sp/><sp/><sp/>#<sp/>###\n&quot;\
<sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/>#<sp/>#<sp/><sp/>##<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>###<sp/>#<sp/>#<sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>##<sp/><sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>#<sp/><sp/><sp/>#<sp/>###&quot;
<sp/><sp/><sp/><sp/>};

<sp/><sp/><sp/><sp/>const<sp/>int<sp/>csize<sp/>=<sp/>18;
<sp/><sp/>int<sp/><sp/><sp/><sp/>x<sp/>=<sp/>0,<sp/>y<sp/>=<sp/>0,<sp/>px<sp/>=<sp/>csize<sp/>-<sp/>4,<sp/>py<sp/>=<sp/>csize<sp/>*<sp/>3;
<sp/><sp/><sp/>LPCSTR<sp/>p<sp/>=<sp/>&amp;tetris[0];
<sp/>while(*p){
<sp/><sp/><sp/><sp/><sp/>if(*p<sp/>==<sp/>&apos;#&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(dcbmp-&gt;getDC(),<sp/>px<sp/>+<sp/>x*csize,<sp/>py<sp/>+<sp/>y*csize,<sp/>csize,<sp/>csize,<sp/>0,<sp/>182,<sp/>SRCCOPY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if(*p<sp/>==<sp/>&apos;\n&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++y;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>++p;
<sp/><sp/><sp/>}

<sp/>const<sp/>BYTE<sp/>start[]<sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/>const<sp/>BYTE<sp/>opts[]<sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>17,<sp/>18,<sp/>16,<sp/>14,<sp/>9,<sp/>10,<sp/>0};
<sp/><sp/><sp/>const<sp/>BYTE<sp/>quit[]<sp/><sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>8,<sp/>7,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>27};
<sp/><sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>6,<sp/>start,<sp/>sizeof(start),<sp/>opts,<sp/>sizeof(opts),<sp/>quit,<sp/>sizeof(quit));

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>ctrl[]<sp/>=<sp/>{<sp/>19,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>11,<sp/>5,<sp/>13,<sp/>8,<sp/>5,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>14,<sp/>9};
<sp/>const<sp/>int<sp/>cx<sp/>=<sp/>14;
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ctrl,<sp/>sizeof(ctrl),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(ctrl)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>47,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>BYTE<sp/>help[]<sp/>=<sp/>{<sp/>10,<sp/>11,<sp/>0,<sp/>2,<sp/>8,<sp/>24,<sp/>0,<sp/>77,<sp/>2,<sp/>2,<sp/>5,<sp/>16,<sp/>21,<sp/>77,<sp/>2,<sp/>13,<sp/>8,<sp/>7,<sp/>77,<sp/>2,<sp/>11,<sp/>5,<sp/>2,<sp/>14,<sp/>77,<sp/>2,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>14};
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>help,<sp/>sizeof(help),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(help)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>27,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//----------------------------------------------------------------------------------------------------------------------


void<sp/>tetris::draw_background(HDC<sp/>hDC){
<sp/><sp/>PatBlt(dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>BLACKNESS);
<sp/><sp/><sp/><sp/>bpane.fill(hDC,<sp/>0,<sp/>0,<sp/>PANE_WIDTH,<sp/>dcbmp-&gt;getHeight());
<sp/>bpane.fill(hDC,<sp/>PANE_WIDTH<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>0,<sp/>dcbmp-&gt;getWidth()<sp/>+<sp/>(PANE_WIDTH<sp/>&lt;&lt;<sp/>1)<sp/>+<sp/>1,<sp/>bback-&gt;getHeight());
}


void<sp/>tetris::exec_menu(HWND<sp/>hwnd,<sp/>int<sp/>cmd){
<sp/>if(cmd<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);
<sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>1)<sp/>//диалог<sp/>опции(options)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DialogBoxW((HINSTANCE)GetModuleHandle(NULL),<sp/>MAKEINTRESOURCEW(IDD_OPTIONS),<sp/>hwnd,<sp/>reinterpret_cast&lt;DLGPROC&gt;(&amp;options_proc));
<sp/><sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>2)<sp/>//выход
<sp/><sp/><sp/><sp/><sp/>SendMessage(hwnd,<sp/>WM_CLOSE,<sp/>0,<sp/>0);
}


//перерисовка фигуры
void<sp/>ARGS2_FASTCALL<sp/>tetris::update_figure(HWND<sp/>hwnd){
<sp/><sp/><sp/>const<sp/>int<sp/>m<sp/>=<sp/>CELL_SIZE<sp/>&lt;&lt;<sp/>1;
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>rc.left<sp/><sp/><sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.top<sp/><sp/><sp/><sp/>=<sp/>figure_y<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.right<sp/><sp/>=<sp/>min(rc.left<sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>(m<sp/>&lt;&lt;<sp/>1),<sp/>field_right);<sp/>
<sp/><sp/><sp/><sp/>rc.bottom<sp/>=<sp/>rc.top<sp/><sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>m;
<sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


//добавление<sp/>очков
void<sp/>tetris::score_add(int<sp/>n){
<sp/>if(n<sp/>&gt;<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/>score<sp/>+=<sp/>(n<sp/>==<sp/>1)<sp/>?<sp/>10UL<sp/>:<sp/>static_cast&lt;DWORD&gt;(n)*15UL;
}


//проверка<sp/>на<sp/>проигрыш
bool<sp/>tetris::is_game_over(void){
<sp/><sp/>int<sp/>j<sp/>=<sp/>0;
<sp/>while((j<sp/>&lt;<sp/>FIELD_COLS)<sp/>&amp;&amp;<sp/>(field[0][j]<sp/>==<sp/>BLOCK_NONE))
<sp/><sp/><sp/><sp/><sp/>++j;
<sp/><sp/><sp/>return<sp/>(j<sp/>&lt;<sp/>FIELD_COLS);
}


//вывод кнопок
void<sp/>tetris::draw_buttons(HDC<sp/>hDC,<sp/>int<sp/>num,...){
<sp/>const<sp/>BYTE*<sp/>pb;
<sp/><sp/><sp/><sp/>UINT<sp/><sp/><sp/><sp/>nb;
<sp/><sp/><sp/><sp/>int<sp/><sp/><sp/><sp/><sp/>x,<sp/>p<sp/>=<sp/>0;
<sp/><sp/>RECT<sp/><sp/><sp/><sp/>rc;
<sp/><sp/><sp/><sp/>va_list<sp/>lst;
<sp/><sp/><sp/>va_start(lst,<sp/>num);
<sp/><sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>i<sp/>+=<sp/>2,<sp/>++p){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>p*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>pb<sp/>=<sp/>va_arg(lst,<sp/>const<sp/>BYTE*);
<sp/><sp/><sp/><sp/><sp/>nb<sp/>=<sp/>va_arg(lst,<sp/>UINT);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/><sp/>=<sp/>(p<sp/>==<sp/>sel_cmd)<sp/>?<sp/>89<sp/>:<sp/>21;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>rc.left,<sp/>rc.top,<sp/>rc.right<sp/>-<sp/>rc.left,<sp/>rc.bottom<sp/>-<sp/>rc.top,<sp/>x,<sp/>184,<sp/>69,<sp/>33,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/><sp/><sp/>fnt.draw(hDC,<sp/>pb,<sp/>nb,<sp/>rc.left<sp/>+<sp/>((rc.right<sp/>-<sp/>rc.left)<sp/>-<sp/>static_cast&lt;int&gt;(nb)*fnt.getWidth())/2,<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rc.top<sp/>+<sp/>((rc.bottom<sp/>-<sp/>rc.top)<sp/>-<sp/>fnt.getHeight())/2);
<sp/>}
<sp/><sp/>va_end(lst);
}


void<sp/>ARGS2_FASTCALL<sp/>tetris::set_rect(LPRECT<sp/>prc,<sp/>int<sp/>top){
<sp/><sp/><sp/><sp/>SetRect(prc,<sp/>20,<sp/>250<sp/>+<sp/>top,<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20,<sp/>300<sp/>+<sp/>top);
}


int<sp/>tetris::control_menu(HWND<sp/>hwnd,<sp/>WORD<sp/>key,<sp/>int<sp/>num){
<sp/><sp/><sp/><sp/>switch(key){
<sp/><sp/><sp/>case<sp/>VK_UP:
<sp/><sp/><sp/><sp/>case<sp/>&apos;W&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&gt;<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_DOWN:
<sp/><sp/>case<sp/>&apos;S&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&lt;<sp/>(num<sp/>-<sp/>1)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_RETURN:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>sel_cmd;
<sp/><sp/><sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


void<sp/>tetris::update_menu(HWND<sp/>hwnd){
<sp/><sp/><sp/><sp/>RECT<sp/>rc<sp/>=<sp/>{<sp/>offset_m,<sp/>240,<sp/>offset_m<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>2<sp/>};
<sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


void<sp/>tetris::set_state(HWND<sp/>hwnd,<sp/>e_state_game<sp/>st){
<sp/><sp/><sp/>sel_cmd<sp/>=<sp/>0;
<sp/><sp/><sp/>state<sp/><sp/><sp/>=<sp/>st;
<sp/><sp/>InvalidateRect(hwnd,<sp/>NULL,<sp/>TRUE);
}


int<sp/>tetris::move_button(int<sp/>x,<sp/>int<sp/>y,<sp/>int<sp/>num){
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>i*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>OffsetRect(&amp;rc,<sp/>offset_m,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/>if((x<sp/>&gt;<sp/>rc.left<sp/>&amp;&amp;<sp/>x<sp/>&lt;<sp/>rc.right)<sp/>&amp;&amp;<sp/>(y<sp/>&gt;<sp/>rc.top<sp/>&amp;&amp;<sp/>y<sp/>&lt;<sp/>rc.bottom))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>i;
<sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


//обработчик<sp/>диалога
static<sp/>LRESULT<sp/>CALLBACK<sp/>options_proc(HWND<sp/>hwnd,<sp/>UINT<sp/>msg,<sp/>WPARAM<sp/>wParam,<sp/>LPARAM<sp/>lParam){
<sp/><sp/><sp/><sp/>const<sp/>WCHAR<sp/>vel1[]<sp/>=<sp/>{<sp/>0x41F,0x435,0x440,0x432,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel2[]<sp/>=<sp/>{<sp/>0x412,0x442,0x43E,0x440,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel3[]<sp/>=<sp/>{<sp/>0x422,0x440,0x435,0x442,0x44C,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};

<sp/>switch(msg){
<sp/><sp/><sp/>case<sp/>WM_INITDIALOG:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel1);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel2);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel3);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_SETCURSEL,<sp/>(WPARAM)(g_velocity<sp/>-<sp/>1),<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_SETCHECK,<sp/>(g_audio)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_SETCHECK,<sp/>(!g_repeat)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/>return<sp/>1;
<sp/><sp/>case<sp/>WM_COMMAND:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch(LOWORD(wParam)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_OK:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_velocity<sp/>=<sp/>(int)SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_GETCURSEL,<sp/>0,<sp/>0)<sp/>+<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_audio<sp/><sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/><sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>TRUE<sp/><sp/>:<sp/>FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_repeat<sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>FALSE<sp/>:<sp/>TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_CANCEL:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>WM_CLOSE:
<sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
<sp/><sp/>return<sp/>0;
}
</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="424"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="main_8cpp_1a296475d8e990aad6b442b8b669315f5e" kindref="member">HDC</ref><sp/>hdc<sp/>=<sp/>dcbmp-&gt;getDC();</highlight></codeline>
<codeline lineno="425"><highlight class="normal"></highlight></codeline>
<codeline lineno="426"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//вывод фигуры</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="427"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>px<sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE;</highlight></codeline>
<codeline lineno="428"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>py<sp/>=<sp/>figure_y;</highlight></codeline>
<codeline lineno="429"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>figure.size;<sp/>++i){</highlight></codeline>
<codeline lineno="430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>figure.size;<sp/>++j){</highlight></codeline>
<codeline lineno="431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(figure.figure[i][j]<sp/>!=<sp/>BLOCK_NONE)</highlight></codeline>
<codeline lineno="432"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>px<sp/>+<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>py<sp/>+<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>figure.figure[i][j]<sp/>-<sp/>1,<sp/>0);</highlight></codeline>
<codeline lineno="433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="434"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="435"><highlight class="normal"></highlight></codeline>
<codeline lineno="436"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//вывод блоков</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="437"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>FIELD_ROWS;<sp/>++i){</highlight></codeline>
<codeline lineno="438"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>FIELD_COLS;<sp/>++j){</highlight></codeline>
<codeline lineno="439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">((box<sp/>=<sp/>field[i][j])<sp/>==<sp/>BLOCK_NONE)</highlight></codeline>
<codeline lineno="440"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="441"><highlight class="normal"></highlight></codeline>
<codeline lineno="442"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(box<sp/>&lt;=<sp/>BLOCK_C)<sp/></highlight><highlight class="comment">//неподвижные блоки <sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>1,<sp/>CELL_SIZE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else//блоки которые для<sp/>взрыва
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>BLOCK_BOOM<sp/>-<sp/>1,<sp/>CELL_OFFSET_BOOM);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}

<sp/>//вывод &quot;взрыва&quot;
<sp/>boom_row*<sp/>p;
<sp/><sp/><sp/>for(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>booms.getSize();<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>p<sp/>=<sp/>&amp;booms[i];
<sp/><sp/><sp/><sp/><sp/>if(p-&gt;dir<sp/>==<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>+=<sp/>VELOCITY_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(boom_x<sp/>&gt;=<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>20)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>-=<sp/>VELOCITY_BOOM;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(boom_x<sp/>&lt;<sp/>20){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>20;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hdc,<sp/>boom_x,<sp/>p-&gt;pos,<sp/>20,<sp/>20,<sp/>0,<sp/>200,<sp/>SRCPAINT);
<sp/><sp/><sp/>}

<sp/>BitBlt(hDC,<sp/>field_left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>hdc,<sp/>0,<sp/>0,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/>bnextf-&gt;draw(hDC,<sp/>field_right,<sp/>0,<sp/>NEXTF_WIDTH,<sp/>NEXTF_HEIGHT,<sp/>0,<sp/>0);
<sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>field_right,<sp/>size.cy<sp/>-<sp/>CTRL_HEIGHT,<sp/>NEXTF_WIDTH,<sp/>CTRL_HEIGHT,<sp/>0,<sp/>220);
}


//вывод проигрыша
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_over(HDC<sp/>hDC){
<sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>game[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>77,<sp/>15,<sp/>16,<sp/>14,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>11,<sp/>8,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>19};
<sp/><sp/><sp/><sp/>const<sp/>int<sp/><sp/><sp/><sp/><sp/>fsz<sp/>=<sp/>24;
<sp/><sp/><sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>game,<sp/>sizeof(game),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(game)))/2,<sp/>100,<sp/>fsz,<sp/>28,<sp/>SRCPAINT);

<sp/><sp/>const<sp/>BYTE<sp/>ply[]<sp/><sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>7,<sp/>0,<sp/>13,<sp/>14,<sp/>2,<sp/>14};
<sp/>const<sp/>BYTE<sp/>title[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>2,<sp/>77,<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>11,<sp/>14};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>ply,<sp/>sizeof(ply),<sp/>title,<sp/>sizeof(title));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод паузы
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_pause(HDC<sp/>hDC){
<sp/><sp/><sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>ps[]<sp/>=<sp/>{<sp/>15,<sp/>0,<sp/>19,<sp/>7,<sp/>0};
<sp/><sp/>const<sp/>int<sp/><sp/><sp/>fsz<sp/>=<sp/>32;
<sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ps,<sp/>sizeof(ps),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(ps)))/2,<sp/>100,<sp/>fsz,<sp/>34,<sp/>SRCPAINT);

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>cns[]<sp/>=<sp/>{<sp/>15,<sp/>16,<sp/>14,<sp/>4,<sp/>14,<sp/>11,<sp/>6,<sp/>8,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>exs[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>21,<sp/>14,<sp/>4,<sp/>77,<sp/>2,<sp/>77,<sp/>12,<sp/>5,<sp/>13,<sp/>30};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>cns,<sp/>sizeof(cns),<sp/>exs,<sp/>sizeof(exs));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод меню<sp/>игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_menu(HDC<sp/>hDC){
<sp/>draw_background(hDC);

<sp/>//вывести надпись тетрис
<sp/><sp/>const<sp/>CHAR<sp/>tetris[]<sp/>=<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;###<sp/>###<sp/>###<sp/>###<sp/>#<sp/><sp/><sp/>#<sp/>###\n&quot;\
<sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/>#<sp/>#<sp/><sp/>##<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>###<sp/>#<sp/>#<sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>##<sp/><sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>#<sp/><sp/><sp/>#<sp/>###&quot;
<sp/><sp/><sp/><sp/>};

<sp/><sp/><sp/><sp/>const<sp/>int<sp/>csize<sp/>=<sp/>18;
<sp/><sp/>int<sp/><sp/><sp/><sp/>x<sp/>=<sp/>0,<sp/>y<sp/>=<sp/>0,<sp/>px<sp/>=<sp/>csize<sp/>-<sp/>4,<sp/>py<sp/>=<sp/>csize<sp/>*<sp/>3;
<sp/><sp/><sp/>LPCSTR<sp/>p<sp/>=<sp/>&amp;tetris[0];
<sp/>while(*p){
<sp/><sp/><sp/><sp/><sp/>if(*p<sp/>==<sp/>&apos;#&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(dcbmp-&gt;getDC(),<sp/>px<sp/>+<sp/>x*csize,<sp/>py<sp/>+<sp/>y*csize,<sp/>csize,<sp/>csize,<sp/>0,<sp/>182,<sp/>SRCCOPY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if(*p<sp/>==<sp/>&apos;\n&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++y;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>++p;
<sp/><sp/><sp/>}

<sp/>const<sp/>BYTE<sp/>start[]<sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/>const<sp/>BYTE<sp/>opts[]<sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>17,<sp/>18,<sp/>16,<sp/>14,<sp/>9,<sp/>10,<sp/>0};
<sp/><sp/><sp/>const<sp/>BYTE<sp/>quit[]<sp/><sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>8,<sp/>7,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>27};
<sp/><sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>6,<sp/>start,<sp/>sizeof(start),<sp/>opts,<sp/>sizeof(opts),<sp/>quit,<sp/>sizeof(quit));

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>ctrl[]<sp/>=<sp/>{<sp/>19,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>11,<sp/>5,<sp/>13,<sp/>8,<sp/>5,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>14,<sp/>9};
<sp/>const<sp/>int<sp/>cx<sp/>=<sp/>14;
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ctrl,<sp/>sizeof(ctrl),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(ctrl)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>47,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>BYTE<sp/>help[]<sp/>=<sp/>{<sp/>10,<sp/>11,<sp/>0,<sp/>2,<sp/>8,<sp/>24,<sp/>0,<sp/>77,<sp/>2,<sp/>2,<sp/>5,<sp/>16,<sp/>21,<sp/>77,<sp/>2,<sp/>13,<sp/>8,<sp/>7,<sp/>77,<sp/>2,<sp/>11,<sp/>5,<sp/>2,<sp/>14,<sp/>77,<sp/>2,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>14};
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>help,<sp/>sizeof(help),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(help)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>27,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//----------------------------------------------------------------------------------------------------------------------


void<sp/>tetris::draw_background(HDC<sp/>hDC){
<sp/><sp/>PatBlt(dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>BLACKNESS);
<sp/><sp/><sp/><sp/>bpane.fill(hDC,<sp/>0,<sp/>0,<sp/>PANE_WIDTH,<sp/>dcbmp-&gt;getHeight());
<sp/>bpane.fill(hDC,<sp/>PANE_WIDTH<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>0,<sp/>dcbmp-&gt;getWidth()<sp/>+<sp/>(PANE_WIDTH<sp/>&lt;&lt;<sp/>1)<sp/>+<sp/>1,<sp/>bback-&gt;getHeight());
}


void<sp/>tetris::exec_menu(HWND<sp/>hwnd,<sp/>int<sp/>cmd){
<sp/>if(cmd<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);
<sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>1)<sp/>//диалог<sp/>опции(options)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DialogBoxW((HINSTANCE)GetModuleHandle(NULL),<sp/>MAKEINTRESOURCEW(IDD_OPTIONS),<sp/>hwnd,<sp/>reinterpret_cast&lt;DLGPROC&gt;(&amp;options_proc));
<sp/><sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>2)<sp/>//выход
<sp/><sp/><sp/><sp/><sp/>SendMessage(hwnd,<sp/>WM_CLOSE,<sp/>0,<sp/>0);
}


//перерисовка фигуры
void<sp/>ARGS2_FASTCALL<sp/>tetris::update_figure(HWND<sp/>hwnd){
<sp/><sp/><sp/>const<sp/>int<sp/>m<sp/>=<sp/>CELL_SIZE<sp/>&lt;&lt;<sp/>1;
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>rc.left<sp/><sp/><sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.top<sp/><sp/><sp/><sp/>=<sp/>figure_y<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.right<sp/><sp/>=<sp/>min(rc.left<sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>(m<sp/>&lt;&lt;<sp/>1),<sp/>field_right);<sp/>
<sp/><sp/><sp/><sp/>rc.bottom<sp/>=<sp/>rc.top<sp/><sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>m;
<sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


//добавление<sp/>очков
void<sp/>tetris::score_add(int<sp/>n){
<sp/>if(n<sp/>&gt;<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/>score<sp/>+=<sp/>(n<sp/>==<sp/>1)<sp/>?<sp/>10UL<sp/>:<sp/>static_cast&lt;DWORD&gt;(n)*15UL;
}


//проверка<sp/>на<sp/>проигрыш
bool<sp/>tetris::is_game_over(void){
<sp/><sp/>int<sp/>j<sp/>=<sp/>0;
<sp/>while((j<sp/>&lt;<sp/>FIELD_COLS)<sp/>&amp;&amp;<sp/>(field[0][j]<sp/>==<sp/>BLOCK_NONE))
<sp/><sp/><sp/><sp/><sp/>++j;
<sp/><sp/><sp/>return<sp/>(j<sp/>&lt;<sp/>FIELD_COLS);
}


//вывод кнопок
void<sp/>tetris::draw_buttons(HDC<sp/>hDC,<sp/>int<sp/>num,...){
<sp/>const<sp/>BYTE*<sp/>pb;
<sp/><sp/><sp/><sp/>UINT<sp/><sp/><sp/><sp/>nb;
<sp/><sp/><sp/><sp/>int<sp/><sp/><sp/><sp/><sp/>x,<sp/>p<sp/>=<sp/>0;
<sp/><sp/>RECT<sp/><sp/><sp/><sp/>rc;
<sp/><sp/><sp/><sp/>va_list<sp/>lst;
<sp/><sp/><sp/>va_start(lst,<sp/>num);
<sp/><sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>i<sp/>+=<sp/>2,<sp/>++p){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>p*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>pb<sp/>=<sp/>va_arg(lst,<sp/>const<sp/>BYTE*);
<sp/><sp/><sp/><sp/><sp/>nb<sp/>=<sp/>va_arg(lst,<sp/>UINT);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/><sp/>=<sp/>(p<sp/>==<sp/>sel_cmd)<sp/>?<sp/>89<sp/>:<sp/>21;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>rc.left,<sp/>rc.top,<sp/>rc.right<sp/>-<sp/>rc.left,<sp/>rc.bottom<sp/>-<sp/>rc.top,<sp/>x,<sp/>184,<sp/>69,<sp/>33,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/><sp/><sp/>fnt.draw(hDC,<sp/>pb,<sp/>nb,<sp/>rc.left<sp/>+<sp/>((rc.right<sp/>-<sp/>rc.left)<sp/>-<sp/>static_cast&lt;int&gt;(nb)*fnt.getWidth())/2,<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rc.top<sp/>+<sp/>((rc.bottom<sp/>-<sp/>rc.top)<sp/>-<sp/>fnt.getHeight())/2);
<sp/>}
<sp/><sp/>va_end(lst);
}


void<sp/>ARGS2_FASTCALL<sp/>tetris::set_rect(LPRECT<sp/>prc,<sp/>int<sp/>top){
<sp/><sp/><sp/><sp/>SetRect(prc,<sp/>20,<sp/>250<sp/>+<sp/>top,<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20,<sp/>300<sp/>+<sp/>top);
}


int<sp/>tetris::control_menu(HWND<sp/>hwnd,<sp/>WORD<sp/>key,<sp/>int<sp/>num){
<sp/><sp/><sp/><sp/>switch(key){
<sp/><sp/><sp/>case<sp/>VK_UP:
<sp/><sp/><sp/><sp/>case<sp/>&apos;W&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&gt;<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_DOWN:
<sp/><sp/>case<sp/>&apos;S&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&lt;<sp/>(num<sp/>-<sp/>1)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_RETURN:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>sel_cmd;
<sp/><sp/><sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


void<sp/>tetris::update_menu(HWND<sp/>hwnd){
<sp/><sp/><sp/><sp/>RECT<sp/>rc<sp/>=<sp/>{<sp/>offset_m,<sp/>240,<sp/>offset_m<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>2<sp/>};
<sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


void<sp/>tetris::set_state(HWND<sp/>hwnd,<sp/>e_state_game<sp/>st){
<sp/><sp/><sp/>sel_cmd<sp/>=<sp/>0;
<sp/><sp/><sp/>state<sp/><sp/><sp/>=<sp/>st;
<sp/><sp/>InvalidateRect(hwnd,<sp/>NULL,<sp/>TRUE);
}


int<sp/>tetris::move_button(int<sp/>x,<sp/>int<sp/>y,<sp/>int<sp/>num){
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>i*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>OffsetRect(&amp;rc,<sp/>offset_m,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/>if((x<sp/>&gt;<sp/>rc.left<sp/>&amp;&amp;<sp/>x<sp/>&lt;<sp/>rc.right)<sp/>&amp;&amp;<sp/>(y<sp/>&gt;<sp/>rc.top<sp/>&amp;&amp;<sp/>y<sp/>&lt;<sp/>rc.bottom))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>i;
<sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


//обработчик<sp/>диалога
static<sp/>LRESULT<sp/>CALLBACK<sp/>options_proc(HWND<sp/>hwnd,<sp/>UINT<sp/>msg,<sp/>WPARAM<sp/>wParam,<sp/>LPARAM<sp/>lParam){
<sp/><sp/><sp/><sp/>const<sp/>WCHAR<sp/>vel1[]<sp/>=<sp/>{<sp/>0x41F,0x435,0x440,0x432,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel2[]<sp/>=<sp/>{<sp/>0x412,0x442,0x43E,0x440,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel3[]<sp/>=<sp/>{<sp/>0x422,0x440,0x435,0x442,0x44C,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};

<sp/>switch(msg){
<sp/><sp/><sp/>case<sp/>WM_INITDIALOG:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel1);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel2);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel3);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_SETCURSEL,<sp/>(WPARAM)(g_velocity<sp/>-<sp/>1),<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_SETCHECK,<sp/>(g_audio)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_SETCHECK,<sp/>(!g_repeat)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/>return<sp/>1;
<sp/><sp/>case<sp/>WM_COMMAND:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch(LOWORD(wParam)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_OK:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_velocity<sp/>=<sp/>(int)SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_GETCURSEL,<sp/>0,<sp/>0)<sp/>+<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_audio<sp/><sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/><sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>TRUE<sp/><sp/>:<sp/>FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_repeat<sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>FALSE<sp/>:<sp/>TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_CANCEL:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>WM_CLOSE:
<sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
<sp/><sp/>return<sp/>0;
}
</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="443"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>1,<sp/>CELL_SIZE);</highlight></codeline>
<codeline lineno="444"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="comment">//блоки которые для<sp/>взрыва</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="445"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks-&gt;draw(hdc,<sp/>j<sp/>*<sp/>CELL_SIZE,<sp/>i<sp/>*<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>CELL_SIZE,<sp/>box<sp/>-<sp/>BLOCK_BOOM<sp/>-<sp/>1,<sp/>CELL_OFFSET_BOOM);</highlight></codeline>
<codeline lineno="446"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="447"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="448"><highlight class="normal"></highlight></codeline>
<codeline lineno="449"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//вывод &quot;взрыва&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="450"><highlight class="normal"><sp/><sp/><sp/><sp/>boom_row*<sp/>p;</highlight></codeline>
<codeline lineno="451"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>booms.getSize();<sp/>++i){</highlight></codeline>
<codeline lineno="452"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p<sp/>=<sp/>&amp;booms[i];</highlight></codeline>
<codeline lineno="453"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(p-&gt;dir<sp/>==<sp/>0){</highlight></codeline>
<codeline lineno="454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>+=<sp/>VELOCITY_BOOM;</highlight></codeline>
<codeline lineno="455"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(boom_x<sp/>&gt;=<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>20)){</highlight></codeline>
<codeline lineno="456"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20;</highlight></codeline>
<codeline lineno="457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="458"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="459"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="460"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>-=<sp/>VELOCITY_BOOM;</highlight></codeline>
<codeline lineno="461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(boom_x<sp/>&lt;<sp/>20){</highlight></codeline>
<codeline lineno="462"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>boom_x<sp/>=<sp/>20;</highlight></codeline>
<codeline lineno="463"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p-&gt;dir<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="464"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="465"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="466"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hdc,<sp/>boom_x,<sp/>p-&gt;pos,<sp/>20,<sp/>20,<sp/>0,<sp/>200,<sp/>SRCPAINT);</highlight></codeline>
<codeline lineno="467"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="468"><highlight class="normal"></highlight></codeline>
<codeline lineno="469"><highlight class="normal"><sp/><sp/><sp/><sp/>BitBlt(hDC,<sp/>field_left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>hdc,<sp/>0,<sp/>0,<sp/>SRCCOPY);</highlight></codeline>
<codeline lineno="470"><highlight class="normal"></highlight></codeline>
<codeline lineno="471"><highlight class="normal"><sp/><sp/><sp/><sp/>bnextf-&gt;draw(hDC,<sp/>field_right,<sp/>0,<sp/>NEXTF_WIDTH,<sp/>NEXTF_HEIGHT,<sp/>0,<sp/>0);</highlight></codeline>
<codeline lineno="472"><highlight class="normal"><sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>field_right,<sp/>size.cy<sp/>-<sp/>CTRL_HEIGHT,<sp/>NEXTF_WIDTH,<sp/>CTRL_HEIGHT,<sp/>0,<sp/>220);</highlight></codeline>
<codeline lineno="473"><highlight class="normal">}</highlight></codeline>
<codeline lineno="474"><highlight class="normal"></highlight></codeline>
<codeline lineno="475"><highlight class="normal"></highlight></codeline>
<codeline lineno="476"><highlight class="normal"></highlight><highlight class="comment">//вывод проигрыша void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_over(HDC<sp/>hDC){
<sp/><sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>game[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>77,<sp/>15,<sp/>16,<sp/>14,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>11,<sp/>8,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>19};
<sp/><sp/><sp/><sp/>const<sp/>int<sp/><sp/><sp/><sp/><sp/>fsz<sp/>=<sp/>24;
<sp/><sp/><sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>game,<sp/>sizeof(game),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(game)))/2,<sp/>100,<sp/>fsz,<sp/>28,<sp/>SRCPAINT);

<sp/><sp/>const<sp/>BYTE<sp/>ply[]<sp/><sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>7,<sp/>0,<sp/>13,<sp/>14,<sp/>2,<sp/>14};
<sp/>const<sp/>BYTE<sp/>title[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>2,<sp/>77,<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>11,<sp/>14};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>ply,<sp/>sizeof(ply),<sp/>title,<sp/>sizeof(title));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод паузы
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_pause(HDC<sp/>hDC){
<sp/><sp/><sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>ps[]<sp/>=<sp/>{<sp/>15,<sp/>0,<sp/>19,<sp/>7,<sp/>0};
<sp/><sp/>const<sp/>int<sp/><sp/><sp/>fsz<sp/>=<sp/>32;
<sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ps,<sp/>sizeof(ps),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(ps)))/2,<sp/>100,<sp/>fsz,<sp/>34,<sp/>SRCPAINT);

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>cns[]<sp/>=<sp/>{<sp/>15,<sp/>16,<sp/>14,<sp/>4,<sp/>14,<sp/>11,<sp/>6,<sp/>8,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>exs[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>21,<sp/>14,<sp/>4,<sp/>77,<sp/>2,<sp/>77,<sp/>12,<sp/>5,<sp/>13,<sp/>30};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>cns,<sp/>sizeof(cns),<sp/>exs,<sp/>sizeof(exs));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод меню<sp/>игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_menu(HDC<sp/>hDC){
<sp/>draw_background(hDC);

<sp/>//вывести надпись тетрис
<sp/><sp/>const<sp/>CHAR<sp/>tetris[]<sp/>=<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;###<sp/>###<sp/>###<sp/>###<sp/>#<sp/><sp/><sp/>#<sp/>###\n&quot;\
<sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/>#<sp/>#<sp/><sp/>##<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>###<sp/>#<sp/>#<sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>##<sp/><sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>#<sp/><sp/><sp/>#<sp/>###&quot;
<sp/><sp/><sp/><sp/>};

<sp/><sp/><sp/><sp/>const<sp/>int<sp/>csize<sp/>=<sp/>18;
<sp/><sp/>int<sp/><sp/><sp/><sp/>x<sp/>=<sp/>0,<sp/>y<sp/>=<sp/>0,<sp/>px<sp/>=<sp/>csize<sp/>-<sp/>4,<sp/>py<sp/>=<sp/>csize<sp/>*<sp/>3;
<sp/><sp/><sp/>LPCSTR<sp/>p<sp/>=<sp/>&amp;tetris[0];
<sp/>while(*p){
<sp/><sp/><sp/><sp/><sp/>if(*p<sp/>==<sp/>&apos;#&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(dcbmp-&gt;getDC(),<sp/>px<sp/>+<sp/>x*csize,<sp/>py<sp/>+<sp/>y*csize,<sp/>csize,<sp/>csize,<sp/>0,<sp/>182,<sp/>SRCCOPY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if(*p<sp/>==<sp/>&apos;\n&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++y;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>++p;
<sp/><sp/><sp/>}

<sp/>const<sp/>BYTE<sp/>start[]<sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/>const<sp/>BYTE<sp/>opts[]<sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>17,<sp/>18,<sp/>16,<sp/>14,<sp/>9,<sp/>10,<sp/>0};
<sp/><sp/><sp/>const<sp/>BYTE<sp/>quit[]<sp/><sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>8,<sp/>7,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>27};
<sp/><sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>6,<sp/>start,<sp/>sizeof(start),<sp/>opts,<sp/>sizeof(opts),<sp/>quit,<sp/>sizeof(quit));

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>ctrl[]<sp/>=<sp/>{<sp/>19,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>11,<sp/>5,<sp/>13,<sp/>8,<sp/>5,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>14,<sp/>9};
<sp/>const<sp/>int<sp/>cx<sp/>=<sp/>14;
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ctrl,<sp/>sizeof(ctrl),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(ctrl)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>47,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>BYTE<sp/>help[]<sp/>=<sp/>{<sp/>10,<sp/>11,<sp/>0,<sp/>2,<sp/>8,<sp/>24,<sp/>0,<sp/>77,<sp/>2,<sp/>2,<sp/>5,<sp/>16,<sp/>21,<sp/>77,<sp/>2,<sp/>13,<sp/>8,<sp/>7,<sp/>77,<sp/>2,<sp/>11,<sp/>5,<sp/>2,<sp/>14,<sp/>77,<sp/>2,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>14};
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>help,<sp/>sizeof(help),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(help)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>27,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//----------------------------------------------------------------------------------------------------------------------


void<sp/>tetris::draw_background(HDC<sp/>hDC){
<sp/><sp/>PatBlt(dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>BLACKNESS);
<sp/><sp/><sp/><sp/>bpane.fill(hDC,<sp/>0,<sp/>0,<sp/>PANE_WIDTH,<sp/>dcbmp-&gt;getHeight());
<sp/>bpane.fill(hDC,<sp/>PANE_WIDTH<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>0,<sp/>dcbmp-&gt;getWidth()<sp/>+<sp/>(PANE_WIDTH<sp/>&lt;&lt;<sp/>1)<sp/>+<sp/>1,<sp/>bback-&gt;getHeight());
}


void<sp/>tetris::exec_menu(HWND<sp/>hwnd,<sp/>int<sp/>cmd){
<sp/>if(cmd<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);
<sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>1)<sp/>//диалог<sp/>опции(options)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DialogBoxW((HINSTANCE)GetModuleHandle(NULL),<sp/>MAKEINTRESOURCEW(IDD_OPTIONS),<sp/>hwnd,<sp/>reinterpret_cast&lt;DLGPROC&gt;(&amp;options_proc));
<sp/><sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>2)<sp/>//выход
<sp/><sp/><sp/><sp/><sp/>SendMessage(hwnd,<sp/>WM_CLOSE,<sp/>0,<sp/>0);
}


//перерисовка фигуры
void<sp/>ARGS2_FASTCALL<sp/>tetris::update_figure(HWND<sp/>hwnd){
<sp/><sp/><sp/>const<sp/>int<sp/>m<sp/>=<sp/>CELL_SIZE<sp/>&lt;&lt;<sp/>1;
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>rc.left<sp/><sp/><sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.top<sp/><sp/><sp/><sp/>=<sp/>figure_y<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.right<sp/><sp/>=<sp/>min(rc.left<sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>(m<sp/>&lt;&lt;<sp/>1),<sp/>field_right);<sp/>
<sp/><sp/><sp/><sp/>rc.bottom<sp/>=<sp/>rc.top<sp/><sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>m;
<sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


//добавление<sp/>очков
void<sp/>tetris::score_add(int<sp/>n){
<sp/>if(n<sp/>&gt;<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/>score<sp/>+=<sp/>(n<sp/>==<sp/>1)<sp/>?<sp/>10UL<sp/>:<sp/>static_cast&lt;DWORD&gt;(n)*15UL;
}


//проверка<sp/>на<sp/>проигрыш
bool<sp/>tetris::is_game_over(void){
<sp/><sp/>int<sp/>j<sp/>=<sp/>0;
<sp/>while((j<sp/>&lt;<sp/>FIELD_COLS)<sp/>&amp;&amp;<sp/>(field[0][j]<sp/>==<sp/>BLOCK_NONE))
<sp/><sp/><sp/><sp/><sp/>++j;
<sp/><sp/><sp/>return<sp/>(j<sp/>&lt;<sp/>FIELD_COLS);
}


//вывод кнопок
void<sp/>tetris::draw_buttons(HDC<sp/>hDC,<sp/>int<sp/>num,...){
<sp/>const<sp/>BYTE*<sp/>pb;
<sp/><sp/><sp/><sp/>UINT<sp/><sp/><sp/><sp/>nb;
<sp/><sp/><sp/><sp/>int<sp/><sp/><sp/><sp/><sp/>x,<sp/>p<sp/>=<sp/>0;
<sp/><sp/>RECT<sp/><sp/><sp/><sp/>rc;
<sp/><sp/><sp/><sp/>va_list<sp/>lst;
<sp/><sp/><sp/>va_start(lst,<sp/>num);
<sp/><sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>i<sp/>+=<sp/>2,<sp/>++p){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>p*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>pb<sp/>=<sp/>va_arg(lst,<sp/>const<sp/>BYTE*);
<sp/><sp/><sp/><sp/><sp/>nb<sp/>=<sp/>va_arg(lst,<sp/>UINT);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/><sp/>=<sp/>(p<sp/>==<sp/>sel_cmd)<sp/>?<sp/>89<sp/>:<sp/>21;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>rc.left,<sp/>rc.top,<sp/>rc.right<sp/>-<sp/>rc.left,<sp/>rc.bottom<sp/>-<sp/>rc.top,<sp/>x,<sp/>184,<sp/>69,<sp/>33,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/><sp/><sp/>fnt.draw(hDC,<sp/>pb,<sp/>nb,<sp/>rc.left<sp/>+<sp/>((rc.right<sp/>-<sp/>rc.left)<sp/>-<sp/>static_cast&lt;int&gt;(nb)*fnt.getWidth())/2,<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rc.top<sp/>+<sp/>((rc.bottom<sp/>-<sp/>rc.top)<sp/>-<sp/>fnt.getHeight())/2);
<sp/>}
<sp/><sp/>va_end(lst);
}


void<sp/>ARGS2_FASTCALL<sp/>tetris::set_rect(LPRECT<sp/>prc,<sp/>int<sp/>top){
<sp/><sp/><sp/><sp/>SetRect(prc,<sp/>20,<sp/>250<sp/>+<sp/>top,<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20,<sp/>300<sp/>+<sp/>top);
}


int<sp/>tetris::control_menu(HWND<sp/>hwnd,<sp/>WORD<sp/>key,<sp/>int<sp/>num){
<sp/><sp/><sp/><sp/>switch(key){
<sp/><sp/><sp/>case<sp/>VK_UP:
<sp/><sp/><sp/><sp/>case<sp/>&apos;W&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&gt;<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_DOWN:
<sp/><sp/>case<sp/>&apos;S&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&lt;<sp/>(num<sp/>-<sp/>1)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_RETURN:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>sel_cmd;
<sp/><sp/><sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


void<sp/>tetris::update_menu(HWND<sp/>hwnd){
<sp/><sp/><sp/><sp/>RECT<sp/>rc<sp/>=<sp/>{<sp/>offset_m,<sp/>240,<sp/>offset_m<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>2<sp/>};
<sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


void<sp/>tetris::set_state(HWND<sp/>hwnd,<sp/>e_state_game<sp/>st){
<sp/><sp/><sp/>sel_cmd<sp/>=<sp/>0;
<sp/><sp/><sp/>state<sp/><sp/><sp/>=<sp/>st;
<sp/><sp/>InvalidateRect(hwnd,<sp/>NULL,<sp/>TRUE);
}


int<sp/>tetris::move_button(int<sp/>x,<sp/>int<sp/>y,<sp/>int<sp/>num){
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>i*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>OffsetRect(&amp;rc,<sp/>offset_m,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/>if((x<sp/>&gt;<sp/>rc.left<sp/>&amp;&amp;<sp/>x<sp/>&lt;<sp/>rc.right)<sp/>&amp;&amp;<sp/>(y<sp/>&gt;<sp/>rc.top<sp/>&amp;&amp;<sp/>y<sp/>&lt;<sp/>rc.bottom))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>i;
<sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


//обработчик<sp/>диалога
static<sp/>LRESULT<sp/>CALLBACK<sp/>options_proc(HWND<sp/>hwnd,<sp/>UINT<sp/>msg,<sp/>WPARAM<sp/>wParam,<sp/>LPARAM<sp/>lParam){
<sp/><sp/><sp/><sp/>const<sp/>WCHAR<sp/>vel1[]<sp/>=<sp/>{<sp/>0x41F,0x435,0x440,0x432,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel2[]<sp/>=<sp/>{<sp/>0x412,0x442,0x43E,0x440,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel3[]<sp/>=<sp/>{<sp/>0x422,0x440,0x435,0x442,0x44C,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};

<sp/>switch(msg){
<sp/><sp/><sp/>case<sp/>WM_INITDIALOG:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel1);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel2);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel3);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_SETCURSEL,<sp/>(WPARAM)(g_velocity<sp/>-<sp/>1),<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_SETCHECK,<sp/>(g_audio)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_SETCHECK,<sp/>(!g_repeat)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/>return<sp/>1;
<sp/><sp/>case<sp/>WM_COMMAND:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch(LOWORD(wParam)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_OK:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_velocity<sp/>=<sp/>(int)SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_GETCURSEL,<sp/>0,<sp/>0)<sp/>+<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_audio<sp/><sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/><sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>TRUE<sp/><sp/>:<sp/>FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_repeat<sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>FALSE<sp/>:<sp/>TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_CANCEL:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>WM_CLOSE:
<sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
<sp/><sp/>return<sp/>0;
}
</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="477"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ARGS2_FASTCALL<sp/>tetris::draw_over(<ref refid="main_8cpp_1a296475d8e990aad6b442b8b669315f5e" kindref="member">HDC</ref><sp/>hDC){</highlight></codeline>
<codeline lineno="478"><highlight class="normal"><sp/><sp/><sp/><sp/>draw_background(hDC);</highlight></codeline>
<codeline lineno="479"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();</highlight></codeline>
<codeline lineno="480"><highlight class="normal"></highlight></codeline>
<codeline lineno="481"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BYTE<sp/>game[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>77,<sp/>15,<sp/>16,<sp/>14,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>11,<sp/>8,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>19};</highlight></codeline>
<codeline lineno="482"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><sp/><sp/><sp/><sp/>fsz<sp/>=<sp/>24;</highlight></codeline>
<codeline lineno="483"><highlight class="normal"><sp/><sp/><sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>game,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(game),<sp/>(width<sp/>-<sp/>fsz*</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">(</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(game)))/2,<sp/>100,<sp/>fsz,<sp/>28,<sp/>SRCPAINT);</highlight></codeline>
<codeline lineno="484"><highlight class="normal"></highlight></codeline>
<codeline lineno="485"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BYTE<sp/>ply[]<sp/><sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>7,<sp/>0,<sp/>13,<sp/>14,<sp/>2,<sp/>14};</highlight></codeline>
<codeline lineno="486"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BYTE<sp/>title[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>2,<sp/>77,<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>11,<sp/>14};</highlight></codeline>
<codeline lineno="487"><highlight class="normal"><sp/><sp/><sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>ply,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(ply),<sp/>title,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(title));</highlight></codeline>
<codeline lineno="488"><highlight class="normal"></highlight></codeline>
<codeline lineno="489"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;</highlight></codeline>
<codeline lineno="490"><highlight class="normal"><sp/><sp/><sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);</highlight></codeline>
<codeline lineno="491"><highlight class="normal">}</highlight></codeline>
<codeline lineno="492"><highlight class="normal"></highlight></codeline>
<codeline lineno="493"><highlight class="normal"></highlight></codeline>
<codeline lineno="494"><highlight class="normal"></highlight><highlight class="comment">//вывод паузы void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_pause(HDC<sp/>hDC){
<sp/><sp/><sp/>draw_background(hDC);
<sp/><sp/>const<sp/>int<sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();

<sp/><sp/>const<sp/>BYTE<sp/>ps[]<sp/>=<sp/>{<sp/>15,<sp/>0,<sp/>19,<sp/>7,<sp/>0};
<sp/><sp/>const<sp/>int<sp/><sp/><sp/>fsz<sp/>=<sp/>32;
<sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ps,<sp/>sizeof(ps),<sp/>(width<sp/>-<sp/>fsz*int(sizeof(ps)))/2,<sp/>100,<sp/>fsz,<sp/>34,<sp/>SRCPAINT);

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>cns[]<sp/>=<sp/>{<sp/>15,<sp/>16,<sp/>14,<sp/>4,<sp/>14,<sp/>11,<sp/>6,<sp/>8,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>exs[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>21,<sp/>14,<sp/>4,<sp/>77,<sp/>2,<sp/>77,<sp/>12,<sp/>5,<sp/>13,<sp/>30};
<sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>cns,<sp/>sizeof(cns),<sp/>exs,<sp/>sizeof(exs));

<sp/><sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//вывод меню<sp/>игры
void<sp/>ARGS2_FASTCALL<sp/>tetris::draw_menu(HDC<sp/>hDC){
<sp/>draw_background(hDC);

<sp/>//вывести надпись тетрис
<sp/><sp/>const<sp/>CHAR<sp/>tetris[]<sp/>=<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;###<sp/>###<sp/>###<sp/>###<sp/>#<sp/><sp/><sp/>#<sp/>###\n&quot;\
<sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/>#<sp/>#<sp/><sp/>##<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>###<sp/>#<sp/>#<sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>##<sp/><sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;\
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>#<sp/><sp/><sp/>#<sp/>###&quot;
<sp/><sp/><sp/><sp/>};

<sp/><sp/><sp/><sp/>const<sp/>int<sp/>csize<sp/>=<sp/>18;
<sp/><sp/>int<sp/><sp/><sp/><sp/>x<sp/>=<sp/>0,<sp/>y<sp/>=<sp/>0,<sp/>px<sp/>=<sp/>csize<sp/>-<sp/>4,<sp/>py<sp/>=<sp/>csize<sp/>*<sp/>3;
<sp/><sp/><sp/>LPCSTR<sp/>p<sp/>=<sp/>&amp;tetris[0];
<sp/>while(*p){
<sp/><sp/><sp/><sp/><sp/>if(*p<sp/>==<sp/>&apos;#&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(dcbmp-&gt;getDC(),<sp/>px<sp/>+<sp/>x*csize,<sp/>py<sp/>+<sp/>y*csize,<sp/>csize,<sp/>csize,<sp/>0,<sp/>182,<sp/>SRCCOPY);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if(*p<sp/>==<sp/>&apos;\n&apos;){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++y;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/>}<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>++p;
<sp/><sp/><sp/>}

<sp/>const<sp/>BYTE<sp/>start[]<sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};
<sp/>const<sp/>BYTE<sp/>opts[]<sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>17,<sp/>18,<sp/>16,<sp/>14,<sp/>9,<sp/>10,<sp/>0};
<sp/><sp/><sp/>const<sp/>BYTE<sp/>quit[]<sp/><sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>8,<sp/>7,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>27};
<sp/><sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>6,<sp/>start,<sp/>sizeof(start),<sp/>opts,<sp/>sizeof(opts),<sp/>quit,<sp/>sizeof(quit));

<sp/><sp/><sp/><sp/>const<sp/>BYTE<sp/>ctrl[]<sp/>=<sp/>{<sp/>19,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>11,<sp/>5,<sp/>13,<sp/>8,<sp/>5,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>14,<sp/>9};
<sp/>const<sp/>int<sp/>cx<sp/>=<sp/>14;
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ctrl,<sp/>sizeof(ctrl),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(ctrl)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>47,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>BYTE<sp/>help[]<sp/>=<sp/>{<sp/>10,<sp/>11,<sp/>0,<sp/>2,<sp/>8,<sp/>24,<sp/>0,<sp/>77,<sp/>2,<sp/>2,<sp/>5,<sp/>16,<sp/>21,<sp/>77,<sp/>2,<sp/>13,<sp/>8,<sp/>7,<sp/>77,<sp/>2,<sp/>11,<sp/>5,<sp/>2,<sp/>14,<sp/>77,<sp/>2,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>14};
<sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>help,<sp/>sizeof(help),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*int(sizeof(help)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>27,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);

<sp/>const<sp/>int<sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;
<sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);
}


//----------------------------------------------------------------------------------------------------------------------


void<sp/>tetris::draw_background(HDC<sp/>hDC){
<sp/><sp/>PatBlt(dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>BLACKNESS);
<sp/><sp/><sp/><sp/>bpane.fill(hDC,<sp/>0,<sp/>0,<sp/>PANE_WIDTH,<sp/>dcbmp-&gt;getHeight());
<sp/>bpane.fill(hDC,<sp/>PANE_WIDTH<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>0,<sp/>dcbmp-&gt;getWidth()<sp/>+<sp/>(PANE_WIDTH<sp/>&lt;&lt;<sp/>1)<sp/>+<sp/>1,<sp/>bback-&gt;getHeight());
}


void<sp/>tetris::exec_menu(HWND<sp/>hwnd,<sp/>int<sp/>cmd){
<sp/>if(cmd<sp/>==<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);
<sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>1)<sp/>//диалог<sp/>опции(options)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DialogBoxW((HINSTANCE)GetModuleHandle(NULL),<sp/>MAKEINTRESOURCEW(IDD_OPTIONS),<sp/>hwnd,<sp/>reinterpret_cast&lt;DLGPROC&gt;(&amp;options_proc));
<sp/><sp/><sp/>else<sp/>if(cmd<sp/>==<sp/>2)<sp/>//выход
<sp/><sp/><sp/><sp/><sp/>SendMessage(hwnd,<sp/>WM_CLOSE,<sp/>0,<sp/>0);
}


//перерисовка фигуры
void<sp/>ARGS2_FASTCALL<sp/>tetris::update_figure(HWND<sp/>hwnd){
<sp/><sp/><sp/>const<sp/>int<sp/>m<sp/>=<sp/>CELL_SIZE<sp/>&lt;&lt;<sp/>1;
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>rc.left<sp/><sp/><sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.top<sp/><sp/><sp/><sp/>=<sp/>figure_y<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.right<sp/><sp/>=<sp/>min(rc.left<sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>(m<sp/>&lt;&lt;<sp/>1),<sp/>field_right);<sp/>
<sp/><sp/><sp/><sp/>rc.bottom<sp/>=<sp/>rc.top<sp/><sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>m;
<sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


//добавление<sp/>очков
void<sp/>tetris::score_add(int<sp/>n){
<sp/>if(n<sp/>&gt;<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/>score<sp/>+=<sp/>(n<sp/>==<sp/>1)<sp/>?<sp/>10UL<sp/>:<sp/>static_cast&lt;DWORD&gt;(n)*15UL;
}


//проверка<sp/>на<sp/>проигрыш
bool<sp/>tetris::is_game_over(void){
<sp/><sp/>int<sp/>j<sp/>=<sp/>0;
<sp/>while((j<sp/>&lt;<sp/>FIELD_COLS)<sp/>&amp;&amp;<sp/>(field[0][j]<sp/>==<sp/>BLOCK_NONE))
<sp/><sp/><sp/><sp/><sp/>++j;
<sp/><sp/><sp/>return<sp/>(j<sp/>&lt;<sp/>FIELD_COLS);
}


//вывод кнопок
void<sp/>tetris::draw_buttons(HDC<sp/>hDC,<sp/>int<sp/>num,...){
<sp/>const<sp/>BYTE*<sp/>pb;
<sp/><sp/><sp/><sp/>UINT<sp/><sp/><sp/><sp/>nb;
<sp/><sp/><sp/><sp/>int<sp/><sp/><sp/><sp/><sp/>x,<sp/>p<sp/>=<sp/>0;
<sp/><sp/>RECT<sp/><sp/><sp/><sp/>rc;
<sp/><sp/><sp/><sp/>va_list<sp/>lst;
<sp/><sp/><sp/>va_start(lst,<sp/>num);
<sp/><sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>i<sp/>+=<sp/>2,<sp/>++p){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>p*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>pb<sp/>=<sp/>va_arg(lst,<sp/>const<sp/>BYTE*);
<sp/><sp/><sp/><sp/><sp/>nb<sp/>=<sp/>va_arg(lst,<sp/>UINT);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/><sp/>=<sp/>(p<sp/>==<sp/>sel_cmd)<sp/>?<sp/>89<sp/>:<sp/>21;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>rc.left,<sp/>rc.top,<sp/>rc.right<sp/>-<sp/>rc.left,<sp/>rc.bottom<sp/>-<sp/>rc.top,<sp/>x,<sp/>184,<sp/>69,<sp/>33,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/><sp/><sp/>fnt.draw(hDC,<sp/>pb,<sp/>nb,<sp/>rc.left<sp/>+<sp/>((rc.right<sp/>-<sp/>rc.left)<sp/>-<sp/>static_cast&lt;int&gt;(nb)*fnt.getWidth())/2,<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rc.top<sp/>+<sp/>((rc.bottom<sp/>-<sp/>rc.top)<sp/>-<sp/>fnt.getHeight())/2);
<sp/>}
<sp/><sp/>va_end(lst);
}


void<sp/>ARGS2_FASTCALL<sp/>tetris::set_rect(LPRECT<sp/>prc,<sp/>int<sp/>top){
<sp/><sp/><sp/><sp/>SetRect(prc,<sp/>20,<sp/>250<sp/>+<sp/>top,<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20,<sp/>300<sp/>+<sp/>top);
}


int<sp/>tetris::control_menu(HWND<sp/>hwnd,<sp/>WORD<sp/>key,<sp/>int<sp/>num){
<sp/><sp/><sp/><sp/>switch(key){
<sp/><sp/><sp/>case<sp/>VK_UP:
<sp/><sp/><sp/><sp/>case<sp/>&apos;W&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&gt;<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_DOWN:
<sp/><sp/>case<sp/>&apos;S&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&lt;<sp/>(num<sp/>-<sp/>1)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_RETURN:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>sel_cmd;
<sp/><sp/><sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


void<sp/>tetris::update_menu(HWND<sp/>hwnd){
<sp/><sp/><sp/><sp/>RECT<sp/>rc<sp/>=<sp/>{<sp/>offset_m,<sp/>240,<sp/>offset_m<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>2<sp/>};
<sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


void<sp/>tetris::set_state(HWND<sp/>hwnd,<sp/>e_state_game<sp/>st){
<sp/><sp/><sp/>sel_cmd<sp/>=<sp/>0;
<sp/><sp/><sp/>state<sp/><sp/><sp/>=<sp/>st;
<sp/><sp/>InvalidateRect(hwnd,<sp/>NULL,<sp/>TRUE);
}


int<sp/>tetris::move_button(int<sp/>x,<sp/>int<sp/>y,<sp/>int<sp/>num){
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>i*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>OffsetRect(&amp;rc,<sp/>offset_m,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/>if((x<sp/>&gt;<sp/>rc.left<sp/>&amp;&amp;<sp/>x<sp/>&lt;<sp/>rc.right)<sp/>&amp;&amp;<sp/>(y<sp/>&gt;<sp/>rc.top<sp/>&amp;&amp;<sp/>y<sp/>&lt;<sp/>rc.bottom))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>i;
<sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


//обработчик<sp/>диалога
static<sp/>LRESULT<sp/>CALLBACK<sp/>options_proc(HWND<sp/>hwnd,<sp/>UINT<sp/>msg,<sp/>WPARAM<sp/>wParam,<sp/>LPARAM<sp/>lParam){
<sp/><sp/><sp/><sp/>const<sp/>WCHAR<sp/>vel1[]<sp/>=<sp/>{<sp/>0x41F,0x435,0x440,0x432,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel2[]<sp/>=<sp/>{<sp/>0x412,0x442,0x43E,0x440,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel3[]<sp/>=<sp/>{<sp/>0x422,0x440,0x435,0x442,0x44C,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};

<sp/>switch(msg){
<sp/><sp/><sp/>case<sp/>WM_INITDIALOG:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel1);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel2);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel3);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_SETCURSEL,<sp/>(WPARAM)(g_velocity<sp/>-<sp/>1),<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_SETCHECK,<sp/>(g_audio)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_SETCHECK,<sp/>(!g_repeat)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/>return<sp/>1;
<sp/><sp/>case<sp/>WM_COMMAND:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch(LOWORD(wParam)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_OK:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_velocity<sp/>=<sp/>(int)SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_GETCURSEL,<sp/>0,<sp/>0)<sp/>+<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_audio<sp/><sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/><sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>TRUE<sp/><sp/>:<sp/>FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_repeat<sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>FALSE<sp/>:<sp/>TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_CANCEL:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>WM_CLOSE:
<sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
<sp/><sp/>return<sp/>0;
}
</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="495"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ARGS2_FASTCALL<sp/>tetris::draw_pause(<ref refid="main_8cpp_1a296475d8e990aad6b442b8b669315f5e" kindref="member">HDC</ref><sp/>hDC){</highlight></codeline>
<codeline lineno="496"><highlight class="normal"><sp/><sp/><sp/><sp/>draw_background(hDC);</highlight></codeline>
<codeline lineno="497"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>width<sp/>=<sp/>dcbmp-&gt;getWidth();</highlight></codeline>
<codeline lineno="498"><highlight class="normal"></highlight></codeline>
<codeline lineno="499"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BYTE<sp/>ps[]<sp/>=<sp/>{<sp/>15,<sp/>0,<sp/>19,<sp/>7,<sp/>0};</highlight></codeline>
<codeline lineno="500"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><sp/><sp/>fsz<sp/>=<sp/>32;</highlight></codeline>
<codeline lineno="501"><highlight class="normal"><sp/><sp/><sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ps,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(ps),<sp/>(width<sp/>-<sp/>fsz*</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">(</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(ps)))/2,<sp/>100,<sp/>fsz,<sp/>34,<sp/>SRCPAINT);</highlight></codeline>
<codeline lineno="502"><highlight class="normal"></highlight></codeline>
<codeline lineno="503"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BYTE<sp/>cns[]<sp/>=<sp/>{<sp/>15,<sp/>16,<sp/>14,<sp/>4,<sp/>14,<sp/>11,<sp/>6,<sp/>8,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};</highlight></codeline>
<codeline lineno="504"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BYTE<sp/>exs[]<sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>21,<sp/>14,<sp/>4,<sp/>77,<sp/>2,<sp/>77,<sp/>12,<sp/>5,<sp/>13,<sp/>30};</highlight></codeline>
<codeline lineno="505"><highlight class="normal"><sp/><sp/><sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>4,<sp/>cns,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(cns),<sp/>exs,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(exs));</highlight></codeline>
<codeline lineno="506"><highlight class="normal"></highlight></codeline>
<codeline lineno="507"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;</highlight></codeline>
<codeline lineno="508"><highlight class="normal"><sp/><sp/><sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);</highlight></codeline>
<codeline lineno="509"><highlight class="normal">}</highlight></codeline>
<codeline lineno="510"><highlight class="normal"></highlight></codeline>
<codeline lineno="511"><highlight class="normal"></highlight></codeline>
<codeline lineno="512"><highlight class="normal"></highlight><highlight class="comment">//вывод меню<sp/>игры</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="513"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ARGS2_FASTCALL<sp/>tetris::draw_menu(<ref refid="main_8cpp_1a296475d8e990aad6b442b8b669315f5e" kindref="member">HDC</ref><sp/>hDC){</highlight></codeline>
<codeline lineno="514"><highlight class="normal"><sp/><sp/><sp/><sp/>draw_background(hDC);</highlight></codeline>
<codeline lineno="515"><highlight class="normal"></highlight></codeline>
<codeline lineno="516"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//вывести надпись тетрис</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="517"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CHAR<sp/>tetris[]<sp/>=<sp/>{</highlight></codeline>
<codeline lineno="518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;###<sp/>###<sp/>###<sp/>###<sp/>#<sp/><sp/><sp/>#<sp/>###\n&quot;</highlight><highlight class="normal">\</highlight></codeline>
<codeline lineno="519"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/>#<sp/>#<sp/><sp/>##<sp/>#<sp/><sp/><sp/>\n&quot;</highlight><highlight class="normal">\</highlight></codeline>
<codeline lineno="520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>###<sp/>#<sp/>#<sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;</highlight><highlight class="normal">\</highlight></codeline>
<codeline lineno="521"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;<sp/>#<sp/><sp/>#<sp/><sp/><sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>##<sp/><sp/>#<sp/>#<sp/><sp/><sp/>\n&quot;</highlight><highlight class="normal">\</highlight></codeline>
<codeline lineno="522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;<sp/>#<sp/><sp/>###<sp/><sp/>#<sp/><sp/>#<sp/><sp/><sp/>#<sp/><sp/><sp/>#<sp/>###&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="523"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="524"><highlight class="normal"></highlight></codeline>
<codeline lineno="525"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>csize<sp/>=<sp/>18;</highlight></codeline>
<codeline lineno="526"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><sp/><sp/><sp/>x<sp/>=<sp/>0,<sp/>y<sp/>=<sp/>0,<sp/>px<sp/>=<sp/>csize<sp/>-<sp/>4,<sp/>py<sp/>=<sp/>csize<sp/>*<sp/>3;</highlight></codeline>
<codeline lineno="527"><highlight class="normal"><sp/><sp/><sp/><sp/>LPCSTR<sp/>p<sp/>=<sp/>&amp;tetris[0];</highlight></codeline>
<codeline lineno="528"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal">(*p){</highlight></codeline>
<codeline lineno="529"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(*p<sp/>==<sp/></highlight><highlight class="charliteral">&apos;#&apos;</highlight><highlight class="normal">){</highlight></codeline>
<codeline lineno="530"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(dcbmp-&gt;getDC(),<sp/>px<sp/>+<sp/>x*csize,<sp/>py<sp/>+<sp/>y*csize,<sp/>csize,<sp/>csize,<sp/>0,<sp/>182,<sp/>SRCCOPY);</highlight></codeline>
<codeline lineno="531"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;</highlight></codeline>
<codeline lineno="532"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(*p<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\n&apos;</highlight><highlight class="normal">){</highlight></codeline>
<codeline lineno="533"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++y;</highlight></codeline>
<codeline lineno="534"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="535"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++x;</highlight></codeline>
<codeline lineno="537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++p;</highlight></codeline>
<codeline lineno="538"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="539"><highlight class="normal"></highlight></codeline>
<codeline lineno="540"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BYTE<sp/>start[]<sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>23,<sp/>0,<sp/>18,<sp/>28,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>0,<sp/>18,<sp/>28};</highlight></codeline>
<codeline lineno="541"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BYTE<sp/>opts[]<sp/><sp/>=<sp/>{<sp/>13,<sp/>0,<sp/>17,<sp/>18,<sp/>16,<sp/>14,<sp/>9,<sp/>10,<sp/>0};</highlight></codeline>
<codeline lineno="542"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BYTE<sp/>quit[]<sp/><sp/>=<sp/>{<sp/>2,<sp/>27,<sp/>9,<sp/>18,<sp/>8,<sp/>77,<sp/>8,<sp/>7,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>27};</highlight></codeline>
<codeline lineno="543"><highlight class="normal"><sp/><sp/><sp/><sp/>draw_buttons(dcbmp-&gt;getDC(),<sp/>6,<sp/>start,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(start),<sp/>opts,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(opts),<sp/>quit,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(quit));</highlight></codeline>
<codeline lineno="544"><highlight class="normal"></highlight></codeline>
<codeline lineno="545"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BYTE<sp/>ctrl[]<sp/>=<sp/>{<sp/>19,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>11,<sp/>5,<sp/>13,<sp/>8,<sp/>5,<sp/>77,<sp/>8,<sp/>3,<sp/>16,<sp/>14,<sp/>9};</highlight></codeline>
<codeline lineno="546"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>cx<sp/>=<sp/>14;</highlight></codeline>
<codeline lineno="547"><highlight class="normal"><sp/><sp/><sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>ctrl,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(ctrl),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">(</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(ctrl)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>47,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);</highlight></codeline>
<codeline lineno="548"><highlight class="normal"></highlight></codeline>
<codeline lineno="549"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BYTE<sp/>help[]<sp/>=<sp/>{<sp/>10,<sp/>11,<sp/>0,<sp/>2,<sp/>8,<sp/>24,<sp/>0,<sp/>77,<sp/>2,<sp/>2,<sp/>5,<sp/>16,<sp/>21,<sp/>77,<sp/>2,<sp/>13,<sp/>8,<sp/>7,<sp/>77,<sp/>2,<sp/>11,<sp/>5,<sp/>2,<sp/>14,<sp/>77,<sp/>2,<sp/>15,<sp/>16,<sp/>0,<sp/>2,<sp/>14};</highlight></codeline>
<codeline lineno="550"><highlight class="normal"><sp/><sp/><sp/><sp/>fnt.draw(dcbmp-&gt;getDC(),<sp/>help,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(help),<sp/>(dcbmp-&gt;getWidth()<sp/>-<sp/>cx*</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">(</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(help)))/2,<sp/>dcbmp-&gt;getHeight()<sp/>-<sp/>27,<sp/>cx,<sp/>cx<sp/>+<sp/>1,<sp/>SRCCOPY);</highlight></codeline>
<codeline lineno="551"><highlight class="normal"></highlight></codeline>
<codeline lineno="552"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>left<sp/>=<sp/>(size.cx<sp/>-<sp/>dcbmp-&gt;getWidth())/2;</highlight></codeline>
<codeline lineno="553"><highlight class="normal"><sp/><sp/><sp/><sp/>BitBlt(hDC,<sp/>left,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>SRCCOPY);</highlight></codeline>
<codeline lineno="554"><highlight class="normal">}</highlight></codeline>
<codeline lineno="555"><highlight class="normal"></highlight></codeline>
<codeline lineno="556"><highlight class="normal"></highlight></codeline>
<codeline lineno="557"><highlight class="normal"></highlight><highlight class="comment">//----------------------------------------------------------------------------------------------------------------------</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="558"><highlight class="normal"></highlight></codeline>
<codeline lineno="559"><highlight class="normal"></highlight></codeline>
<codeline lineno="560"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>tetris::draw_background(<ref refid="main_8cpp_1a296475d8e990aad6b442b8b669315f5e" kindref="member">HDC</ref><sp/>hDC){</highlight></codeline>
<codeline lineno="561"><highlight class="normal"><sp/><sp/><sp/><sp/>PatBlt(dcbmp-&gt;getDC(),<sp/>0,<sp/>0,<sp/>dcbmp-&gt;getWidth(),<sp/>dcbmp-&gt;getHeight(),<sp/>BLACKNESS);</highlight></codeline>
<codeline lineno="562"><highlight class="normal"><sp/><sp/><sp/><sp/>bpane.fill(hDC,<sp/>0,<sp/>0,<sp/>PANE_WIDTH,<sp/>dcbmp-&gt;getHeight());</highlight></codeline>
<codeline lineno="563"><highlight class="normal"><sp/><sp/><sp/><sp/>bpane.fill(hDC,<sp/>PANE_WIDTH<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>0,<sp/>dcbmp-&gt;getWidth()<sp/>+<sp/>(PANE_WIDTH<sp/>&lt;&lt;<sp/>1)<sp/>+<sp/>1,<sp/>bback-&gt;getHeight());</highlight></codeline>
<codeline lineno="564"><highlight class="normal">}</highlight></codeline>
<codeline lineno="565"><highlight class="normal"></highlight></codeline>
<codeline lineno="566"><highlight class="normal"></highlight></codeline>
<codeline lineno="567"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>tetris::exec_menu(<ref refid="main_8cpp_1a74aea08afaa7f26d272e9352ddafda3d" kindref="member">HWND</ref><sp/>hwnd,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>cmd){</highlight></codeline>
<codeline lineno="568"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(cmd<sp/>==<sp/>0)</highlight></codeline>
<codeline lineno="569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_game(hwnd);</highlight></codeline>
<codeline lineno="570"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(cmd<sp/>==<sp/>1)<sp/></highlight><highlight class="comment">//диалог<sp/>опции(options)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DialogBoxW((HINSTANCE)GetModuleHandle(NULL),<sp/>MAKEINTRESOURCEW(IDD_OPTIONS),<sp/>hwnd,<sp/></highlight><highlight class="keyword">reinterpret_cast&lt;</highlight><highlight class="normal">DLGPROC</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(&amp;options_proc));</highlight></codeline>
<codeline lineno="572"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(cmd<sp/>==<sp/>2)<sp/></highlight><highlight class="comment">//выход <sp/><sp/><sp/><sp/><sp/>SendMessage(hwnd,<sp/>WM_CLOSE,<sp/>0,<sp/>0);
}


//перерисовка фигуры
void<sp/>ARGS2_FASTCALL<sp/>tetris::update_figure(HWND<sp/>hwnd){
<sp/><sp/><sp/>const<sp/>int<sp/>m<sp/>=<sp/>CELL_SIZE<sp/>&lt;&lt;<sp/>1;
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>rc.left<sp/><sp/><sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.top<sp/><sp/><sp/><sp/>=<sp/>figure_y<sp/>-<sp/>CELL_SIZE;
<sp/><sp/>rc.right<sp/><sp/>=<sp/>min(rc.left<sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>(m<sp/>&lt;&lt;<sp/>1),<sp/>field_right);<sp/>
<sp/><sp/><sp/><sp/>rc.bottom<sp/>=<sp/>rc.top<sp/><sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>m;
<sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


//добавление<sp/>очков
void<sp/>tetris::score_add(int<sp/>n){
<sp/>if(n<sp/>&gt;<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/>score<sp/>+=<sp/>(n<sp/>==<sp/>1)<sp/>?<sp/>10UL<sp/>:<sp/>static_cast&lt;DWORD&gt;(n)*15UL;
}


//проверка<sp/>на<sp/>проигрыш
bool<sp/>tetris::is_game_over(void){
<sp/><sp/>int<sp/>j<sp/>=<sp/>0;
<sp/>while((j<sp/>&lt;<sp/>FIELD_COLS)<sp/>&amp;&amp;<sp/>(field[0][j]<sp/>==<sp/>BLOCK_NONE))
<sp/><sp/><sp/><sp/><sp/>++j;
<sp/><sp/><sp/>return<sp/>(j<sp/>&lt;<sp/>FIELD_COLS);
}


//вывод кнопок
void<sp/>tetris::draw_buttons(HDC<sp/>hDC,<sp/>int<sp/>num,...){
<sp/>const<sp/>BYTE*<sp/>pb;
<sp/><sp/><sp/><sp/>UINT<sp/><sp/><sp/><sp/>nb;
<sp/><sp/><sp/><sp/>int<sp/><sp/><sp/><sp/><sp/>x,<sp/>p<sp/>=<sp/>0;
<sp/><sp/>RECT<sp/><sp/><sp/><sp/>rc;
<sp/><sp/><sp/><sp/>va_list<sp/>lst;
<sp/><sp/><sp/>va_start(lst,<sp/>num);
<sp/><sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>i<sp/>+=<sp/>2,<sp/>++p){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>p*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>pb<sp/>=<sp/>va_arg(lst,<sp/>const<sp/>BYTE*);
<sp/><sp/><sp/><sp/><sp/>nb<sp/>=<sp/>va_arg(lst,<sp/>UINT);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/><sp/>=<sp/>(p<sp/>==<sp/>sel_cmd)<sp/>?<sp/>89<sp/>:<sp/>21;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>rc.left,<sp/>rc.top,<sp/>rc.right<sp/>-<sp/>rc.left,<sp/>rc.bottom<sp/>-<sp/>rc.top,<sp/>x,<sp/>184,<sp/>69,<sp/>33,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/><sp/><sp/>fnt.draw(hDC,<sp/>pb,<sp/>nb,<sp/>rc.left<sp/>+<sp/>((rc.right<sp/>-<sp/>rc.left)<sp/>-<sp/>static_cast&lt;int&gt;(nb)*fnt.getWidth())/2,<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rc.top<sp/>+<sp/>((rc.bottom<sp/>-<sp/>rc.top)<sp/>-<sp/>fnt.getHeight())/2);
<sp/>}
<sp/><sp/>va_end(lst);
}


void<sp/>ARGS2_FASTCALL<sp/>tetris::set_rect(LPRECT<sp/>prc,<sp/>int<sp/>top){
<sp/><sp/><sp/><sp/>SetRect(prc,<sp/>20,<sp/>250<sp/>+<sp/>top,<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20,<sp/>300<sp/>+<sp/>top);
}


int<sp/>tetris::control_menu(HWND<sp/>hwnd,<sp/>WORD<sp/>key,<sp/>int<sp/>num){
<sp/><sp/><sp/><sp/>switch(key){
<sp/><sp/><sp/>case<sp/>VK_UP:
<sp/><sp/><sp/><sp/>case<sp/>&apos;W&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&gt;<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_DOWN:
<sp/><sp/>case<sp/>&apos;S&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&lt;<sp/>(num<sp/>-<sp/>1)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_RETURN:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>sel_cmd;
<sp/><sp/><sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


void<sp/>tetris::update_menu(HWND<sp/>hwnd){
<sp/><sp/><sp/><sp/>RECT<sp/>rc<sp/>=<sp/>{<sp/>offset_m,<sp/>240,<sp/>offset_m<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>2<sp/>};
<sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


void<sp/>tetris::set_state(HWND<sp/>hwnd,<sp/>e_state_game<sp/>st){
<sp/><sp/><sp/>sel_cmd<sp/>=<sp/>0;
<sp/><sp/><sp/>state<sp/><sp/><sp/>=<sp/>st;
<sp/><sp/>InvalidateRect(hwnd,<sp/>NULL,<sp/>TRUE);
}


int<sp/>tetris::move_button(int<sp/>x,<sp/>int<sp/>y,<sp/>int<sp/>num){
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>i*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>OffsetRect(&amp;rc,<sp/>offset_m,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/>if((x<sp/>&gt;<sp/>rc.left<sp/>&amp;&amp;<sp/>x<sp/>&lt;<sp/>rc.right)<sp/>&amp;&amp;<sp/>(y<sp/>&gt;<sp/>rc.top<sp/>&amp;&amp;<sp/>y<sp/>&lt;<sp/>rc.bottom))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>i;
<sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


//обработчик<sp/>диалога
static<sp/>LRESULT<sp/>CALLBACK<sp/>options_proc(HWND<sp/>hwnd,<sp/>UINT<sp/>msg,<sp/>WPARAM<sp/>wParam,<sp/>LPARAM<sp/>lParam){
<sp/><sp/><sp/><sp/>const<sp/>WCHAR<sp/>vel1[]<sp/>=<sp/>{<sp/>0x41F,0x435,0x440,0x432,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel2[]<sp/>=<sp/>{<sp/>0x412,0x442,0x43E,0x440,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel3[]<sp/>=<sp/>{<sp/>0x422,0x440,0x435,0x442,0x44C,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};

<sp/>switch(msg){
<sp/><sp/><sp/>case<sp/>WM_INITDIALOG:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel1);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel2);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel3);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_SETCURSEL,<sp/>(WPARAM)(g_velocity<sp/>-<sp/>1),<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_SETCHECK,<sp/>(g_audio)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_SETCHECK,<sp/>(!g_repeat)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/>return<sp/>1;
<sp/><sp/>case<sp/>WM_COMMAND:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch(LOWORD(wParam)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_OK:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_velocity<sp/>=<sp/>(int)SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_GETCURSEL,<sp/>0,<sp/>0)<sp/>+<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_audio<sp/><sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/><sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>TRUE<sp/><sp/>:<sp/>FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_repeat<sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>FALSE<sp/>:<sp/>TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_CANCEL:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>WM_CLOSE:
<sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
<sp/><sp/>return<sp/>0;
}
</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendMessage(hwnd,<sp/>WM_CLOSE,<sp/>0,<sp/>0);</highlight></codeline>
<codeline lineno="574"><highlight class="normal">}</highlight></codeline>
<codeline lineno="575"><highlight class="normal"></highlight></codeline>
<codeline lineno="576"><highlight class="normal"></highlight></codeline>
<codeline lineno="577"><highlight class="normal"></highlight><highlight class="comment">//перерисовка фигуры</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="578"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ARGS2_FASTCALL<sp/>tetris::update_figure(<ref refid="main_8cpp_1a74aea08afaa7f26d272e9352ddafda3d" kindref="member">HWND</ref><sp/>hwnd){</highlight></codeline>
<codeline lineno="579"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>m<sp/>=<sp/>CELL_SIZE<sp/>&lt;&lt;<sp/>1;</highlight></codeline>
<codeline lineno="580"><highlight class="normal"><sp/><sp/><sp/><sp/>RECT<sp/>rc;</highlight></codeline>
<codeline lineno="581"><highlight class="normal"><sp/><sp/><sp/><sp/>rc.left<sp/><sp/><sp/>=<sp/>figure_x<sp/>*<sp/>CELL_SIZE<sp/>-<sp/>CELL_SIZE;</highlight></codeline>
<codeline lineno="582"><highlight class="normal"><sp/><sp/><sp/><sp/>rc.top<sp/><sp/><sp/><sp/>=<sp/>figure_y<sp/>-<sp/>CELL_SIZE;</highlight></codeline>
<codeline lineno="583"><highlight class="normal"><sp/><sp/><sp/><sp/>rc.right<sp/><sp/>=<sp/>min(rc.left<sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>(m<sp/>&lt;&lt;<sp/>1),<sp/>field_right);<sp/></highlight></codeline>
<codeline lineno="584"><highlight class="normal"><sp/><sp/><sp/><sp/>rc.bottom<sp/>=<sp/>rc.top<sp/><sp/>+<sp/>OBJ_LENGTH<sp/>+<sp/>m;</highlight></codeline>
<codeline lineno="585"><highlight class="normal"><sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);</highlight></codeline>
<codeline lineno="586"><highlight class="normal">}</highlight></codeline>
<codeline lineno="587"><highlight class="normal"></highlight></codeline>
<codeline lineno="588"><highlight class="normal"></highlight></codeline>
<codeline lineno="589"><highlight class="normal"></highlight><highlight class="comment">//добавление<sp/>очков void<sp/>tetris::score_add(int<sp/>n){
<sp/><sp/>if(n<sp/>&gt;<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/>score<sp/>+=<sp/>(n<sp/>==<sp/>1)<sp/>?<sp/>10UL<sp/>:<sp/>static_cast&lt;DWORD&gt;(n)*15UL;
}


//проверка<sp/>на<sp/>проигрыш
bool<sp/>tetris::is_game_over(void){
<sp/><sp/>int<sp/>j<sp/>=<sp/>0;
<sp/>while((j<sp/>&lt;<sp/>FIELD_COLS)<sp/>&amp;&amp;<sp/>(field[0][j]<sp/>==<sp/>BLOCK_NONE))
<sp/><sp/><sp/><sp/><sp/>++j;
<sp/><sp/><sp/>return<sp/>(j<sp/>&lt;<sp/>FIELD_COLS);
}


//вывод кнопок
void<sp/>tetris::draw_buttons(HDC<sp/>hDC,<sp/>int<sp/>num,...){
<sp/>const<sp/>BYTE*<sp/>pb;
<sp/><sp/><sp/><sp/>UINT<sp/><sp/><sp/><sp/>nb;
<sp/><sp/><sp/><sp/>int<sp/><sp/><sp/><sp/><sp/>x,<sp/>p<sp/>=<sp/>0;
<sp/><sp/>RECT<sp/><sp/><sp/><sp/>rc;
<sp/><sp/><sp/><sp/>va_list<sp/>lst;
<sp/><sp/><sp/>va_start(lst,<sp/>num);
<sp/><sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>i<sp/>+=<sp/>2,<sp/>++p){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>p*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>pb<sp/>=<sp/>va_arg(lst,<sp/>const<sp/>BYTE*);
<sp/><sp/><sp/><sp/><sp/>nb<sp/>=<sp/>va_arg(lst,<sp/>UINT);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/><sp/>=<sp/>(p<sp/>==<sp/>sel_cmd)<sp/>?<sp/>89<sp/>:<sp/>21;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>rc.left,<sp/>rc.top,<sp/>rc.right<sp/>-<sp/>rc.left,<sp/>rc.bottom<sp/>-<sp/>rc.top,<sp/>x,<sp/>184,<sp/>69,<sp/>33,<sp/>SRCCOPY);

<sp/><sp/><sp/><sp/><sp/><sp/>fnt.draw(hDC,<sp/>pb,<sp/>nb,<sp/>rc.left<sp/>+<sp/>((rc.right<sp/>-<sp/>rc.left)<sp/>-<sp/>static_cast&lt;int&gt;(nb)*fnt.getWidth())/2,<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rc.top<sp/>+<sp/>((rc.bottom<sp/>-<sp/>rc.top)<sp/>-<sp/>fnt.getHeight())/2);
<sp/>}
<sp/><sp/>va_end(lst);
}


void<sp/>ARGS2_FASTCALL<sp/>tetris::set_rect(LPRECT<sp/>prc,<sp/>int<sp/>top){
<sp/><sp/><sp/><sp/>SetRect(prc,<sp/>20,<sp/>250<sp/>+<sp/>top,<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20,<sp/>300<sp/>+<sp/>top);
}


int<sp/>tetris::control_menu(HWND<sp/>hwnd,<sp/>WORD<sp/>key,<sp/>int<sp/>num){
<sp/><sp/><sp/><sp/>switch(key){
<sp/><sp/><sp/>case<sp/>VK_UP:
<sp/><sp/><sp/><sp/>case<sp/>&apos;W&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&gt;<sp/>0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_DOWN:
<sp/><sp/>case<sp/>&apos;S&apos;:
<sp/><sp/><sp/><sp/><sp/><sp/>if(sel_cmd<sp/>&lt;<sp/>(num<sp/>-<sp/>1)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++sel_cmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>VK_RETURN:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>sel_cmd;
<sp/><sp/><sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


void<sp/>tetris::update_menu(HWND<sp/>hwnd){
<sp/><sp/><sp/><sp/>RECT<sp/>rc<sp/>=<sp/>{<sp/>offset_m,<sp/>240,<sp/>offset_m<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>2<sp/>};
<sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);
}


void<sp/>tetris::set_state(HWND<sp/>hwnd,<sp/>e_state_game<sp/>st){
<sp/><sp/><sp/>sel_cmd<sp/>=<sp/>0;
<sp/><sp/><sp/>state<sp/><sp/><sp/>=<sp/>st;
<sp/><sp/>InvalidateRect(hwnd,<sp/>NULL,<sp/>TRUE);
}


int<sp/>tetris::move_button(int<sp/>x,<sp/>int<sp/>y,<sp/>int<sp/>num){
<sp/><sp/>RECT<sp/>rc;
<sp/><sp/><sp/>for(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>i*80);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>OffsetRect(&amp;rc,<sp/>offset_m,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/>if((x<sp/>&gt;<sp/>rc.left<sp/>&amp;&amp;<sp/>x<sp/>&lt;<sp/>rc.right)<sp/>&amp;&amp;<sp/>(y<sp/>&gt;<sp/>rc.top<sp/>&amp;&amp;<sp/>y<sp/>&lt;<sp/>rc.bottom))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>i;
<sp/><sp/>}
<sp/><sp/>return<sp/>-1;
}


//обработчик<sp/>диалога
static<sp/>LRESULT<sp/>CALLBACK<sp/>options_proc(HWND<sp/>hwnd,<sp/>UINT<sp/>msg,<sp/>WPARAM<sp/>wParam,<sp/>LPARAM<sp/>lParam){
<sp/><sp/><sp/><sp/>const<sp/>WCHAR<sp/>vel1[]<sp/>=<sp/>{<sp/>0x41F,0x435,0x440,0x432,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel2[]<sp/>=<sp/>{<sp/>0x412,0x442,0x43E,0x440,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel3[]<sp/>=<sp/>{<sp/>0x422,0x440,0x435,0x442,0x44C,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};

<sp/>switch(msg){
<sp/><sp/><sp/>case<sp/>WM_INITDIALOG:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel1);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel2);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel3);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_SETCURSEL,<sp/>(WPARAM)(g_velocity<sp/>-<sp/>1),<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_SETCHECK,<sp/>(g_audio)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_SETCHECK,<sp/>(!g_repeat)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/>return<sp/>1;
<sp/><sp/>case<sp/>WM_COMMAND:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch(LOWORD(wParam)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_OK:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_velocity<sp/>=<sp/>(int)SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_GETCURSEL,<sp/>0,<sp/>0)<sp/>+<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_audio<sp/><sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/><sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>TRUE<sp/><sp/>:<sp/>FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_repeat<sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>FALSE<sp/>:<sp/>TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_CANCEL:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>WM_CLOSE:
<sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
<sp/><sp/>return<sp/>0;
}
</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="590"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>tetris::score_add(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>n){</highlight></codeline>
<codeline lineno="591"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(n<sp/>&gt;<sp/>0)</highlight></codeline>
<codeline lineno="592"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>score<sp/>+=<sp/>(n<sp/>==<sp/>1)<sp/>?<sp/>10UL<sp/>:<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="normal">DWORD</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(n)*15UL;</highlight></codeline>
<codeline lineno="593"><highlight class="normal">}</highlight></codeline>
<codeline lineno="594"><highlight class="normal"></highlight></codeline>
<codeline lineno="595"><highlight class="normal"></highlight></codeline>
<codeline lineno="596"><highlight class="normal"></highlight><highlight class="comment">//проверка<sp/>на<sp/>проигрыш</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="597"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>tetris::is_game_over(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal">){</highlight></codeline>
<codeline lineno="598"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>j<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="599"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal">((j<sp/>&lt;<sp/>FIELD_COLS)<sp/>&amp;&amp;<sp/>(field[0][j]<sp/>==<sp/>BLOCK_NONE))</highlight></codeline>
<codeline lineno="600"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++j;</highlight></codeline>
<codeline lineno="601"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(j<sp/>&lt;<sp/>FIELD_COLS);</highlight></codeline>
<codeline lineno="602"><highlight class="normal">}</highlight></codeline>
<codeline lineno="603"><highlight class="normal"></highlight></codeline>
<codeline lineno="604"><highlight class="normal"></highlight></codeline>
<codeline lineno="605"><highlight class="normal"></highlight><highlight class="comment">//вывод кнопок</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="606"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>tetris::draw_buttons(<ref refid="main_8cpp_1a296475d8e990aad6b442b8b669315f5e" kindref="member">HDC</ref><sp/>hDC,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>num,...){</highlight></codeline>
<codeline lineno="607"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BYTE*<sp/>pb;</highlight></codeline>
<codeline lineno="608"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="main_8cpp_1afff0ab3629a68bc1bb3b2a2f4296173f" kindref="member">UINT</ref><sp/><sp/><sp/><sp/>nb;</highlight></codeline>
<codeline lineno="609"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><sp/><sp/><sp/><sp/>x,<sp/>p<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="610"><highlight class="normal"><sp/><sp/><sp/><sp/>RECT<sp/><sp/><sp/><sp/>rc;</highlight></codeline>
<codeline lineno="611"><highlight class="normal"><sp/><sp/><sp/><sp/>va_list<sp/>lst;</highlight></codeline>
<codeline lineno="612"><highlight class="normal"><sp/><sp/><sp/><sp/>va_start(lst,<sp/>num);</highlight></codeline>
<codeline lineno="613"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>i<sp/>+=<sp/>2,<sp/>++p){</highlight></codeline>
<codeline lineno="614"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>p*80);</highlight></codeline>
<codeline lineno="615"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pb<sp/>=<sp/>va_arg(lst,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BYTE*);</highlight></codeline>
<codeline lineno="616"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nb<sp/>=<sp/>va_arg(lst,<sp/><ref refid="main_8cpp_1afff0ab3629a68bc1bb3b2a2f4296173f" kindref="member">UINT</ref>);</highlight></codeline>
<codeline lineno="617"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/><sp/>=<sp/>(p<sp/>==<sp/>sel_cmd)<sp/>?<sp/>89<sp/>:<sp/>21;</highlight></codeline>
<codeline lineno="618"><highlight class="normal"></highlight></codeline>
<codeline lineno="619"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bother-&gt;draw(hDC,<sp/>rc.left,<sp/>rc.top,<sp/>rc.right<sp/>-<sp/>rc.left,<sp/>rc.bottom<sp/>-<sp/>rc.top,<sp/>x,<sp/>184,<sp/>69,<sp/>33,<sp/>SRCCOPY);</highlight></codeline>
<codeline lineno="620"><highlight class="normal"></highlight></codeline>
<codeline lineno="621"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fnt.draw(hDC,<sp/>pb,<sp/>nb,<sp/>rc.left<sp/>+<sp/>((rc.right<sp/>-<sp/>rc.left)<sp/>-<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">int</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(nb)*fnt.getWidth())/2,<sp/></highlight></codeline>
<codeline lineno="622"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rc.top<sp/>+<sp/>((rc.bottom<sp/>-<sp/>rc.top)<sp/>-<sp/>fnt.getHeight())/2);</highlight></codeline>
<codeline lineno="623"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="624"><highlight class="normal"><sp/><sp/><sp/><sp/>va_end(lst);</highlight></codeline>
<codeline lineno="625"><highlight class="normal">}</highlight></codeline>
<codeline lineno="626"><highlight class="normal"></highlight></codeline>
<codeline lineno="627"><highlight class="normal"></highlight></codeline>
<codeline lineno="628"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ARGS2_FASTCALL<sp/>tetris::set_rect(LPRECT<sp/>prc,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>top){</highlight></codeline>
<codeline lineno="629"><highlight class="normal"><sp/><sp/><sp/><sp/>SetRect(prc,<sp/>20,<sp/>250<sp/>+<sp/>top,<sp/>dcbmp-&gt;getWidth()<sp/>-<sp/>20,<sp/>300<sp/>+<sp/>top);</highlight></codeline>
<codeline lineno="630"><highlight class="normal">}</highlight></codeline>
<codeline lineno="631"><highlight class="normal"></highlight></codeline>
<codeline lineno="632"><highlight class="normal"></highlight></codeline>
<codeline lineno="633"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>tetris::control_menu(<ref refid="main_8cpp_1a74aea08afaa7f26d272e9352ddafda3d" kindref="member">HWND</ref><sp/>hwnd,<sp/><ref refid="main_8cpp_1a89b917a7bdb582e19cbde98e817fa0b3" kindref="member">WORD</ref><sp/>key,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>num){</highlight></codeline>
<codeline lineno="634"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal">(key){</highlight></codeline>
<codeline lineno="635"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>VK_UP:</highlight></codeline>
<codeline lineno="636"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/></highlight><highlight class="charliteral">&apos;W&apos;</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="637"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(sel_cmd<sp/>&gt;<sp/>0){</highlight></codeline>
<codeline lineno="638"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--sel_cmd;</highlight></codeline>
<codeline lineno="639"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);</highlight></codeline>
<codeline lineno="640"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="641"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="642"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>VK_DOWN:</highlight></codeline>
<codeline lineno="643"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/></highlight><highlight class="charliteral">&apos;S&apos;</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="644"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(sel_cmd<sp/>&lt;<sp/>(num<sp/>-<sp/>1)){</highlight></codeline>
<codeline lineno="645"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++sel_cmd;</highlight></codeline>
<codeline lineno="646"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_menu(hwnd);</highlight></codeline>
<codeline lineno="647"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="649"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>VK_RETURN:</highlight></codeline>
<codeline lineno="650"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>sel_cmd;</highlight></codeline>
<codeline lineno="651"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="652"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="653"><highlight class="normal">}</highlight></codeline>
<codeline lineno="654"><highlight class="normal"></highlight></codeline>
<codeline lineno="655"><highlight class="normal"></highlight></codeline>
<codeline lineno="656"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>tetris::update_menu(<ref refid="main_8cpp_1a74aea08afaa7f26d272e9352ddafda3d" kindref="member">HWND</ref><sp/>hwnd){</highlight></codeline>
<codeline lineno="657"><highlight class="normal"><sp/><sp/><sp/><sp/>RECT<sp/>rc<sp/>=<sp/>{<sp/>offset_m,<sp/>240,<sp/>offset_m<sp/>+<sp/>dcbmp-&gt;getWidth(),<sp/>size.cy<sp/>-<sp/>2<sp/>};</highlight></codeline>
<codeline lineno="658"><highlight class="normal"><sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>&amp;rc,<sp/>TRUE);</highlight></codeline>
<codeline lineno="659"><highlight class="normal">}</highlight></codeline>
<codeline lineno="660"><highlight class="normal"></highlight></codeline>
<codeline lineno="661"><highlight class="normal"></highlight></codeline>
<codeline lineno="662"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>tetris::set_state(<ref refid="main_8cpp_1a74aea08afaa7f26d272e9352ddafda3d" kindref="member">HWND</ref><sp/>hwnd,<sp/>e_state_game<sp/>st){</highlight></codeline>
<codeline lineno="663"><highlight class="normal"><sp/><sp/><sp/><sp/>sel_cmd<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="664"><highlight class="normal"><sp/><sp/><sp/><sp/>state<sp/><sp/><sp/>=<sp/>st;</highlight></codeline>
<codeline lineno="665"><highlight class="normal"><sp/><sp/><sp/><sp/>InvalidateRect(hwnd,<sp/>NULL,<sp/>TRUE);</highlight></codeline>
<codeline lineno="666"><highlight class="normal">}</highlight></codeline>
<codeline lineno="667"><highlight class="normal"></highlight></codeline>
<codeline lineno="668"><highlight class="normal"></highlight></codeline>
<codeline lineno="669"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>tetris::move_button(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>x,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>y,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>num){</highlight></codeline>
<codeline lineno="670"><highlight class="normal"><sp/><sp/><sp/><sp/>RECT<sp/>rc;</highlight></codeline>
<codeline lineno="671"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>num;<sp/>++i){</highlight></codeline>
<codeline lineno="672"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_rect(&amp;rc,<sp/>i*80);</highlight></codeline>
<codeline lineno="673"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OffsetRect(&amp;rc,<sp/>offset_m,<sp/>0);</highlight></codeline>
<codeline lineno="674"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">((x<sp/>&gt;<sp/>rc.left<sp/>&amp;&amp;<sp/>x<sp/>&lt;<sp/>rc.right)<sp/>&amp;&amp;<sp/>(y<sp/>&gt;<sp/>rc.top<sp/>&amp;&amp;<sp/>y<sp/>&lt;<sp/>rc.bottom))</highlight></codeline>
<codeline lineno="675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>i;</highlight></codeline>
<codeline lineno="676"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="677"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="678"><highlight class="normal">}</highlight></codeline>
<codeline lineno="679"><highlight class="normal"></highlight></codeline>
<codeline lineno="680"><highlight class="normal"></highlight></codeline>
<codeline lineno="681"><highlight class="normal"></highlight><highlight class="comment">//обработчик<sp/>диалога static<sp/>LRESULT<sp/>CALLBACK<sp/>options_proc(HWND<sp/>hwnd,<sp/>UINT<sp/>msg,<sp/>WPARAM<sp/>wParam,<sp/>LPARAM<sp/>lParam){
<sp/><sp/><sp/>const<sp/>WCHAR<sp/>vel1[]<sp/>=<sp/>{<sp/>0x41F,0x435,0x440,0x432,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel2[]<sp/>=<sp/>{<sp/>0x412,0x442,0x43E,0x440,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};
<sp/><sp/>const<sp/>WCHAR<sp/>vel3[]<sp/>=<sp/>{<sp/>0x422,0x440,0x435,0x442,0x44C,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};

<sp/>switch(msg){
<sp/><sp/><sp/>case<sp/>WM_INITDIALOG:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel1);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel2);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel3);
<sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_SETCURSEL,<sp/>(WPARAM)(g_velocity<sp/>-<sp/>1),<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_SETCHECK,<sp/>(g_audio)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_SETCHECK,<sp/>(!g_repeat)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);
<sp/><sp/><sp/><sp/><sp/>return<sp/>1;
<sp/><sp/>case<sp/>WM_COMMAND:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch(LOWORD(wParam)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_OK:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_velocity<sp/>=<sp/>(int)SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_GETCURSEL,<sp/>0,<sp/>0)<sp/>+<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_audio<sp/><sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/><sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>TRUE<sp/><sp/>:<sp/>FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_repeat<sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>FALSE<sp/>:<sp/>TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>case<sp/>IDC_BUTTON_CANCEL:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>case<sp/>WM_CLOSE:
<sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
<sp/><sp/>return<sp/>0;
}
</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="682"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>LRESULT<sp/>CALLBACK<sp/>options_proc(<ref refid="main_8cpp_1a74aea08afaa7f26d272e9352ddafda3d" kindref="member">HWND</ref><sp/>hwnd,<sp/><ref refid="main_8cpp_1afff0ab3629a68bc1bb3b2a2f4296173f" kindref="member">UINT</ref><sp/>msg,<sp/>WPARAM<sp/>wParam,<sp/>LPARAM<sp/>lParam){</highlight></codeline>
<codeline lineno="683"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>WCHAR<sp/>vel1[]<sp/>=<sp/>{<sp/>0x41F,0x435,0x440,0x432,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};</highlight></codeline>
<codeline lineno="684"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>WCHAR<sp/>vel2[]<sp/>=<sp/>{<sp/>0x412,0x442,0x43E,0x440,0x430,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};</highlight></codeline>
<codeline lineno="685"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>WCHAR<sp/>vel3[]<sp/>=<sp/>{<sp/>0x422,0x440,0x435,0x442,0x44C,0x44F,0x20,0x441,0x43A,0x43E,0x440,0x43E,0x441,0x442,0x44C,0x0};</highlight></codeline>
<codeline lineno="686"><highlight class="normal"></highlight></codeline>
<codeline lineno="687"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal">(msg){</highlight></codeline>
<codeline lineno="688"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>WM_INITDIALOG:</highlight></codeline>
<codeline lineno="689"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel1);</highlight></codeline>
<codeline lineno="690"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel2);</highlight></codeline>
<codeline lineno="691"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessageW(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_ADDSTRING,<sp/>0,<sp/>(LPARAM)vel3);</highlight></codeline>
<codeline lineno="692"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_SETCURSEL,<sp/>(WPARAM)(g_velocity<sp/>-<sp/>1),<sp/>0);</highlight></codeline>
<codeline lineno="693"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_SETCHECK,<sp/>(g_audio)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);</highlight></codeline>
<codeline lineno="694"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_SETCHECK,<sp/>(!g_repeat)<sp/>?<sp/>BST_CHECKED<sp/>:<sp/>BST_UNCHECKED,<sp/>0);</highlight></codeline>
<codeline lineno="695"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>1;</highlight></codeline>
<codeline lineno="696"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>WM_COMMAND:</highlight></codeline>
<codeline lineno="697"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal">(LOWORD(wParam)){</highlight></codeline>
<codeline lineno="698"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>IDC_BUTTON_OK:</highlight></codeline>
<codeline lineno="699"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_velocity<sp/>=<sp/>(int)SendDlgItemMessage(hwnd,<sp/>IDC_COMBO_VELOCITY,<sp/>CB_GETCURSEL,<sp/>0,<sp/>0)<sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="700"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_audio<sp/><sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_AUDIO,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/><sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>TRUE<sp/><sp/>:<sp/>FALSE;</highlight></codeline>
<codeline lineno="701"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>g_repeat<sp/><sp/><sp/>=<sp/>(SendDlgItemMessage(hwnd,<sp/>IDC_CHECK_REPEAT,<sp/>BM_GETCHECK,<sp/>0,<sp/>0)<sp/>==<sp/>BST_CHECKED)<sp/>?<sp/>FALSE<sp/>:<sp/>TRUE;</highlight></codeline>
<codeline lineno="702"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>1);</highlight></codeline>
<codeline lineno="703"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="704"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>IDC_BUTTON_CANCEL:</highlight></codeline>
<codeline lineno="705"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);</highlight></codeline>
<codeline lineno="706"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="707"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="708"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="709"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>WM_CLOSE:</highlight></codeline>
<codeline lineno="710"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EndDialog(hwnd,<sp/>0);</highlight></codeline>
<codeline lineno="711"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="712"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="713"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="714"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="game.cpp"/>
  </compounddef>
</doxygen>
